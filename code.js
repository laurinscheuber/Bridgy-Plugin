var BridgyPlugin=(()=>{var N={"gitlab.com":{gitlabBaseUrl:"https://gitlab.com",allowedDomains:["gitlab.com","*.gitlab.com","*.gitlab.io"],name:"GitLab.com",description:"Official GitLab SaaS platform",requiresCustomToken:!1},"gitlab.fhnw.ch":{gitlabBaseUrl:"https://gitlab.fhnw.ch",allowedDomains:["gitlab.fhnw.ch","*.gitlab.fhnw.ch"],name:"FHNW GitLab",description:"University of Applied Sciences Northwestern Switzerland",requiresCustomToken:!1},custom:{gitlabBaseUrl:"",allowedDomains:[],name:"Custom GitLab",description:"Self-hosted or enterprise GitLab instance",requiresCustomToken:!0}},K=class{static{this.CUSTOM_CONFIG_KEY="bridgy-custom-environments"}static getEnvironment(e){return N[e]||null}static getAllEnvironments(){return{...N}}static async saveCustomEnvironment(e,t){try{let r=await this.getCustomEnvironments();r[e]={...t,requiresCustomToken:!0},await figma.clientStorage.setAsync(this.CUSTOM_CONFIG_KEY,JSON.stringify(r))}catch(r){throw console.error("Failed to save custom environment:",r),r}}static async getCustomEnvironments(){try{let e=await figma.clientStorage.getAsync(this.CUSTOM_CONFIG_KEY);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to load custom environments:",e),{}}}static async getAllEnvironmentsWithCustom(){let e=await this.getCustomEnvironments();return{...N,...e}}static validateGitLabUrl(e){try{let t=new URL(e);if(t.protocol!=="https:")return{isValid:!1,error:"GitLab URL must use HTTPS"};let r=t.hostname;return!r||r.length<3?{isValid:!1,error:"Invalid domain"}:{isValid:!0,domain:r}}catch{return{isValid:!1,error:"Invalid URL format"}}}static autoConfigureFromUrl(e){let t=this.validateGitLabUrl(e);if(!t.isValid||!t.domain)return null;let r=t.domain;for(let n in N){let s=N[n];if(s.allowedDomains.some(i=>{if(i.startsWith("*.")){let o=i.substring(2);return r.endsWith(o)}return r===i}))return s}return{gitlabBaseUrl:e,allowedDomains:[r,`*.${r}`],name:`Custom (${r})`,description:`Self-hosted GitLab at ${r}`,requiresCustomToken:!0}}static async removeCustomEnvironment(e){try{let t=await this.getCustomEnvironments();delete t[e],await figma.clientStorage.setAsync(this.CUSTOM_CONFIG_KEY,JSON.stringify(t))}catch(t){throw console.error("Failed to remove custom environment:",t),t}}static async getEnvironmentForUrl(e){if(!e)return null;let t=this.autoConfigureFromUrl(e);if(t&&!t.requiresCustomToken)return t;let r=await this.getCustomEnvironments();for(let n in r){let s=r[n];if(s.gitlabBaseUrl===e)return s}return t}static generateManifestDomains(e){let t=e||N,r=new Set;r.add("https://cdnjs.cloudflare.com");for(let n in t){let s=t[n];if(s.gitlabBaseUrl)try{let i=new URL(s.gitlabBaseUrl);r.add(`https://${i.hostname}`)}catch{}s.allowedDomains.forEach(i=>{i.startsWith("*.")?r.add(`https://${i}`):r.add(`https://${i}`)})}return Array.from(r).sort()}};var V={DEFAULT_GITLAB_URL:"https://gitlab.com",DEFAULT_GITLAB_BASE_URL:"https://gitlab.com/api/v4",REQUEST_TIMEOUT:3e4,DEFAULT_HEADERS:{"Content-Type":"application/json",Accept:"application/json"}};var ee=a=>{if(!a)return V.DEFAULT_GITLAB_BASE_URL;let e=a.replace(/\/+$/,"");return e.endsWith("/api/v4")?e:`${e}/api/v4`};var te=a=>a?a.replace(/\/+$/,"").replace(/\/api\/v4$/,""):V.DEFAULT_GITLAB_URL,J={DEFAULT_BRANCH:"feature/variables",DEFAULT_TEST_BRANCH:"feature/component-tests",DEFAULT_COMMIT_PATTERNS:{variables:"Update CSS variables from Figma",tests:"Add component test for {componentName}"}};var C={AVAILABLE:["px","rem","em","%","vw","vh","vmin","vmax","pt","pc","in","cm","mm","ex","ch","fr","none"],DEFAULT:"px",UNITLESS_PATTERNS:["opacity","z-index","line-height","font-weight","flex","order","flex-grow","flexgrow","flex-shrink","flexshrink","grid-column","gridcolumn","grid-row","gridrow","grid-area","gridarea","column-count","columncount","animation-iteration-count","animationiterationcount","scale","rotate","aspect-ratio","aspectratio","tab-size","tabsize","zoom","counter-reset","counterreset"],TYPOGRAPHY_PATTERNS:["font-size","fontsize","size","text","letter-spacing","letterspacing","word-spacing","wordspacing","text-indent","textindent"],RELATIVE_PATTERNS:["width","height","top","right","bottom","left","inset"],VIEWPORT_PATTERNS:["viewport","screen","full-width","fullwidth","full-height","fullheight","container-width","containerwidth","breakpoint"],BORDER_RADIUS_PATTERNS:["radius","rounded","corner","border-radius","borderradius"],SPACING_PATTERNS:["margin","padding","gap","space","spacing","gutter","offset","indent"]},P={SIMPLE_COLORS:["accentColor","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","borderBlockStartColor","borderBlockEndColor","borderInlineStartColor","borderInlineEndColor","caretColor","color","columnRuleColor","fill","floodColor","lightingColor","outlineColor","scrollbarColor","stopColor","stroke","textDecorationColor","textEmphasisColor","textShadowColor","webkitTapHighlightColor","webkitTextFillColor","webkitTextStrokeColor"],COMPLEX_COLORS:["background","border","borderTop","borderRight","borderBottom","borderLeft","outline","boxShadow","textShadow","filter"],LAYOUT:["justifyContent","alignItems","display","flexDirection","position"],INTERACTIVE:["background-color","backgroundColor","color","border-color","borderColor","box-shadow","boxShadow","opacity","transform","filter","outline","text-decoration-color","textDecorationColor","border-width","borderWidth","padding","margin","font-weight","fontWeight","letter-spacing","letterSpacing","text-shadow","textShadow","border-radius","borderRadius","outline-color","outlineColor","outline-width","outlineWidth","outline-style","outlineStyle","cursor","transition","animation"],STATIC:["width","height","min-width","minWidth","min-height","minHeight","max-width","maxWidth","max-height","maxHeight","font-family","fontFamily","font-size","fontSize","line-height","lineHeight","text-align","textAlign","vertical-align","verticalAlign","white-space","whiteSpace","word-wrap","wordWrap","word-break","wordBreak","overflow","overflow-x","overflowX","overflow-y","overflowY","z-index","zIndex","flex-grow","flexGrow","flex-shrink","flexShrink","flex-basis","flexBasis","order","grid-column","gridColumn","grid-row","gridRow","grid-area","gridArea"]};var re={STATE_SPECIFIC_PROPERTIES:{hover:["background-color","backgroundColor","color","border-color","borderColor","box-shadow","boxShadow","opacity","transform"],active:["background-color","backgroundColor","color","border-color","borderColor","box-shadow","boxShadow","transform"],focus:["outline","outline-color","outlineColor","outline-width","outlineWidth","outline-style","outlineStyle","box-shadow","boxShadow"],disabled:["opacity","cursor","background-color","backgroundColor","color","border-color","borderColor"]}},D={HEX_COLOR:{SHORT:/^#[0-9A-Fa-f]{3}$/,LONG:/^#[0-9A-Fa-f]{6}$/,BOTH:/^#[0-9A-Fa-f]{3}$|^#[0-9A-Fa-f]{6}$/,INLINE:/#[0-9A-Fa-f]{3,6}(?![0-9A-Fa-f])/g},CSS_VARIABLE:{FALLBACK:/var\([^,]+,\s*([^)]+)\)/g,REFERENCE:/var\((--.+?)\)/,STRIP_FALLBACK:/var\([^,]+,\s*([^\)]+)\)/g},COMPONENT_NAME:{STATE:/State=([^,]+)/i,VARIANT:/Variant=([^,]+)/i,PROPERTY:/Property\s*\d*\s*=\s*([^,]+)/i,TYPE:/Type=([^,]+)/i},CAMEL_TO_KEBAB:/([A-Z])/g,KEBAB_TO_CAMEL:/-([a-z])/g,COMPONENT_SANITIZE:/[^a-z0-9]+/g,WHITESPACE_NORMALIZE:/\s+/g};var B={INVALID_SETTINGS:"Invalid settings provided",MISSING_COMPONENT:"Component with ID {id} not found",MISSING_FIELDS:"Missing required fields for {action}",GITLAB_AUTH:"GitLab authentication failed",GITLAB_AUTH_TOKEN:"GitLab token is required",GITLAB_PROJECT_NOT_FOUND:"Resource not found while trying to {operation}. Please check your project ID.",GITLAB_INVALID_DATA:"Invalid data provided while trying to {operation}. Please check your inputs.",GITLAB_RATE_LIMIT:"Rate limit exceeded while trying to {operation}. Please try again later.",GITLAB_SERVER_ERROR:"GitLab server error while trying to {operation}. Please try again later.",GITLAB_BRANCH_EXISTS:"Branch already exists",NETWORK_ERROR:"Network error while communicating with GitLab",NETWORK_FETCH:"Network error - unable to connect to GitLab API",PARSE_ERROR:"Error parsing {type}: {error}",PARSE_SETTINGS:"Error parsing document settings",PARSE_METADATA:"Error parsing settings metadata",COMPONENT_NAME_REQUIRED:"Component name is required",COMPONENT_CONTENT_REQUIRED:"Test content is required",PROJECT_ID_REQUIRED:"Project ID is required",COMMIT_MESSAGE_REQUIRED:"Commit message is required",FILE_PATH_REQUIRED:"File path is required",CSS_DATA_REQUIRED:"CSS data is required",FILE_NOT_FOUND:"File not found at path: {path}",SAVE_SETTINGS_ERROR:"Error saving GitLab settings: {error}",RESET_SETTINGS_ERROR:"Error resetting GitLab settings: {error}",SAVE_UNIT_SETTINGS_ERROR:"Error saving unit settings",LOAD_UNIT_SETTINGS_ERROR:"Error loading unit settings",RESET_UNIT_SETTINGS_ERROR:"Error resetting unit settings",UNKNOWN_ERROR:"Unknown error",OPERATION_FAILED:"Failed to {operation}: {error}"},Z={COMMIT_SUCCESS:"Design tokens successfully committed! Your CSS variables are now ready for development.",TEST_COMMIT_SUCCESS:"Component test successfully committed! The generated test is ready for your review.",SETTINGS_SAVED:"GitLab settings saved and ready to use!",EXPORT_COMPLETE:"Files exported successfully! You can now use them in your project.",BRANCH_CREATED:"Feature branch created! Your changes are isolated and ready for review.",MERGE_REQUEST_CREATED:"Merge request created! Your team can now review and merge the changes.",UNIT_SETTINGS_SAVED:"CSS unit preferences saved and applied to all exports!",UNIT_SETTINGS_RESET:"Unit settings reset to smart defaults!"};var ne=(n=>(n[n.DEBUG=0]="DEBUG",n[n.INFO=1]="INFO",n[n.WARN=2]="WARN",n[n.ERROR=3]="ERROR",n))(ne||{}),S=class{static{this.currentLevel=1}static{this.logs=[]}static{this.maxLogs=1e3}static{this.CATEGORIES={COMPONENT:"Component",GITLAB:"GitLab",CSS_EXPORT:"CSS Export",UNITS:"Units",UI:"UI",CORE:"Core",TESTING:"Testing"}}static setLogLevel(e){this.currentLevel=e}static getLogLevel(){return this.currentLevel}static shouldLog(e){return e>=this.currentLevel}static addLogEntry(e,t,r,n){let s={level:e,message:t,data:r,timestamp:new Date,category:n};this.logs.push(s),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs))}static debug(e,t,r){this.shouldLog(0)&&(this.addLogEntry(0,e,t,r),console.debug(`[DEBUG]${r?` [${r}]`:""} ${e}`,t||""))}static info(e,t,r){this.shouldLog(1)&&(this.addLogEntry(1,e,t,r),console.info(`[INFO]${r?` [${r}]`:""} ${e}`,t||""))}static warn(e,t,r){this.shouldLog(2)&&(this.addLogEntry(2,e,t,r),console.warn(`[WARN]${r?` [${r}]`:""} ${e}`,t||""))}static error(e,t,r){this.shouldLog(3)&&(this.addLogEntry(3,e,t,r),console.error(`[ERROR]${r?` [${r}]`:""} ${e}`,t||""))}static getLogs(){return[...this.logs]}static getLogsByLevel(e){return this.logs.filter(t=>t.level===e)}static getLogsByCategory(e){return this.logs.filter(t=>t.category===e)}static clearLogs(){this.logs=[]}static getLogsSummary(){let e={debug:0,info:0,warn:0,error:0};return this.logs.forEach(t=>{switch(t.level){case 0:e.debug++;break;case 1:e.info++;break;case 2:e.warn++;break;case 3:e.error++;break}}),e}static exportLogs(){return JSON.stringify(this.logs,null,2)}static formatLogEntry(e){let t=e.timestamp.toISOString(),r=ne[e.level],n=e.category?` [${e.category}]`:"",s=e.data?` | ${JSON.stringify(e.data)}`:"";return`${t} [${r}]${n} ${e.message}${s}`}static time(e,t){let r=performance.now();return this.debug(`Timer started: ${e}`,void 0,t),()=>{let n=performance.now()-r;this.debug(`Timer finished: ${e} (${n.toFixed(2)}ms)`,{duration:n},t)}}static withTiming(e,t,r){let n=this.time(t,r);try{let s=e();return n(),s}catch(s){throw n(),this.error(`Error in ${t}:`,s,r),s}}static async withTimingAsync(e,t,r){let n=this.time(t,r);try{let s=await e();return n(),s}catch(s){throw n(),this.error(`Error in ${t}:`,s,r),s}}};var O=class{static sanitizeHTML(e){if(typeof e!="string")return"";let t=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/on\w+\s*=\s*["'][^"']*["']/gi,"").replace(/on\w+\s*=\s*[^>\s]+/gi,"").replace(/javascript:/gi,"").replace(/vbscript:/gi,"").replace(/data:/gi,""),r=["p","br","strong","em","b","i","u","span","div","h1","h2","h3","h4","h5","h6","ul","ol","li","code","pre","blockquote","select","option","button","svg","path","circle"];return t=t.replace(/<\/?([a-zA-Z][a-zA-Z0-9]*)[^>]*>/g,(n,s)=>{let i=s.toLowerCase();return r.indexOf(i)!==-1?n:""}),t}static createSafeElement(e,t,r){let n=this.escapeHTML(t),s=r?` class="${this.escapeHTML(r)}"`:"";return`<${e}${s}>${n}</${e}>`}static escapeHTML(e){if(typeof e!="string")return"";let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/g,r=>t[r])}static sanitizeInput(e,t=1e3){if(typeof e!="string")return"";let r=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/\s+/g," ").trim();return r.length>t&&(r=r.substring(0,t)),r}static isValidGitLabURL(e){if(typeof e!="string")return!1;try{let t=new URL(e);return t.protocol!=="https:"?!1:[/^gitlab\.com$/,/^.*\.gitlab\.com$/,/^.*\.gitlab\.io$/,/gitlab/i].some(n=>n.test(t.hostname))}catch{return!1}}static{this.rateLimitCache=new Map}static checkRateLimit(e,t=10,r=6e4){let n=Date.now(),s=n-r,i=this.rateLimitCache.get(e);return!i||i.resetTime<s?(this.rateLimitCache.set(e,{count:1,resetTime:n}),!0):i.count>=t?!1:(i.count++,!0)}static encryptData(e,t){if(typeof e!="string"||typeof t!="string")throw new Error("Data and key must be strings");let r=new TextEncoder().encode(t),n=new TextEncoder().encode(e),s=new Uint8Array(n.length);for(let i=0;i<n.length;i++)s[i]=n[i]^r[i%r.length];return btoa(String.fromCharCode(...s))}static decryptData(e,t){if(typeof e!="string"||typeof t!="string")throw new Error("Encrypted data and key must be strings");try{let r=new Uint8Array(atob(e).split("").map(i=>i.charCodeAt(0))),n=new TextEncoder().encode(t),s=new Uint8Array(r.length);for(let i=0;i<r.length;i++)s[i]=r[i]^n[i%n.length];return new TextDecoder().decode(s)}catch{throw new Error("Failed to decrypt data - invalid format or key")}}static generateEncryptionKey(){let e=globalThis.figma?.root?.id||"default",t=Math.random().toString(36).substring(2,15),r=Math.floor(Date.now()/(1e3*60*60*24));return btoa(`${e}:${t}:${r}`).slice(0,32)}};var m=class{static{this.errorLog=[]}static{this.MAX_ERROR_LOG_SIZE=100}static handleError(e,t){let r={operation:t.operation||"unknown",component:t.component||"unknown",timestamp:new Date().toISOString(),severity:t.severity||"medium"};switch(this.errorLog.push({error:e,context:r}),this.errorLog.length>this.MAX_ERROR_LOG_SIZE&&this.errorLog.shift(),r.severity){case"critical":console.error("CRITICAL ERROR:",e.message,r);break;case"high":console.error("HIGH SEVERITY:",e.message,r);break;case"medium":console.warn("MEDIUM SEVERITY:",e.message,r);break;case"low":console.log("LOW SEVERITY:",e.message,r);break}}static getUserFriendlyMessage(e,t){let r=e.message.toLowerCase();return r.includes("network")||r.includes("fetch")?"Unable to connect to GitLab. Please check your internet connection and GitLab server status.":r.includes("unauthorized")||r.includes("401")||r.includes("403")?"Authentication failed. Please check your GitLab token and permissions in Settings.":r.includes("invalid")||r.includes("validation")?`Invalid input: ${e.message}`:r.includes("rate limit")||r.includes("429")?"Too many requests. Please wait a moment and try again.":t.includes("export")||t.includes("generate")?`Failed to ${t}. Please try again or contact support if the issue persists.`:`An error occurred during ${t}. Please try again.`}static async withErrorHandling(e,t){try{return await e()}catch(r){throw this.handleError(r,t),r}}static sanitizeErrorForUI(e){let t=this.getUserFriendlyMessage(e,"operation");return t=t.replace(/token[=:]\s*[a-zA-Z0-9_-]+/gi,"token=***").replace(/password[=:]\s*[^\s]+/gi,"password=***").replace(/key[=:]\s*[a-zA-Z0-9_-]+/gi,"key=***"),{message:t,type:e.name||"Error"}}static getErrorStats(){let e=this.errorLog.reduce((r,{context:n})=>(r[n.severity]=(r[n.severity]||0)+1,r),{}),t=this.errorLog.slice(-10).map(({context:r})=>({operation:r.operation,timestamp:r.timestamp,severity:r.severity}));return{total:this.errorLog.length,bySeverity:e,recent:t}}static clearErrorLog(){this.errorLog=[]}static showUserError(e,t){let r=this.getUserFriendlyMessage(e,t);if(typeof figma<"u"&&figma.ui)try{figma.ui.postMessage({type:"show-error",title:"Operation Failed",message:r,operation:t})}catch(n){console.error("Failed to show UI error:",n)}this.handleError(e,{operation:t,component:"UI",severity:"high"})}static showUserSuccess(e,t){if(typeof figma<"u"&&figma.ui)try{figma.ui.postMessage({type:"show-success",title:"Success",message:e,operation:t})}catch(r){console.error("Failed to show UI success:",r)}}static async withErrorHandlingAndUI(e,t,r=!0){try{let n=await e();return r&&t.operation&&this.showUserSuccess(`${t.operation} completed successfully`,t.operation),n}catch(n){throw this.handleError(n,t),r&&t.operation&&this.showUserError(n,t.operation),n}}static validateInput(e,t,r){if(r.required&&(e==null||e===""))return{isValid:!1,error:`${t} is required`};if(e==null||e==="")return{isValid:!0};let n=String(e);if(r.minLength&&n.length<r.minLength)return{isValid:!1,error:`${t} must be at least ${r.minLength} characters`};if(r.maxLength&&n.length>r.maxLength)return{isValid:!1,error:`${t} must be no more than ${r.maxLength} characters`};if(r.pattern&&!r.pattern.test(n))return{isValid:!1,error:`${t} format is invalid`};if(r.type)switch(r.type){case"number":if(isNaN(Number(e)))return{isValid:!1,error:`${t} must be a valid number`};break;case"email":if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))return{isValid:!1,error:`${t} must be a valid email address`};break;case"url":try{new URL(n)}catch{return{isValid:!1,error:`${t} must be a valid URL`}}break}return{isValid:!0}}};var I=class{static{this.ITERATIONS=1e5}static{this.KEY_LENGTH=256}static{this.TAG_LENGTH=128}static{this.SALT_LENGTH=16}static{this.IV_LENGTH=12}static async deriveKey(e,t){try{let r=new TextEncoder,n=await crypto.subtle.importKey("raw",r.encode(e),"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:this.ITERATIONS,hash:"SHA-256"},n,{name:"AES-GCM",length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}catch(r){throw m.handleError(r,{operation:"derive_key",component:"CryptoService",severity:"high"}),r}}static getFileKey(){let e=figma.currentUser?.id||"anonymous",t=figma.root.id;return`${e}-${t}`}static async encrypt(e){try{let t=crypto.getRandomValues(new Uint8Array(this.SALT_LENGTH)),r=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),n=await this.deriveKey(this.getFileKey(),new Uint8Array(t)),s=new TextEncoder,i=await crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:this.TAG_LENGTH},n,s.encode(e)),o={ciphertext:this.bufferToBase64(i),iv:this.bufferToBase64(r),salt:this.bufferToBase64(t)};return JSON.stringify(o)}catch(t){throw m.handleError(t,{operation:"encrypt",component:"CryptoService",severity:"high"}),t}}static async decrypt(e){try{let t=JSON.parse(e),r=this.base64ToBuffer(t.salt),n=this.base64ToBuffer(t.iv),s=this.base64ToBuffer(t.ciphertext),i=await this.deriveKey(this.getFileKey(),new Uint8Array(r)),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:n,tagLength:this.TAG_LENGTH},i,s);return new TextDecoder().decode(o)}catch(t){throw m.handleError(t,{operation:"decrypt",component:"CryptoService",severity:"high"}),t}}static bufferToBase64(e){let t=new Uint8Array(e),r="";for(let n=0;n<t.byteLength;n++)r+=String.fromCharCode(t[n]);return btoa(r)}static base64ToBuffer(e){let t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r.buffer}static isAvailable(){return typeof crypto<"u"&&crypto.subtle!==void 0&&typeof crypto.getRandomValues=="function"}static async migrateFromXOR(e,t){try{let r=this.xorDecrypt(e,t);return await this.encrypt(r)}catch{return console.error("Migration failed, returning empty string"),""}}static xorDecrypt(e,t){let r=new Uint8Array(atob(e).split("").map(i=>i.charCodeAt(0))),n=new TextEncoder().encode(t),s=new Uint8Array(r.length);for(let i=0;i<r.length;i++)s[i]=r[i]^n[i%n.length];return new TextDecoder().decode(s)}};var me=J.DEFAULT_BRANCH,he=J.DEFAULT_TEST_BRANCH,E=class extends Error{constructor(t,r,n){super(t);this.response=n;this.name="GitLabAPIError",this.statusCode=r}},L=class extends Error{constructor(e=B.GITLAB_AUTH){super(e),this.name="GitLabAuthError"}},$=class extends Error{constructor(e=B.NETWORK_ERROR){super(e),this.name="GitLabNetworkError"}},R=class{static{this.DEFAULT_HEADERS=V.DEFAULT_HEADERS}static getGitLabApiBase(e){return ee(e.gitlabUrl)}static getGitLabWebBase(e){return te(e.gitlabUrl)}static async saveSettings(e,t){if(!e||typeof e!="object")throw new Error(B.INVALID_SETTINGS);try{let n=`gitlab-settings-${figma.root.id}`;if(!t)await figma.clientStorage.setAsync(n,e);else{let s=Object.assign({},e);if(e.saveToken||delete s.gitlabToken,figma.root.setSharedPluginData("Bridgy",n,JSON.stringify(s)),e.saveToken&&e.gitlabToken)try{if(I.isAvailable()){let i=await I.encrypt(e.gitlabToken);await figma.clientStorage.setAsync(`${n}-token`,i),await figma.clientStorage.setAsync(`${n}-crypto`,"v2"),e._needsCryptoMigration&&(await figma.clientStorage.deleteAsync(`${n}-key`),delete e._needsCryptoMigration)}else{let i=O.generateEncryptionKey(),o=O.encryptData(e.gitlabToken,i);await figma.clientStorage.setAsync(`${n}-token`,o),await figma.clientStorage.setAsync(`${n}-key`,i)}}catch(i){m.handleError(i,{operation:"encrypt_token",component:"GitLabService",severity:"high"}),delete s.gitlabToken}}figma.root.setSharedPluginData("Bridgy",`${n}-meta`,JSON.stringify({sharedWithTeam:t,savedAt:e.savedAt,savedBy:e.savedBy}))}catch(r){throw S.error("Error saving GitLab settings",r,S.CATEGORIES.GITLAB),new E(`Error saving GitLab settings: ${r.message||"Unknown error"}`,void 0,r)}}static async loadSettings(){try{let t=`gitlab-settings-${figma.root.id}`,r=await this.loadDocumentSettings(t);if(r)return r;let n=await this.loadPersonalSettings(t);if(n)return n;let s=await this.loadLegacySettings();return s||null}catch(e){return S.error("Error loading GitLab settings",e,S.CATEGORIES.GITLAB),null}}static async loadDocumentSettings(e){let t=figma.root.getSharedPluginData("Bridgy",e);if(!t)return null;try{let r=JSON.parse(t);if(r.saveToken&&!r.gitlabToken){let s=await figma.clientStorage.getAsync(`${e}-token`),i=await figma.clientStorage.getAsync(`${e}-crypto`);if(s)try{if(i==="v2"&&I.isAvailable()){let o=await I.decrypt(s);r.gitlabToken=o}else if(await figma.clientStorage.getAsync(`${e}-key`)){let o=await figma.clientStorage.getAsync(`${e}-key`),u=O.decryptData(s,o);r.gitlabToken=u,r._needsCryptoMigration=!0}else r.gitlabToken=s,r._needsCryptoMigration=!0}catch(o){m.handleError(o,{operation:"decrypt_token",component:"GitLabService",severity:"medium"})}}let n=figma.root.getSharedPluginData("Bridgy",`${e}-meta`);if(n)try{let s=JSON.parse(n);r.isPersonal=!s.sharedWithTeam}catch(s){console.warn("Error parsing settings metadata:",s)}return r}catch(r){return S.error("Error parsing document settings",r,S.CATEGORIES.GITLAB),null}}static async loadPersonalSettings(e){let t=await figma.clientStorage.getAsync(e);return t?Object.assign({},t,{isPersonal:!0}):null}static async loadLegacySettings(){let e=figma.root.getSharedPluginData("Bridgy","gitlab-settings");if(!e)return null;try{let t=JSON.parse(e);return await this.saveSettings(t,!0),figma.root.setSharedPluginData("Bridgy","gitlab-settings",""),t}catch(t){return S.error("Error parsing legacy document settings",t,S.CATEGORIES.GITLAB),null}}static async resetSettings(){try{let t=`gitlab-settings-${figma.root.id}`;figma.root.setSharedPluginData("Bridgy",t,""),figma.root.setSharedPluginData("Bridgy",`${t}-meta`,""),await figma.clientStorage.deleteAsync(t),await figma.clientStorage.deleteAsync(`${t}-token`),await figma.clientStorage.deleteAsync(`${t}-key`),figma.root.setSharedPluginData("Bridgy","gitlab-settings",""),await figma.clientStorage.deleteAsync("gitlab-settings")}catch(e){throw S.error("Error resetting GitLab settings",e,S.CATEGORIES.GITLAB),new E(`Error resetting GitLab settings: ${e.message||"Unknown error"}`,void 0,e)}}static async commitToGitLab(e,t,r,n,s=me){return await m.withErrorHandling(async()=>{let{projectId:i,gitlabToken:o}=e;this.validateCommitParameters(i,o,t,r,n);let u=s,l=(await this.fetchProjectInfo(i,o,e)).default_branch;await this.createFeatureBranch(i,o,u,l,e);let{fileData:g,action:p}=await this.prepareFileCommit(i,o,r,u,e);await this.createCommit(i,o,u,t,r,n,p,g&&g.last_commit_id,e);let d=await this.findExistingMergeRequest(i,o,u,e);return d?{mergeRequestUrl:d.web_url}:{mergeRequestUrl:(await this.createMergeRequest(i,o,u,l,t,"Automatically created merge request for CSS variables update",!1,e)).web_url}},{operation:"commit_to_gitlab",component:"GitLabService",severity:"high"})}static validateCommitParameters(e,t,r,n,s){if(!e||!e.trim())throw new Error("Project ID is required");if(!/^(\d+|[a-zA-Z0-9_.-]+\/[a-zA-Z0-9_.-]+)$/.test(e.trim()))throw new Error("Invalid project ID format. Use numeric ID or namespace/project format.");if(!t||!t.trim())throw new L("GitLab token is required");let o=t.trim();if(o.length<8)throw new L("GitLab token must be at least 8 characters long");if(/[\s"'<>]/.test(o))throw new L("GitLab token contains invalid characters");if(!r||!r.trim())throw new Error("Commit message is required");if(r.length>500)throw new Error("Commit message too long (max 500 characters)");if(/<script|javascript:|on\w+\s*=/i.test(r))throw new Error("Commit message contains potentially unsafe content");if(!n||!n.trim())throw new Error("File path is required");if(n.includes("..")||n.includes("\\")||n.startsWith("/"))throw new Error("Invalid file path - path traversal detected");if(!/^[a-zA-Z0-9/_.-]+\.(css|scss|less)$/.test(n))throw new Error("File path must be a valid CSS/SCSS/LESS file path");if(!s||!s.trim())throw new Error("CSS data is required");if(s.length>1024*1024)throw new Error("CSS data too large (max 1MB)")}static async fetchProjectInfo(e,t,r){let s=`${this.getGitLabApiBase(r)}/projects/${encodeURIComponent(e)}`;try{return await(await this.makeAPIRequest(s,{method:"GET",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS)})).json()}catch(i){throw this.handleGitLabError(i,"fetch project information")}}static async createFeatureBranch(e,t,r,n,s){let o=`${this.getGitLabApiBase(s)}/projects/${encodeURIComponent(e)}/repository/branches`;try{await this.makeAPIRequest(o,{method:"POST",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS),body:JSON.stringify({branch:r,ref:n})})}catch(u){if(u instanceof E){if(u.statusCode===400&&u.message&&u.message.includes("already exists"))return;throw u}throw this.handleGitLabError(u,`create branch '${r}'`)}}static async prepareFileCommit(e,t,r,n,s){let o=`${this.getGitLabApiBase(s)}/projects/${encodeURIComponent(e)}/repository/files/${encodeURIComponent(r)}?ref=${encodeURIComponent(n)}`;try{return{fileData:await(await this.makeAPIRequest(o,{method:"GET",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS)})).json(),action:"update"}}catch(u){if(u instanceof E&&u.statusCode===404)return{fileData:null,action:"create"};throw this.handleGitLabError(u,"check file existence")}}static async createCommit(e,t,r,n,s,i,o,u,c){let g=`${this.getGitLabApiBase(c)}/projects/${encodeURIComponent(e)}/repository/commits`,p={action:o,file_path:s,content:i,encoding:"text"};u&&(p.last_commit_id=u);try{return await(await this.makeAPIRequest(g,{method:"POST",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS),body:JSON.stringify({branch:r,commit_message:n,actions:[p]})})).json()}catch(d){throw d instanceof E?d:this.handleGitLabError(d,"create commit")}}static async findExistingMergeRequest(e,t,r,n){let i=`${this.getGitLabApiBase(n)}/projects/${encodeURIComponent(e)}/merge_requests?source_branch=${encodeURIComponent(r)}&state=opened`;try{let u=await(await this.makeAPIRequest(i,{method:"GET",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS)})).json();return u.length>0?u[0]:null}catch(o){throw this.handleGitLabError(o,"fetch merge requests")}}static async createMergeRequest(e,t,r,n,s,i="Automatically created merge request for CSS variables update",o=!1,u){let l=`${this.getGitLabApiBase(u)}/projects/${encodeURIComponent(e)}/merge_requests`,g=o?`Draft: ${s}`:s;try{return await(await this.makeAPIRequest(l,{method:"POST",headers:Object.assign({"PRIVATE-TOKEN":t},this.DEFAULT_HEADERS),body:JSON.stringify({source_branch:r,target_branch:n,title:g,description:i,remove_source_branch:!0,squash:!0})})).json()}catch(p){throw p instanceof E?p:this.handleGitLabError(p,"create merge request")}}static async commitComponentTest(e,t,r,n,s="components/{componentName}.spec.ts",i=he){return await m.withErrorHandling(async()=>{let{projectId:o,gitlabToken:u}=e;this.validateComponentTestParameters(o,u,t,r,n);let c=this.normalizeComponentName(r),l=s.replace(/{componentName}/g,c),g=`${i}-${c}`,d=(await this.fetchProjectInfo(o,u,e)).default_branch||"main";await this.createFeatureBranch(o,u,g,d,e);let{fileData:y,action:f}=await this.prepareFileCommit(o,u,l,g,e);await this.createCommit(o,u,g,t,l,n,f,y&&y.last_commit_id,e);let h=await this.findExistingMergeRequest(o,u,g,e);if(!h){let b=`Automatically created merge request for component test: ${r}`;return{mergeRequestUrl:(await this.createMergeRequest(o,u,g,d,t,b,!0,e)).web_url}}return{mergeRequestUrl:h.web_url}},{operation:"commit_component_test",component:"GitLabService",severity:"high"})}static validateComponentTestParameters(e,t,r,n,s){if(!e||!e.trim())throw new Error("Project ID is required");if(!t||!t.trim())throw new L("GitLab token is required");if(!r||!r.trim())throw new Error("Commit message is required");if(!n||!n.trim())throw new Error("Component name is required");if(!s||!s.trim())throw new Error("Test content is required")}static normalizeComponentName(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}static async makeAPIRequest(e,t){let n=new Promise((s,i)=>{setTimeout(()=>{i(new $("Request timed out - please check your connection to GitLab"))},3e4)});try{let s=await Promise.race([fetch(e,t),n]);if(!s.ok){let i=`HTTP ${s.status}: ${s.statusText}`;try{let u=await s.json();u.message?i=u.message:u.error?i=u.error:u.error_description&&(i=u.error_description)}catch{}let o=new E(i,s.status);throw o.statusCode=s.status,o}return s}catch(s){throw s instanceof E||s instanceof $?s:s.name==="TypeError"&&s.message.indexOf("fetch")!==-1?new $("Network error - unable to connect to GitLab API"):s}}static handleGitLabError(e,t){if(e instanceof E||e instanceof L||e instanceof $)return e;if(e.statusCode)switch(e.statusCode){case 401:case 403:return new L(`Authentication failed while trying to ${t}. Please check your GitLab token.`);case 404:return new E(`Resource not found while trying to ${t}. Please check your project ID.`,404);case 422:return new E(`Invalid data provided while trying to ${t}. Please check your inputs.`,422);case 429:return new E(`Rate limit exceeded while trying to ${t}. Please try again later.`,429);case 500:case 502:case 503:case 504:return new E(`GitLab server error while trying to ${t}. Please try again later.`,e.statusCode);default:return new E(`GitLab API error while trying to ${t}: ${e.message||"Unknown error"}`,e.statusCode)}return e.name==="TypeError"||e.message.indexOf("fetch")!==-1||e.message.indexOf("network")!==-1?new $(`Network error while trying to ${t}`):new E(`Failed to ${t}: ${e.message||"Unknown error"}`)}static async clearAllTokens(){try{let e=figma.root?.id;if(!e)return;let t=`gitlab-settings-${e}`;await figma.clientStorage.deleteAsync(`${t}-token`),await figma.clientStorage.deleteAsync(`${t}-key`),await figma.clientStorage.deleteAsync(`${t}-crypto`),await figma.clientStorage.deleteAsync(t);let r=figma.root.getSharedPluginData("Bridgy",t);if(r)try{let n=JSON.parse(r);n.saveToken=!1,delete n.gitlabToken,figma.root.setSharedPluginData("Bridgy",t,JSON.stringify(n))}catch{}S.info("All GitLab tokens cleared",S.CATEGORIES.GITLAB)}catch(e){m.handleError(e,{operation:"clear_tokens",component:"GitLabService",severity:"low"})}}static async getTokenInfo(){let e=figma.root?.id;if(!e)return{encrypted:!1,version:"none",hasToken:!1};let t=`gitlab-settings-${e}`,r=await figma.clientStorage.getAsync(`${t}-token`),n=await figma.clientStorage.getAsync(`${t}-crypto`);return{hasToken:!!r,encrypted:!!r,version:n||(r?"v1":"none")}}};var w=class{static{this.unitSettings={collections:{},groups:{}}}static getDefaultUnit(e){let t=e.toLowerCase(),r=n=>n.some(s=>{let i=s.toLowerCase();return new RegExp(`\\b${i.replace(/[-_]/g,"[-_]?")}\\b`).test(t)||t.includes(i)&&(t.startsWith(i+"-")||t.startsWith(i+"_")||t.endsWith("-"+i)||t.endsWith("_"+i)||t===i)});if(r(C.UNITLESS_PATTERNS))return"none";if(r(C.TYPOGRAPHY_PATTERNS))return t.includes("line")||t.includes("leading")?"none":"rem";if(r(C.SPACING_PATTERNS))return"rem";if(r(C.VIEWPORT_PATTERNS))return t.includes("width")||t.includes("w-")?"vw":t.includes("height")||t.includes("h-")?"vh":"vw";if(r(C.BORDER_RADIUS_PATTERNS))return t.includes("pill")||t.includes("circle")||t.includes("full")?"%":"px";if(t.includes("color")||t.includes("bg")||t.includes("background")||t.includes("border-color")||t.includes("text-color")||t.includes("duration")||t.includes("delay")||t.includes("time"))return"none";if(t.includes("border")&&(t.includes("width")||t.includes("size"))||t.includes("shadow")||t.includes("blur")||t.includes("spread"))return"px";if(r(C.RELATIVE_PATTERNS))return t.includes("container")||t.includes("col")||t.includes("sidebar")?"%":t.includes("icon")||t.includes("avatar")||t.includes("thumb")?"px":"%";if(t.startsWith("size-")||t.startsWith("space-"))return"rem";if(t.startsWith("breakpoint-")||t.startsWith("container-"))return"px";if(t.includes("button")||t.includes("input")||t.includes("card")){if(t.includes("padding")||t.includes("margin")||t.includes("gap"))return"rem";if(t.includes("border")||t.includes("outline"))return"px"}return/\d/.test(t)||t.includes("size")||t.includes("width")||t.includes("height")?"px":C.DEFAULT}static getUnitForVariable(e,t,r){if(r){let n=`${t}/${r}`;if(this.unitSettings.groups[n])return this.unitSettings.groups[n]}return this.unitSettings.collections[t]?this.unitSettings.collections[t]:this.getDefaultUnit(e)}static updateUnitSettings(e){e.collections&&(this.unitSettings.collections=Object.assign({},e.collections)),e.groups&&(this.unitSettings.groups=Object.assign({},e.groups))}static getUnitSettings(){return Object.assign({},this.unitSettings)}static formatValueWithUnit(e,t){return t==="none"||t===""?String(e):`${e}${t}`}static getUnitRationale(e){let t=e.toLowerCase(),r=this.getDefaultUnit(e),n=s=>s.some(i=>{let o=i.toLowerCase();return t.includes(o)||t.includes(o.replace("-",""))||t.includes(o.replace("-","_"))});if(r==="none"){if(n(C.UNITLESS_PATTERNS))return`Unitless: CSS property "${e}" doesn't require units`;if(t.includes("color")||t.includes("bg")||t.includes("background"))return"Color values don't require units";if(t.includes("duration")||t.includes("delay")||t.includes("time"))return"Timing values use CSS-specific units (s, ms)";if(t.includes("line")||t.includes("leading"))return"Line-height multipliers are unitless"}if(r==="rem"){if(n(C.TYPOGRAPHY_PATTERNS))return"Typography: rem units scale with root font size for accessibility";if(n(C.SPACING_PATTERNS))return"Spacing: rem units maintain consistent proportions with text";if(t.startsWith("size-")||t.startsWith("space-"))return"Design tokens: rem provides scalable, consistent sizing"}if(r==="%"){if(n(C.RELATIVE_PATTERNS))return"Relative sizing: % units create responsive, container-relative dimensions";if(t.includes("pill")||t.includes("circle")||t.includes("full"))return"Large radius: % creates perfect circles and pills"}return r==="vw"||r==="vh"?`Viewport units: ${r} scales with ${r==="vw"?"width":"height"} for full-screen designs`:r==="px"?t.includes("border")||t.includes("outline")?"Borders: px provides pixel-perfect precision for thin lines":t.includes("shadow")||t.includes("blur")?"Effects: px gives precise control over shadows and blur":t.includes("icon")||t.includes("avatar")||t.includes("thumb")?"Fixed assets: px ensures consistent sizing regardless of context":"Default: px provides precise, absolute positioning":`Smart default: ${r} chosen based on variable name analysis`}static async saveUnitSettings(){try{let t=`unit-settings-${figma.root.id}`;figma.root.setSharedPluginData("Bridgy",t,JSON.stringify(this.unitSettings)),figma.root.setSharedPluginData("Bridgy",`${t}-meta`,JSON.stringify({savedAt:new Date().toISOString(),savedBy:figma.currentUser&&figma.currentUser.name?figma.currentUser.name:"Unknown user"}))}catch(e){throw S.error("Error saving unit settings",e,S.CATEGORIES.UNITS),e}}static async loadUnitSettings(){try{let t=`unit-settings-${figma.root.id}`,r=figma.root.getSharedPluginData("Bridgy",t);if(r)try{this.unitSettings=JSON.parse(r);return}catch(s){S.error("Error parsing shared unit settings",s,S.CATEGORIES.UNITS)}let n=await figma.clientStorage.getAsync(t);if(n){this.unitSettings=n,await this.saveUnitSettings(),await figma.clientStorage.deleteAsync(t);return}}catch(e){S.error("Error loading unit settings",e,S.CATEGORIES.UNITS)}}static async resetUnitSettings(){try{let t=`unit-settings-${figma.root.id}`;this.unitSettings={collections:{},groups:{}},figma.root.setSharedPluginData("Bridgy",t,""),figma.root.setSharedPluginData("Bridgy",`${t}-meta`,""),await figma.clientStorage.deleteAsync(t)}catch(e){throw S.error("Error resetting unit settings",e,S.CATEGORIES.UNITS),e}}};var se="--",fe="$",ye="css",_=class{static{this.variableCache=new Map}static{this.collectionCache=new Map}static async exportVariables(e=ye){return await m.withErrorHandling(async()=>{if(["css","scss"].indexOf(e.toLowerCase())===-1)throw new Error(`Invalid export format: ${e}. Must be 'css' or 'scss'.`);await this.initialize();let r=await this.getProcessedCollections();if(!r||r.length===0)throw new Error("No variables found to export. Please ensure you have created variables in your Figma file.");return this.buildExportContent(r,e)},{operation:"export_variables",component:"CSSExportService",severity:"high"})}static async initialize(){return await m.withErrorHandling(async()=>{this.clearCaches(),await w.loadUnitSettings()},{operation:"initialize_css_export_service",component:"CSSExportService",severity:"medium"})}static clearCaches(){this.variableCache.clear(),this.collectionCache.clear()}static async getProcessedCollections(){return await m.withErrorHandling(async()=>{let e=await figma.variables.getLocalVariableCollectionsAsync();if(!e||e.length===0)throw new Error("No variable collections found in this Figma file.");await this.populateVariableCache(e);let t=e.sort((n,s)=>n.name.localeCompare(s.name)),r=[];for(let n of t)try{let s=await this.processCollection(n);(s.variables.length>0||Object.keys(s.groups).length>0)&&r.push(s)}catch(s){m.handleError(s,{operation:`process_collection_${n.name}`,component:"CSSExportService",severity:"medium"})}return r},{operation:"get_processed_collections",component:"CSSExportService",severity:"high"})}static async processCollection(e){let t=`${e.id}-${e.variableIds.length}`,r=this.collectionCache.get(t);if(r)return r;let n=[],s={};await Promise.all(e.variableIds.map(async o=>{let u=await this.processVariable(o,e);if(!u)return;let c=u.originalName.match(/^([^\/]+)\//);if(c){let l=c[1];s[l]||(s[l]=[]),s[l].push(u)}else n.push(u)}));let i={name:e.name,variables:n,groups:s};return this.collectionCache.set(t,i),i}static async processVariable(e,t){let r=await figma.variables.getVariableByIdAsync(e);if(!r)return null;let n=t.modes[0].modeId,s=r.valuesByMode[n],i=this.formatVariableName(r.name),o=this.resolveCSSValue(r,s,t);return o===null?null:{name:i,value:o,originalName:r.name}}static resolveCSSValue(e,t,r){if(t&&typeof t=="object"&&"type"in t&&t.type==="VARIABLE_ALIAS")return this.resolveVariableAlias(t.id);let s=e.name.match(/^([^\/]+)\//),i=s?s[1]:void 0;return this.formatVariableValue(e.resolvedType,t,e.name,r.name,i)}static resolveVariableAlias(e){let t=this.variableCache.get(e);if(!t)return null;let r=this.formatVariableName(t.name);return`var(${se}${r})`}static formatVariableName(e){return e.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}static buildExportContent(e,t){let r=[];return t==="css"&&r.push(":root {"),e.forEach(n=>{r.push(this.buildCollectionContent(n,t))}),t==="css"&&r.push("}"),r.join(`
`)}static buildCollectionContent(e,t){let r=[],n=t==="scss"?"//":"  /*",s=t==="scss"?"":" */";return r.push(`
${n} ===== ${e.name.toUpperCase()} =====${s}`),e.variables.forEach(o=>{r.push(this.formatVariableDeclaration(o,t))}),Object.keys(e.groups).sort().forEach(o=>{let u=this.formatGroupDisplayName(o);r.push(`
${n} ${u}${s}`),e.groups[o].forEach(c=>{r.push(this.formatVariableDeclaration(c,t))})}),r.join(`
`)}static formatVariableDeclaration(e,t){return t==="scss"?`${fe}${e.name}: ${e.value};`:`  ${se}${e.name}: ${e.value};`}static formatGroupDisplayName(e){return e.replace(/-/g," ").replace(/\b\w/g,t=>t.toUpperCase())}static async populateVariableCache(e){return await m.withErrorHandling(async()=>{await Promise.all(e.map(async t=>{try{await Promise.all(t.variableIds.map(async r=>{try{let n=await figma.variables.getVariableByIdAsync(r);n&&this.variableCache.set(n.id,n)}catch(n){m.handleError(n,{operation:`cache_variable_${r}`,component:"CSSExportService",severity:"low"})}}))}catch(r){m.handleError(r,{operation:`cache_collection_variables_${t.name}`,component:"CSSExportService",severity:"medium"})}}))},{operation:"populate_variable_cache",component:"CSSExportService",severity:"medium"})}static async collectAllVariables(e){await this.populateVariableCache(e)}static formatVariableValue(e,t,r,n,s){switch(e){case"COLOR":return this.formatColorValue(t);case"FLOAT":return this.formatFloatValue(t,r,n,s);case"STRING":return this.formatStringValue(t);case"BOOLEAN":return this.formatBooleanValue(t);default:return null}}static formatColorValue(e){if(!e||typeof e!="object"||!("r"in e)||!("g"in e)||!("b"in e))return null;let t=e,r=Math.round(t.r*255),n=Math.round(t.g*255),s=Math.round(t.b*255);return typeof t.a=="number"&&t.a<1?`rgba(${r}, ${n}, ${s}, ${t.a.toFixed(2)})`:`rgb(${r}, ${n}, ${s})`}static formatFloatValue(e,t,r,n){if(typeof e!="number"||isNaN(e))return null;let s=w.getUnitForVariable(t,r,n);return w.formatValueWithUnit(e,s)}static formatStringValue(e){return typeof e!="string"?null:`"${e}"`}static formatBooleanValue(e){return typeof e!="boolean"?null:e?"true":"false"}static async getUnitSettingsData(){return await m.withErrorHandling(async()=>{await w.loadUnitSettings();let e=await figma.variables.getLocalVariableCollectionsAsync();if(!e||e.length===0)return{collections:[],groups:[]};let t=e.sort((i,o)=>i.name.localeCompare(o.name)),r=[],n=[],s=w.getUnitSettings();return await Promise.all(t.map(async i=>{try{let u=s.collections[i.name]!==void 0?s.collections[i.name]:"Smart defaults",c=s.collections[i.name]||"";r.push({name:i.name,defaultUnit:u,currentUnit:c});let l=new Set;await Promise.all(i.variableIds.map(async g=>{try{let p=await figma.variables.getVariableByIdAsync(g);if(p){let d=p.name.match(/^([^\/]+)\//);d&&l.add(d[1])}}catch(p){m.handleError(p,{operation:`get_variable_for_groups_${g}`,component:"CSSExportService",severity:"low"})}})),Array.from(l).sort().forEach(g=>{try{let p=`${i.name}/${g}`,d=s.groups[p]!==void 0,y=s.collections[i.name]!==void 0,f;d?f=s.groups[p]:y?f=`Inherits: ${s.collections[i.name]}`:f="Smart defaults";let h=s.groups[p]||"";n.push({collectionName:i.name,groupName:g,defaultUnit:f,currentUnit:h})}catch(p){m.handleError(p,{operation:`process_group_${g}`,component:"CSSExportService",severity:"low"})}})}catch(o){m.handleError(o,{operation:`get_unit_settings_for_collection_${i.name}`,component:"CSSExportService",severity:"medium"})}})),{collections:r,groups:n}},{operation:"get_unit_settings_data",component:"CSSExportService",severity:"medium"})}static updateUnitSettings(e){w.updateUnitSettings(e)}static async saveUnitSettings(){await w.saveUnitSettings()}};function v(a){let e=Object.keys(a),t=[];for(let r=0;r<e.length;r++){let n=e[r];t.push([n,a[n]])}return t}function T(a,e){for(let t=0;t<a.length;t++)if(a[t]===e)return!0;return!1}function Y(a,e){let t=[];for(let r=0;r<a.length;r++){let n=e(a[r],r,a);for(let s=0;s<n.length;s++)t.push(n[s])}return t}var ie=P.INTERACTIVE,st=P.STATIC,F=re.STATE_SPECIFIC_PROPERTIES,oe=[{state:"hover",pseudoClass:":hover",properties:F.hover},{state:"focus",pseudoClass:":focus",properties:F.focus},{state:"active",pseudoClass:":active",properties:F.active},{state:"disabled",pseudoClass:":disabled",properties:F.disabled}];function M(a){let e=a.replace(/([A-Z])/g,"-$1").toLowerCase();return T(ie,a)||T(ie,e)?!0:["color","background","border","outline","shadow","fill","stroke"].some(r=>a.toLowerCase().indexOf(r)!==-1||e.indexOf(r)!==-1)}function ae(a){return a.replace(/([A-Z])/g,"-$1").toLowerCase()}function Se(a){return a.replace(/-([a-z])/g,e=>e[1].toUpperCase())}function ce(){return`  const resolveCssVariable = (variableName: string, stylesheetHrefPart = 'styles.css'): string | undefined => {
    const targetSheet = Array.from(document.styleSheets)
      .find(sheet => sheet.href?.includes(stylesheetHrefPart));

    const rootRule = Array.from(targetSheet?.cssRules || [])
      .filter(rule => rule instanceof CSSStyleRule)
      .find(rule => rule.selectorText === ':root');

    const value = rootRule?.style?.getPropertyValue(variableName)?.trim();
    if (value?.startsWith('var(')) {
      const nestedVar = value.match(/var\\((--[^)]+)\\)/)?.[1];
      return nestedVar ? resolveCssVariable(nestedVar, stylesheetHrefPart) : undefined;
    }

    return value;
  };

  const resolveCssValueWithVariables = (cssValue: string, stylesheetHrefPart = 'styles.css'): string => {
    if (!cssValue || typeof cssValue !== 'string') {
      return cssValue;
    }

    // Replace all var() functions in the CSS value
    return cssValue.replace(/var\\((--[^,)]+)(?:,\\s*([^)]+))?\\)/g, (match, varName, fallback) => {
      const resolvedValue = resolveCssVariable(varName, stylesheetHrefPart);
      return resolvedValue || fallback || match;
    });
  };

  const getCssPropertyForRule = (cssSelector: string, pseudoClass: string, prop: any) => {
    // Regex necessairy because angular attaches identifier after the selector
    const regex = new RegExp(\`\${cssSelector}([\\\\s\\\\S]*?)\${pseudoClass}\`);
    const style = Array.from(document.styleSheets)
      .flatMap(sheet => Array.from(sheet.cssRules || []))
      .filter(r => r instanceof CSSStyleRule)
      .find(r => regex.test(r.selectorText))
      ?.style;

    return style!.getPropertyValue(prop);
  };

  const checkStyleProperty = (selector: string, pseudoClass: string, property: string, expectedValue?: string) => {
    // TODO: please check whether the selector is correct
    const value = getCssPropertyForRule(selector, pseudoClass, property);
    if (!value) {
      // If no value is found for this pseudo-class, that's okay - not all states need all properties
      return;
    }

    if (value.indexOf('var(') !== -1) {
      const resolvedValue = resolveCssValueWithVariables(value);
      if (expectedValue) {
        expect(resolvedValue).toBe(expectedValue);
      } else {
        expect(resolvedValue).toBeDefined();
      }
    } else {
      if (expectedValue) {
        expect(value).toBe(expectedValue);
      } else {
        expect(value).toBeDefined();
      }
    }
  };`}function le(a,e,t){let r=[];return Object.keys(t).some(M)?(e.forEach(s=>{let i=Object.keys(t).filter(M),o=new Set(i.map(ae).concat(s.properties));if(o.size>0){let u=`should have correct ${s.state} styles`,c=Array.from(o).map(g=>{let p=Se(g),d=t[p];return d&&typeof d=="string"&&(g==="color"||g==="background-color"||g.indexOf("border")!==-1)?`      { property: '${g}', expected: '${d}' }`:`      { property: '${g}', expected: undefined }`}).join(`,
`),l=`
  it('${u}', () => {
    const element = fixture.nativeElement.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    if (!element) return;

    const propertiesToCheck = [
${c}
    ];

    propertiesToCheck.forEach(({ property, expected }) => {
      // TODO: Please check if this selector still matches the component's implementation
      checkStyleProperty('${a}', '${s.pseudoClass}', property, expected);
    });
  });`;r.push(l)}}),r.join(`
`)):""}function Ee(a){let e=new Map;return a.forEach((t,r)=>{let n=be(t.name);if(!n){console.log("DEBUG: No state name found, skipping variant");return}let s;try{s=typeof t.styles=="string"?JSON.parse(t.styles):t.styles,console.log(`DEBUG: Parsed ${Object.keys(s).length} style properties for state "${n}"`)}catch(o){console.error("Error parsing variant styles:",o);return}let i=new Map(v(s));e.set(n,i)}),e}function be(a){let e=a.match(/State=(\w+)/i);return e||(e=a.match(/Property\s*\d*\s*=\s*(\w+)/i),e)?e[1].toLowerCase():(e=a.match(/(\w+)=(\w+)/i),e?e[2].toLowerCase():null)}function Ce(a,e){let t=new Map;return e.forEach((r,n)=>{a.get(n)!==r&&t.set(n,r)}),t}function ue(a,e,t){let r=[],n=Ee(e),s=n.get("default");return s||(s=new Map(v(t))),Array.from(n.keys()).filter(o=>o!=="default").forEach(o=>{let u=n.get(o);if(!u)return;let c=Ce(s,u);if(c.size===0)return;let l=o.startsWith(":")?o:`:${o}`,g=`should have correct ${o} styles`,p=Array.from(c.entries()).map(([y,f])=>`      { property: '${ae(y)}', expected: '${f}' }`).join(`,
`),d=`
  it('${g}', () => {
    const element = fixture.nativeElement.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    if (!element) return;

    const propertiesToCheck = [
${p}
    ];

    propertiesToCheck.forEach(({ property, expected }) => {
      // TODO: Please check if this selector still matches the component's implementation
      checkStyleProperty('${a}', '${l}', property, expected);
    });
  });`;r.push(d)}),r.join(`
`)}function ge(a){let e=a.replace("#","");if(!D.HEX_COLOR.BOTH.test(e))return a;let t=e;e.length===3&&(t=e.split("").map(i=>i+i).join(""));let r=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),s=parseInt(t.substring(4,6),16);return`rgb(${r}, ${n}, ${s})`}function j(a){return!a||typeof a!="string"||a.startsWith("rgb(")||a.startsWith("rgba(")?a:a.startsWith("#")||D.HEX_COLOR.BOTH.test(a)?ge(a):a}function pe(a){return!a||typeof a!="string"?a:a.replace(D.HEX_COLOR.INLINE,e=>ge(e))}var ve=P.LAYOUT;function we(a,e){if(!a||a.length===0)return"";let t=[],r=a.filter(n=>n.textStyles&&Object.keys(n.textStyles).length>0);if(r.length>0)if(e&&e.length>0){let n=new Map;e.forEach(s=>{let i=s.name.match(/State=([^,]+)/i),o=s.name.match(/Size=([^,]+)/i),u=s.name.match(/Property\s*\d*\s*=\s*([^,]+)/i),c=i&&i[1]?i[1].toLowerCase():u&&u[1]?u[1].toLowerCase():"default",l=o&&o[1]?o[1].toLowerCase():"default",g=`${c}-${l}`;n.has(g)||n.set(g,[]),n.get(g).push(s)}),n.forEach((s,i)=>{let o=s[0];if(o.textElements&&o.textElements.length>0){let[u,c]=i.split("-"),l=`
  it('should have correct text styles for ${u} state, ${c} size', () => {
    const element = fixture.nativeElement;
    const textElement = element.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    
    if (!textElement) {
      LoggingService.warn('No text element found for style testing', undefined, LoggingService.CATEGORIES.TESTING);
      return;
    }
    
    const computedStyle = window.getComputedStyle(textElement);
    ${o.textElements.map((g,p)=>{let d=g.textStyles;if(!d||Object.keys(d).length===0)return"";let y=[];if(d.fontSize){let f=d.fontSize.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();y.push(`
    expect(computedStyle.fontSize).toBe('${f}');`)}if(d.fontFamily){let f=d.fontFamily.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();y.push(`
    expect(computedStyle.fontFamily).toBe('${f}');`)}if(d.fontWeight){let f=d.fontWeight.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();y.push(`
    expect(computedStyle.fontWeight).toBe('${f}');`)}if(d.color){let f=j(d.color.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim());y.push(`
    expect(computedStyle.color).toBe('${f}');`)}return y.join("")}).join("")}
  });`;t.push(l)}})}else{let n=`
  it('should have correct text styles', () => {
    const element = fixture.nativeElement;
    const textElement = element.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    
    if (!textElement) {
      LoggingService.warn('No text element found for style testing', undefined, LoggingService.CATEGORIES.TESTING);
      return;
    }
    
    const computedStyle = window.getComputedStyle(textElement);
    ${r.map((s,i)=>{let o=s.textStyles,u=[];if(o.fontSize){let c=o.fontSize.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();u.push(`
    expect(computedStyle.fontSize).toBe('${c}');`)}if(o.fontFamily){let c=o.fontFamily.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();u.push(`
    expect(computedStyle.fontFamily).toBe('${c}');`)}if(o.fontWeight){let c=o.fontWeight.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim();u.push(`
    expect(computedStyle.fontWeight).toBe('${c}');`)}if(o.color){let c=j(o.color.replace(/var\([^,]+,\s*([^)]+)\)/g,"$1").trim());u.push(`
    expect(computedStyle.color).toBe('${c}');`)}return u.join("")}).join("")}
  });`;t.push(n)}return t.join("")}function X(a,e,t,r=!0,n=!0,s,i){function o(h){return h.replace(/var\([^,]+,\s*([^\)]+)\)/g,"$1").replace(/\s+/g," ").trim()}let u=t.length>0?t.map(h=>{let b=o(String(h.value));return T(ve,h.property)?`      // Check ${h.property} (layout property - often structural)
      // expect(computedStyle.${h.property}).toBe('${b}');`:`      // Check ${h.property}
      expect(computedStyle.${h.property}).toBe('${b}');`}).join(`

`):"      // No style properties to check",l=a.split(/[^a-zA-Z0-9]+/).filter(h=>h.length>0).map(h=>h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()).join(""),g=`.${e}`,p={};t.forEach(h=>{p[h.property]=h.value});let d="";r&&(s&&s.length>0?d=ue(g,s,p):t.some(b=>M(b.property))&&(d=le(g,oe,p)));let f=s&&s.length>0&&(r||n)?`
${ce()}
`:"";return`import { ComponentFixture, TestBed } from '@angular/core/testing';
import { ${l}Component } from './${e}.component';

describe('${l}Component', () => {
  let component: ${l}Component;
  let fixture: ComponentFixture<${l}Component>;${f}

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ ${l}Component ]
    })
    .compileComponents();
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(${l}Component);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should have correct styles', () => {
    const element = fixture.nativeElement.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    if (element) {
      const computedStyle = window.getComputedStyle(element);
      
${u}
    } else {
      LoggingService.warn('No suitable element found to test styles', undefined, LoggingService.CATEGORIES.TESTING);
    }
  });${d}${we(i,s)}
});`}var z=class{constructor(e={}){this.cache=new Map;this.stats={hits:0,misses:0,evictions:0,currentSize:0,hitRate:0};this.options={maxSize:500,defaultTtl:5*60*1e3,enableStats:!0,...e}}get(e){let t=this.cache.get(e);if(!t)return this.updateStats("miss"),null;let r=Date.now();return r-t.timestamp>(this.options.defaultTtl||0)?(this.cache.delete(e),this.updateStats("miss"),null):(t.accessCount++,t.lastAccessed=r,this.updateStats("hit"),t.value)}set(e,t,r){let n=Date.now();!this.cache.has(e)&&this.cache.size>=(this.options.maxSize||500)&&this.evictLRU(),this.cache.set(e,{value:t,timestamp:n,accessCount:1,lastAccessed:n}),this.stats.currentSize=this.cache.size}has(e){return this.get(e)!==null}delete(e){let t=this.cache.delete(e);return this.stats.currentSize=this.cache.size,t}clear(){this.cache.clear(),this.stats.currentSize=0}async getOrSet(e,t,r){let n=this.get(e);if(n!==null)return n;let s=await t();return this.set(e,s,r),s}evictLRU(){let e="",t=Number.MAX_SAFE_INTEGER;for(let[r,n]of this.cache.entries())n.lastAccessed<t&&(t=n.lastAccessed,e=r);e&&(this.cache.delete(e),this.stats.evictions++)}updateStats(e){if(!this.options.enableStats)return;e==="hit"?this.stats.hits++:this.stats.misses++;let t=this.stats.hits+this.stats.misses;this.stats.hitRate=t>0?this.stats.hits/t:0}getStats(){return{...this.stats}}cleanup(){let e=Date.now(),t=this.options.defaultTtl||0,r=0;for(let[n,s]of this.cache.entries())e-s.timestamp>t&&(this.cache.delete(n),r++);return this.stats.currentSize=this.cache.size,r}keys(){return Array.from(this.cache.keys())}size(){return this.cache.size}},H=class a extends z{constructor(){super({maxSize:1e3,defaultTtl:10*60*1e3,enableStats:!0})}static getInstance(){return a.instance||(a.instance=new a),a.instance}static generateKey(e,t,r){return`css-${t}-${e}${r?`-${r}`:""}`}cacheNodeCSS(e,t,r){let n=a.generateKey(e,t);this.set(n,r)}getNodeCSS(e,t){let r=a.generateKey(e,t);return this.get(r)}hasNodeCSS(e,t){let r=a.generateKey(e,t);return this.has(r)}clearNodeCSS(e,t){let r=a.generateKey(e,t);this.delete(r)}getEfficiencyReport(){let e=this.getStats(),t=[];return e.hitRate<.5&&t.push("Low hit rate - consider increasing cache TTL"),e.evictions>e.hits*.1&&t.push("High eviction rate - consider increasing cache size"),e.currentSize<(this.options.maxSize||0)*.3&&t.push("Cache underutilized - consider reducing cache size"),{stats:e,recommendations:t}}},q=class a extends z{constructor(){super({maxSize:200,defaultTtl:60*60*1e3,enableStats:!1})}static getInstance(){return a.instance||(a.instance=new a),a.instance}cacheDuration(e,t){let r=`perf-${e}-${Date.now()}`;this.set(r,t)}getAverageDuration(e){let t=`perf-${e}-`,r=[];for(let n of this.keys())if(n.startsWith(t)){let s=this.get(n);s!==null&&r.push(s)}return r.length>0?r.reduce((n,s)=>n+s,0)/r.length:0}};var Te=["hover","active","focus","disabled"];var k=H.getInstance(),U=q.getInstance(),A=class a{static{this.componentMap=new Map}static{this.allVariables=new Map}static{this.styleCache=new Map}static{this.testCache=new Map}static{this.nameCache=new Map}static{this.MAX_CACHE_SIZE=1e3}static{this.CACHE_CLEANUP_THRESHOLD=800}static enforcesCacheLimit(e){e.size>this.MAX_CACHE_SIZE&&Array.from(e.keys()).slice(0,e.size-this.CACHE_CLEANUP_THRESHOLD).forEach(r=>e.delete(r))}static addToCache(e,t,r){e.has(t)&&e.delete(t),e.set(t,r),this.enforcesCacheLimit(e)}static isSimpleColorProperty(e){return T(P.SIMPLE_COLORS,e)}static isComplexColorProperty(e){return T(P.COMPLEX_COLORS,e)}static hasDecimalPixelValues(e){return/\d+\.\d+px/.test(e)}static normalizeStyleValue(e,t){return typeof t!="string"?t:this.isSimpleColorProperty(e)?j(t):this.isComplexColorProperty(e)?pe(t):t}static async collectComponents(){return await m.withErrorHandling(async()=>{await this.collectAllVariables();let e=[],t=[];this.componentMap=new Map;try{await figma.loadAllPagesAsync();let n=figma.root.children.map(async i=>{if(i.type!=="PAGE")return{components:[],componentSets:[]};let o=[],u=[];async function c(l){try{if(!("type"in l))return;if(l.type==="COMPONENT"||l.type==="COMPONENT_SET")try{let g={id:l.id,name:l.name,type:l.type,styles:{},pageName:i.name,parentId:l.parent&&l.parent.id,children:[],textElements:[],hasTextContent:!1};a.componentMap.set(l.id,g),l.type==="COMPONENT_SET"?u.push(g):o.push(g)}catch(g){m.handleError(g,{operation:`process_component_${l.name}`,component:"ComponentService",severity:"medium"})}if("children"in l&&l.children)for(let g of l.children)try{await c(g)}catch(p){m.handleError(p,{operation:"collect_component_children",component:"ComponentService",severity:"medium"})}}catch(g){m.handleError(g,{operation:"collect_node",component:"ComponentService",severity:"medium"})}}try{return await c(i),{components:o,componentSets:u}}catch(l){return m.handleError(l,{operation:`collect_page_components_${i.name}`,component:"ComponentService",severity:"medium"}),{components:[],componentSets:[]}}});(await Promise.all(n)).forEach(({components:i,componentSets:o})=>{e.push(...i),t.push(...o)})}catch(n){m.handleError(n,{operation:"load_all_pages",component:"ComponentService",severity:"high"})}try{e.forEach(n=>{if(n.parentId){let s=this.componentMap.get(n.parentId);s&&s.type==="COMPONENT_SET"&&(s.children.push(n),n.isChild=!0)}})}catch(n){m.handleError(n,{operation:"organize_component_hierarchy",component:"ComponentService",severity:"low"})}return t.concat(e.filter(n=>!n.isChild))},{operation:"collect_components",component:"ComponentService",severity:"high"})}static getComponentById(e){return this.componentMap.get(e)}static generateTest(e,t=!0,r=!0){let n=e.name,s=n.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),i=e.type==="COMPONENT_SET";if(i&&e.children&&e.children.length>0)return this.generateComponentSetTest(e);let o=i?e.children:void 0,u;try{u=typeof e.styles=="string"?JSON.parse(e.styles):e.styles}catch(l){console.error("Error parsing component styles:",l),u={}}let c=[];if(v(u).forEach(([l,g])=>{let p=l.replace(/-([a-z])/g,d=>d[1].toUpperCase());p==="background"&&(p="backgroundColor"),c.push({property:p,value:this.normalizeStyleValue(p,g)})}),e.textElements&&e.textElements.filter(l=>l.textStyles).forEach(l=>{v(l.textStyles).forEach(([g,p])=>{p&&c.push({property:g,value:this.normalizeStyleValue(g,p)})})}),i){let l=e.children&&e.children.length>0?e.children[0]:null;if(l){let g;try{g=typeof l.styles=="string"?JSON.parse(l.styles):l.styles}catch(d){console.error("Error parsing variant styles:",d),g={}}let p=[];return v(g).forEach(([d,y])=>{let f=d.replace(/-([a-z])/g,h=>h[1].toUpperCase());f==="background"&&(f="backgroundColor"),p.push({property:f,value:this.normalizeStyleValue(f,y)})}),X(n,s,p,t,r,o,l.textElements)}}return X(n,s,c,t,r,o,e.textElements)}static generateComponentSetTest(e){if(!e.children||e.children.length===0)return this.generateTest(e);let{kebabName:t,pascalName:r}=this.parseComponentName(e.name),n=this.generateVariantTests(e,t,r);return this.buildComponentSetTestTemplate(r,t,n.tests,n.variantProps)}static parseComponentName(e){if(!e||typeof e!="string")throw new Error(`Invalid component name: ${e}`);let t=this.nameCache.get(e);if(t)return t;let r=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");if(!r)throw new Error(`Could not generate valid kebab-case name from: ${e}`);let n=e.split(/[^a-zA-Z0-9]+/).filter(o=>o.length>0);if(n.length===0)throw new Error(`Could not extract words from component name: ${e}`);let s=n.map(o=>`${o.charAt(0).toUpperCase()}${o.slice(1).toLowerCase()}`).join(""),i={kebabName:r,pascalName:s};return this.nameCache.set(e,i),i}static generateVariantTests(e,t,r){let n=e.children?e.children.map(g=>g.id+g.name).join("|"):"",s=`variants-${e.id}-${n}`,i=this.testCache.get(s);if(i)return{tests:i,variantProps:[]};let o=[],u=new Set,c=[];e.children.forEach(g=>{try{let p=this.parseVariantName(g.name),d=g.name;if(u.has(d))return;u.add(d),c.push(p);let y=this.parseStyles(g.styles),f=this.extractCssProperties(y),h=this.extractTextStyles(g.textElements),b=p.state||"default";this.isPseudoState(b)?o.push(this.generatePseudoStateTest(p,f,t,h)):o.push(this.generateComponentPropertyTest(p,f,t,r,h))}catch(p){console.error("Error generating test for variant:",g.name,p)}});let l={tests:o.join(""),variantProps:c};return this.testCache.set(s,l.tests),l}static parseVariantName(e){if(!e||typeof e!="string")throw new Error(`Invalid variant name: ${e}`);let t={};return e.split(",").forEach(n=>{let i=n.trim().match(/^([^=]+)=(.+)$/);if(i){let o=i[1].trim(),u=i[2].trim(),c=o.replace(/\s+/g,"").replace(/^(.)/g,l=>l.toLowerCase()).replace(/[^a-zA-Z0-9]/g,"");t[c]=u,o.toLowerCase()==="state"&&(t.state=u)}}),t}static parseStyles(e){if(!e)return{};if(typeof e=="string"){let t=this.styleCache.get(e);if(t)return t;try{let r=JSON.parse(e),n=typeof r=="object"&&r!==null?r:{};return this.styleCache.set(e,n),n}catch(r){console.error("Failed to parse styles JSON:",r);let n={};return this.styleCache.set(e,n),n}}return typeof e=="object"&&e!==null?e:{}}static isPseudoState(e){return T(Te,e.toLowerCase())}static generateInputDeclarations(e){let t=new Map;e.forEach(n=>{v(n).forEach(([s,i])=>{s!=="state"&&(t.has(s)||t.set(s,new Set),t.get(s).add(i))})});let r=[];return t.forEach((n,s)=>{let i=Array.from(n).sort();if(i.length===1)r.push(`  @Input() ${s}: string = '${i[0]}';`);else{let o=i.map(c=>`'${c}'`).join(" | "),u=i[0];r.push(`  @Input() ${s}: ${o} = '${u}';`)}}),r.length===0?"":`/*
TODO: Add these @Input() properties to your component:

${r.join(`
`)}

Don't forget to add this import:
import { CommonModule } from '@angular/common';

IMPORTANT: Ensure your variables file is imported in your stylesheets to make CSS variables available for testing.
*/`}static buildComponentSetTestTemplate(e,t,r,n){let s=n?this.generateInputDeclarations(n):"";return`${s}${s?`

`:""}import { ComponentFixture, TestBed } from '@angular/core/testing';
import { ${e}Component } from './${t}.component';

describe('${e}Component - All Variants', () => {
  let component: ${e}Component;
  let fixture: ComponentFixture<${e}Component>;

  const resolveCssVariable = (variableName: string, stylesheetHrefPart = 'styles.css'): string | undefined => {
    const targetSheet = Array.from(document.styleSheets)
      .find(sheet => sheet.href?.includes(stylesheetHrefPart));

    const rootRule = Array.from(targetSheet?.cssRules || [])
      .filter(rule => rule instanceof CSSStyleRule)
      .find(rule => rule.selectorText === ':root');

    const value = rootRule?.style?.getPropertyValue(variableName)?.trim();
    if (value?.startsWith('var(')) {
      const nestedVar = value.match(/var\\((--[^)]+)\\)/)?.[1];
      return nestedVar ? resolveCssVariable(nestedVar, stylesheetHrefPart) : undefined;
    }

    return value;
  };

  const resolveCssValueWithVariables = (cssValue: string, stylesheetHrefPart = 'styles.css'): string => {
    if (!cssValue || typeof cssValue !== 'string') {
      return cssValue;
    }

    // Replace all var() functions in the CSS value
    return cssValue.replace(/var\\((--[^,)]+)(?:,\\s*([^)]+))?\\)/g, (match, varName, fallback) => {
      const resolvedValue = resolveCssVariable(varName, stylesheetHrefPart);
      return resolvedValue || fallback || match;
    });
  };

  const getCssPropertyForRule = (cssSelector: string, pseudoClass: string, prop: any) => {
    // Regex necessairy because angular attaches identifier after the selector
    const regex = new RegExp(\`\${cssSelector}([\\\\s\\\\S]*?)\${pseudoClass}\`);
    const style = Array.from(document.styleSheets)
      .flatMap(sheet => Array.from(sheet.cssRules || []))
      .filter(r => r instanceof CSSStyleRule)
      .find(r => regex.test(r.selectorText))
      ?.style;

    return style!.getPropertyValue(prop);
  };

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [${e}Component],
    }).compileComponents();
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(${e}Component);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

${r}
});`}static async collectAllVariables(){return await m.withErrorHandling(async()=>{let e=await figma.variables.getLocalVariableCollectionsAsync();this.allVariables.clear();let t=Y(e,n=>n.variableIds.map(s=>figma.variables.getVariableByIdAsync(s).catch(i=>(m.handleError(i,{operation:`get_variable_${s}`,component:"ComponentService",severity:"low"}),null))));(await Promise.all(t)).forEach(n=>{if(n)try{this.allVariables.set(n.id,n);let s=n.name.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase();this.allVariables.set(s,n)}catch(s){m.handleError(s,{operation:`process_variable_${n.name}`,component:"ComponentService",severity:"low"})}})},{operation:"collect_all_variables",component:"ComponentService",severity:"medium"})}static resolveStyleVariables(e,t,r){if(!e||typeof e!="object")return e;let n=Object.assign({},e);return Object.keys(e).forEach(s=>{if(e.hasOwnProperty(s)){let i=e[s];typeof i=="string"&&(n[s]=this.replaceVariableIdsWithNames(i))}}),t&&t.length>0&&t.forEach(s=>{s.textStyles&&Object.keys(s.textStyles).forEach(i=>{if(s.textStyles.hasOwnProperty(i)){let o=s.textStyles[i];if(o){let u=typeof o=="string"?this.replaceVariableIdsWithNames(o):o,c=i.replace(/([A-Z])/g,"-$1").toLowerCase();n[c]=u}}})}),n}static replaceVariableIdsWithNames(e){return e.replace(/VariableID:([a-f0-9:]+)\/[\d.]+/g,(t,r)=>(Array.from(this.allVariables.values()).find(n=>{let s=n;if(s&&s.id===r.replace(/:/g,":"))return`var(--${s.name.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()})`}),t)).replace(/var\(--[a-f0-9-]+\)/g,t=>{let r=t.replace(/var\(--([^)]+)\)/,"$1");return Array.from(this.allVariables.values()).forEach(n=>{let s=n;if(s&&s.id&&(s.id.indexOf(r)!==-1||r.indexOf(s.id)!==-1))return`var(--${s.name.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()})`}),t})}static extractTextStyles(e){if(!e||e.length===0)return{};let t={"font-size":"fontSize","font-family":"fontFamily","font-weight":"fontWeight",color:"color","line-height":"lineHeight","letter-spacing":"letterSpacing"},r=n=>{let s=n.substring(1);s.length===3&&(s=s.split("").map(c=>c+c).join(""));let i=parseInt(s.substring(0,2),16),o=parseInt(s.substring(2,4),16),u=parseInt(s.substring(4,6),16);return`rgb(${i}, ${o}, ${u})`};return Y(e.filter(n=>n.textStyles),n=>v(n.textStyles).filter(([s,i])=>i!=null&&i!=="").map(([s,i])=>{let o=t[s];if(!o)return null;let u=String(i);if(u.indexOf("var(")!==-1){let c=u.match(/var\([^,]+,\s*([^)]+)\)/);c&&(u=c[1].trim())}return/^#[0-9A-Fa-f]{3,6}$/.test(u)&&(u=r(u)),[o,u]}).filter(Boolean)).reduce((n,[s,i])=>(n[s]=i,n),{})}static extractCssProperties(e){let t={},r={};Object.keys(e).forEach(o=>{if(e.hasOwnProperty(o)){let u=e[o],c=o.replace(/-([a-z])/g,function(l){return l[1].toUpperCase()});c==="background"&&(c="backgroundColor"),r[c]=this.normalizeStyleValue(c,u)}});let n=["paddingTop","paddingRight","paddingBottom","paddingLeft"],s=["marginTop","marginRight","marginBottom","marginLeft"];n.some(o=>r[o])?t.padding="computed":r.padding&&(t.padding=String(r.padding)),s.some(o=>r[o])?t.margin="computed":r.margin&&(t.margin=String(r.margin));let i=new Set(n.concat(s));return Object.keys(r).filter(o=>r[o]&&!i.has(o)).forEach(o=>{t[o]=String(r[o])}),t}static generatePseudoStateTest(e,t,r,n={}){let s=e.state||"default",i=`:${s.toLowerCase()}`,o=v(e).filter(([g,p])=>g!=="state"&&p!=="default").map(([g,p])=>`${g}="${p}"`).join(" "),u=`should have correct :${s.toLowerCase()} styles${o?` for ${o}`:""}`,c=Object.assign({},t,n),l=Object.keys(c).filter(g=>{let p=c[g];return p==="computed"?!1:p.indexOf("var(")!==-1?p.replace(/var\([^,]+,\s*([^)]+)\)/g,(y,f)=>f.trim())!==p:!0});return l.length===0?`
  it('${u}', () => {
    console.log('${u}: No specific values to test');
  });`:`
  it('${u}', () => {
    const propertiesToCheck = [
${l.map(g=>{let p=c[g],d=p;p.indexOf("var(")!==-1&&(d=p.replace(/var\([^,]+,\s*([^)]+)\)/g,(h,b)=>b.trim()),d===p&&(d=null)),d=d.replace(/#([0-9A-Fa-f]{3,6})\b/g,(h,b)=>{let x=b;b.length===3&&(x=b.split("").map(Q=>Q+Q).join(""));let W=parseInt(x.substring(0,2),16),G=parseInt(x.substring(2,4),16),de=parseInt(x.substring(4,6),16);return`rgb(${W}, ${G}, ${de})`});let y=g.replace(/[A-Z]/g,h=>`-${h.toLowerCase()}`),f=n.hasOwnProperty(g);return`      { 
        property: '${g}', 
        cssProperty: '${y}', 
        expectedValue: '${d}'${f?", isTextStyle: true":""} 
      }`}).join(`,
`)}
    ];

    propertiesToCheck.forEach((check) => {
      // TODO: please check whether the selector is correct
      const resolvedValue = getCssPropertyForRule('.${r}', '${i}', check.cssProperty);
      
      if (resolvedValue) {
        if (resolvedValue.indexOf('var(') !== -1) {
          const actualValue = resolveCssValueWithVariables(resolvedValue);
          expect(actualValue).withContext(check.property).toBe(check.expectedValue);
        } else {
          expect(resolvedValue).withContext(check.property).toBe(check.expectedValue);
        }
      } else {
        // Fallback to computed style if CSS rule not found
        console.log('No CSS rule found for:', check.cssProperty);
        ${Object.keys(e).filter(g=>g!=="state").map(g=>`component.${g} = '${e[g]}';`).join(`
        `)}
        fixture.detectChanges();
        const element = fixture.nativeElement.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
        const computedStyle = window.getComputedStyle(element);
        expect(computedStyle.getPropertyValue(check.cssProperty)).withContext(check.property).toBe(check.expectedValue);
      }
    });
  });`}static generateComponentPropertyTest(e,t,r,n,s={}){let i=[],o=[];v(e).forEach(([l,g])=>{if(g!=="default"){if(l==="state"&&["hover","active","focus","disabled"].indexOf(g.toLowerCase())!==-1)return;let p=l;(l==="variantType"||l==="variant")&&(p="variant"),i.push(`component.${p} = '${g.toLowerCase()}';`),o.push(`${l}="${g}"`)}});let u=o.join(" ");return`
  it('${u?`should have correct styles for ${u}`:"should have correct styles"}', () => {
    ${i.length>0?`${i.join(`
    `)}
    fixture.detectChanges();
`:""}
    const element = fixture.nativeElement.querySelector('button, div, span, a, p, h1, h2, h3, h4, h5, h6');
    if (element) {
      const computedStyle = window.getComputedStyle(element);

${Object.keys(t).map(l=>{let g=t[l],p=g;return g==="computed"?`      // ${l} (shorthand property)
      // expect(computedStyle.${l}).toBe('expected-value');`:g.indexOf("var(")!==-1&&(p=g.replace(/var\([^,]+,\s*([^)]+)\)/g,(y,f)=>f.trim()),p===g)?`      // ${l} (CSS variable without fallback)
      // expect(computedStyle.${l}).toBe('expected-value');`:(p=p.replace(/#([0-9A-Fa-f]{3,6})\b/g,(y,f)=>{let h=f;f.length===3&&(h=f.split("").map(G=>G+G).join(""));let b=parseInt(h.substring(0,2),16),x=parseInt(h.substring(2,4),16),W=parseInt(h.substring(4,6),16);return`rgb(${b}, ${x}, ${W})`}),this.hasDecimalPixelValues(g)||g!==p&&this.hasDecimalPixelValues(p)?`      // Note: Figma may have rounded decimal pixel values - test may fail due to rounding
      expect(computedStyle.${l}).withContext('${l}').toBe('${p}');`:`      expect(computedStyle.${l}).withContext('${l}').toBe('${p}');`)}).join(`

`)}${Object.keys(s).length>0?`

`+Object.keys(s).map(l=>{let g=s[l];return`      expect(computedStyle.${l}).withContext('${l}').toBe('${g}');`}).join(`

`):""}

    } else {
      console.warn('No suitable element found to test styles');
    }
  });`}static async extractTextElements(e){return await m.withErrorHandling(async()=>{let t=[];async function r(n){try{if(n.type==="TEXT"){let s=n,i={},o={};try{let u=k.getNodeCSS(s.id,"TEXT");if(u)o=JSON.parse(u);else{let c=typeof performance<"u"?performance.now():Date.now();o=await s.getCSSAsync(),k.cacheNodeCSS(s.id,"TEXT",JSON.stringify(o));let g=(typeof performance<"u"?performance.now():Date.now())-c;U.cacheDuration("getCSSAsync-text",g)}i={fontSize:o["font-size"],fontFamily:o["font-family"],fontWeight:o["font-weight"],lineHeight:o["line-height"],letterSpacing:o["letter-spacing"],textAlign:o["text-align"],color:o.color,textDecoration:o["text-decoration"],textTransform:o["text-transform"],fontStyle:o["font-style"],fontVariant:o["font-variant"],textShadow:o["text-shadow"],wordSpacing:o["word-spacing"],whiteSpace:o["white-space"],textIndent:o["text-indent"],textOverflow:o["text-overflow"]},Object.keys(i).forEach(c=>{(i[c]==null||i[c]==="")&&delete i[c]})}catch(u){m.handleError(u,{operation:`get_text_styles_${s.id}`,component:"ComponentService",severity:"low"})}try{let u={id:s.id,content:s.characters||"",type:"TEXT",styles:o,textStyles:i};t.push(u)}catch(u){m.handleError(u,{operation:`create_text_element_${s.id}`,component:"ComponentService",severity:"low"})}}if("children"in n)for(let s of n.children)await r(s)}catch(s){m.handleError(s,{operation:`traverse_text_node_${n.id}`,component:"ComponentService",severity:"low"})}}return await r(e),t},{operation:"extract_text_elements",component:"ComponentService",severity:"medium"})}static async loadComponentStyles(e){return await m.withErrorHandling(async()=>{let t=this.componentMap.get(e);if(!t)throw new Error(`Component with ID ${e} not found`);if(t.styles&&Object.keys(t.styles).length>0)return t.styles;let r=await figma.getNodeByIdAsync(e);if(!r||r.type!=="COMPONENT"&&r.type!=="COMPONENT_SET")throw new Error(`Node with ID ${e} is not a valid component`);let n=typeof performance<"u"?performance.now():Date.now(),s=await r.getCSSAsync(),i=typeof performance<"u"?performance.now():Date.now();return U.cacheDuration("getCSSAsync-lazy",i-n),t.styles=s,this.componentMap.set(e,t),s},{operation:"load_component_styles_lazy",component:"ComponentService",severity:"medium"})}static async loadComponentTextElements(e){return await m.withErrorHandling(async()=>{let t=this.componentMap.get(e);if(!t)throw new Error(`Component with ID ${e} not found`);if(t.textElements&&t.textElements.length>0)return t.textElements;let r=await figma.getNodeByIdAsync(e);if(!r||r.type!=="COMPONENT"&&r.type!=="COMPONENT_SET")throw new Error(`Node with ID ${e} is not a valid component`);let n=await this.extractTextElements(r);return t.textElements=n,t.hasTextContent=n.length>0,this.componentMap.set(e,t),n},{operation:"load_component_text_elements_lazy",component:"ComponentService",severity:"medium"})}static async loadComponentDetails(e){let[t,r]=await Promise.all([this.loadComponentStyles(e),this.loadComponentTextElements(e)]);return{styles:t,textElements:r}}static getCacheStats(){let e=k.getEfficiencyReport(),t=U.getAverageDuration("getCSSAsync"),r=U.getAverageDuration("getCSSAsync-text"),n={averageCSSTime:t,averageTextCSSTime:r,totalCachedItems:k.size()};return{css:e.stats,performance:n,recommendations:e.recommendations}}static clearCaches(){k.clear(),U.clear()}static cleanupCaches(){let e=k.cleanup(),t=U.cleanup();return{cssCleared:e,perfCleared:t}}};figma.showUI(__html__,{width:1e3,height:900,themeColors:!0});async function Ae(){try{let a=await figma.variables.getLocalVariableCollectionsAsync(),e=[],t=a.sort((n,s)=>n.name.localeCompare(s.name));for(let n of t){let s=n.variableIds.map(async u=>{let c=await figma.variables.getVariableByIdAsync(u);if(!c)return null;let l=[];return Object.keys(c.valuesByMode).forEach(g=>{let p=c.valuesByMode[g],d=n.modes.find(y=>y.modeId===g);l.push({modeName:d?d.name:"Unknown",value:p})}),{id:c.id,name:c.name,resolvedType:c.resolvedType,valuesByMode:l}}),o=(await Promise.all(s)).filter(u=>u!==null);e.push({name:n.name,variables:o})}let r=await A.collectComponents();(!r||r.length===0)&&console.warn("No components found in document"),figma.ui.postMessage({type:"document-data",variablesData:e,componentsData:r||[]})}catch(a){console.error("Error collecting document data:",a),figma.ui.postMessage({type:"document-data-error",error:a instanceof Error?a.message:"Unknown error during data collection",variablesData:[],componentsData:[]})}}async function xe(){try{let a=await R.loadSettings();a&&figma.ui.postMessage({type:"gitlab-settings-loaded",settings:a})}catch(a){console.error("Error loading GitLab settings:",a)}}Ae();xe();figma.codegen.on("generate",a=>{try{return[{language:"PLAINTEXT",code:"Bridgy - Use the plugin interface to view variables and components",title:"Bridgy"}]}catch(e){return console.error("Plugin error:",e),[{language:"PLAINTEXT",code:"Error occurred during code generation",title:"Error"}]}});figma.ui.onmessage=async a=>{try{switch(a.type){case"export-css":let e=a.exportFormat||"css",t=await _.exportVariables(e);figma.ui.postMessage({type:"css-export",cssData:t,shouldDownload:a.shouldDownload,exportFormat:e});break;case"generate-test":if(!a.componentId)throw new Error("Missing required component ID");let r=A.getComponentById(a.componentId);if(!r)throw new Error(`Component with ID ${a.componentId} not found`);await A.loadComponentDetails(a.componentId);let n=A.generateTest(r,a.includeStateTests!==!1);figma.ui.postMessage({type:"test-generated",componentName:a.componentName||r.name,testContent:n,isComponentSet:r.type==="COMPONENT_SET",forCommit:a.forCommit});break;case"load-component-styles":if(!a.componentId)throw new Error("Missing required component ID for loading styles");if(!A.getComponentById(a.componentId))throw new Error(`Component with ID ${a.componentId} not found`);let{styles:i,textElements:o}=await A.loadComponentDetails(a.componentId);figma.ui.postMessage({type:"component-styles-loaded",componentId:a.componentId,styles:i||{},textElements:o||[]});break;case"select-component":try{if(console.log("Backend: Received select-component for ID:",a.componentId),!a.componentId)throw new Error("Missing required component ID for selection");let c=await figma.getNodeByIdAsync(a.componentId);if(console.log("Backend: Found node:",c?.name,c?.type,c?.parent?.type),!c)throw new Error(`Component with ID ${a.componentId} not found`);let l=c.type!=="DOCUMENT"&&c.type!=="PAGE";if(console.log("Backend: Is scene node:",l),!l)throw new Error(`Node ${a.componentId} is not a selectable scene node (type: ${c.type})`);c.parent&&c.parent.type==="PAGE"&&c.parent!==figma.currentPage&&(console.log("Backend: Switching to page:",c.parent.name),figma.currentPage=c.parent),figma.currentPage.selection=[c],figma.viewport.scrollAndZoomIntoView([c]),console.log("Backend: Successfully selected and navigated to component"),figma.ui.postMessage({type:"component-selected",componentId:a.componentId,componentName:c.name})}catch(c){console.error("Backend: Error selecting component:",c),figma.ui.postMessage({type:"error",message:`Failed to select component: ${c.message}`})}break;case"save-gitlab-settings":await R.saveSettings({gitlabUrl:a.gitlabUrl,projectId:a.projectId||"",gitlabToken:a.gitlabToken,filePath:a.filePath||"src/variables.css",testFilePath:a.testFilePath||"components/{componentName}.spec.ts",strategy:a.strategy||"merge-request",branchName:a.branchName||"feature/variables",testBranchName:a.testBranchName||"feature/component-tests",exportFormat:a.exportFormat||"css",saveToken:a.saveToken||!1,savedAt:new Date().toISOString(),savedBy:figma.currentUser&&figma.currentUser.name?figma.currentUser.name:"Unknown user"},a.shareWithTeam||!1),figma.ui.postMessage({type:"gitlab-settings-saved",success:!0,sharedWithTeam:a.shareWithTeam});break;case"commit-to-gitlab":if(!a.projectId||!a.gitlabToken||!a.commitMessage||!a.cssData)throw new Error("Missing required fields for GitLab commit");try{let c={gitlabUrl:a.gitlabUrl,projectId:a.projectId,gitlabToken:a.gitlabToken,filePath:a.filePath||"variables.css",testFilePath:"components/{componentName}.spec.ts",strategy:"merge-request",branchName:a.branchName||"feature/variables",testBranchName:"feature/component-tests",exportFormat:"css",saveToken:!1,savedAt:new Date().toISOString(),savedBy:figma.currentUser&&figma.currentUser.name?figma.currentUser.name:"Unknown user"},l=await R.commitToGitLab(c,a.commitMessage,a.filePath||"variables.css",a.cssData,a.branchName||"feature/variables");figma.ui.postMessage({type:"commit-success",message:Z.COMMIT_SUCCESS,mergeRequestUrl:l&&l.mergeRequestUrl})}catch(c){let l="Unknown error occurred",g="unknown";c.name==="GitLabAuthError"?(g="auth",l="Authentication failed. Please check your GitLab token and permissions."):c.name==="GitLabNetworkError"?(g="network",l="Network error. Please check your internet connection and GitLab server availability."):c.name==="GitLabAPIError"?c.statusCode===401||c.statusCode===403?(g="auth",l="Authentication failed. Please check your GitLab token and permissions."):(g="api",c.statusCode===404?l="Project not found. Please check your project ID.":c.statusCode===422?l="Invalid data provided. Please check your settings and try again.":c.statusCode===429?l="Rate limit exceeded. Please try again in a few minutes.":l=c.message||"GitLab API error occurred."):l=c.message||"Unknown error occurred",figma.ui.postMessage({type:"commit-error",error:l,errorType:g,statusCode:c.statusCode})}break;case"commit-component-test":if(!a.projectId||!a.gitlabToken||!a.commitMessage||!a.testContent||!a.componentName)throw new Error("Missing required fields for component test commit");try{let c={gitlabUrl:a.gitlabUrl,projectId:a.projectId,gitlabToken:a.gitlabToken,filePath:"variables.css",testFilePath:a.testFilePath||"components/{componentName}.spec.ts",strategy:"merge-request",branchName:"feature/variables",testBranchName:a.branchName||"feature/component-tests",exportFormat:"css",saveToken:!1,savedAt:new Date().toISOString(),savedBy:figma.currentUser&&figma.currentUser.name?figma.currentUser.name:"Unknown user"},l=await R.commitComponentTest(c,a.commitMessage,a.componentName,a.testContent,a.testFilePath||"components/{componentName}.spec.ts",a.branchName||"feature/component-tests");figma.ui.postMessage({type:"test-commit-success",message:Z.TEST_COMMIT_SUCCESS,componentName:a.componentName,mergeRequestUrl:l&&l.mergeRequestUrl})}catch(c){let l="Unknown error occurred",g="unknown";c.name==="GitLabAuthError"?(g="auth",l="Authentication failed. Please check your GitLab token and permissions."):c.name==="GitLabNetworkError"?(g="network",l="Network error. Please check your internet connection and GitLab server availability."):c.name==="GitLabAPIError"?c.statusCode===401||c.statusCode===403?(g="auth",l="Authentication failed. Please check your GitLab token and permissions."):(g="api",c.statusCode===404?l="Project not found. Please check your project ID.":c.statusCode===422?l="Invalid data provided. Please check your settings and try again.":c.statusCode===429?l="Rate limit exceeded. Please try again in a few minutes.":l=c.message||"GitLab API error occurred."):l=c.message||"Unknown error occurred",figma.ui.postMessage({type:"test-commit-error",error:l,errorType:g,componentName:a.componentName,statusCode:c.statusCode})}break;case"reset-gitlab-settings":await R.resetSettings(),figma.ui.postMessage({type:"gitlab-settings-reset",success:!0});break;case"get-unit-settings":let u=await _.getUnitSettingsData();figma.ui.postMessage({type:"unit-settings-data",data:u});break;case"update-unit-settings":_.updateUnitSettings({collections:a.collections,groups:a.groups}),await _.saveUnitSettings(),figma.ui.postMessage({type:"unit-settings-updated",success:!0});break;case"resize-plugin":break;default:}}catch(e){console.error("Error handling message:",e),figma.ui.postMessage({type:"error",message:e.message||"Unknown error occurred"})}};})();
