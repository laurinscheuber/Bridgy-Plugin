<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>aWall Synch UI</title>
    <!-- Add JSZip library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 16px;
        color: #333;
        background-color: #f7f8fa;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .section {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        background-color: #fff;
      }
      h2 {
        margin-top: 0;
        margin-bottom: 16px;
        color: #333;
        font-size: 20px;
        font-weight: 600;
      }
      h3 {
        margin-top: 16px;
        margin-bottom: 8px;
        color: #444;
        font-size: 18px;
        font-weight: 600;
      }
      h4 {
        margin-top: 16px;
        margin-bottom: 8px;
        color: #555;
        font-size: 16px;
        font-weight: 500;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 16px;
        background-color: #fff;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab {
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .tab:hover {
        background-color: #f0f7ff;
      }
      .tab.active {
        border-bottom: 2px solid #0d99ff;
        color: #0d99ff;
        background-color: #f0f7ff;
      }
      .tab-content {
        display: none;
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab-content.active {
        display: block;
      }
      
      /* Component group styles */
      .component-group {
        margin-bottom: 24px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fff;
      }
      
      .component-group-header {
        padding: 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
      }
      
      .component-group-header:hover {
        background: #f1f3f4;
      }
      
      .component-group-header.expanded {
        border-radius: 8px 8px 0 0;
      }
      
      .component-group-title {
        font-weight: 600;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .component-group-toggle {
        font-size: 18px;
        color: #666;
        transition: transform 0.2s;
      }
      
      .component-group-header.expanded .component-group-toggle {
        transform: rotate(90deg);
      }
      
      .component-group-content {
        display: none;
        padding: 16px;
      }
      
      .component-group-content.expanded {
        display: block;
      }
      
      /* Interactive component preview */
      .component-preview-group {
        margin-bottom: 20px;
      }
      
      .component-preview {
        margin-bottom: 16px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }
      
      .preview-element {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
        border: 1px solid transparent;
        background: #007bff;
        color: white;
        font-size: 14px;
        font-weight: 500;
        margin-right: 8px;
      }
      
      .preview-element:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .preview-element:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .preview-element:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .state-labels {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 8px;
      }
      
      .state-label {
        padding: 2px 6px;
        background: #e9ecef;
        border-radius: 3px;
        font-size: 11px;
      }
      
      /* Component variable details */
      .component-variables {
        margin-top: 16px;
      }
      
      .variables-toggle {
        background: none;
        border: 1px solid #ddd;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        margin-bottom: 12px;
      }
      
      .variables-toggle:hover {
        background: #f8f9fa;
      }
      
      .variables-list {
        display: none;
        background: #f8f9fa;
        border-radius: 4px;
        padding: 12px;
        margin-top: 8px;
      }
      
      .variables-list.expanded {
        display: block;
      }
      
      .variable-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 12px;
        border-bottom: 1px solid #e9ecef;
      }
      
      .variable-item:last-child {
        border-bottom: none;
      }
      
      .variable-name {
        font-family: monospace;
        color: #666;
      }
      
      .variable-value {
        font-family: monospace;
        color: #0066cc;
        cursor: pointer;
      }
      
      .variable-value:hover {
        text-decoration: underline;
      }
      .variable-collection {
        margin-bottom: 24px;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #eaeaea;
      }
      .collection-name {
        font-weight: 600;
        margin-bottom: 16px;
        color: #333;
        font-size: 18px;
      }
      .variable-subgroup {
        margin-top: 16px;
        margin-bottom: 16px;
        padding: 12px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }
      .subgroup-title {
        font-weight: 500;
        margin-bottom: 12px;
        color: #555;
        font-size: 14px;
        text-transform: capitalize;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        background-color: #fff;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      th {
        text-align: left;
        background-color: #f3f4f6;
        padding: 10px 12px;
        font-weight: 500;
        color: #444;
        border-bottom: 1px solid #e5e7eb;
      }
      td {
        padding: 10px 12px;
        border-top: 1px solid #eee;
        vertical-align: top;
      }
      tr:hover td {
        background-color: #f9fafb;
      }
      .color-preview {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .search-container {
        margin-bottom: 16px;
      }
      .search-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .search-input:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }
      .component-list {
        max-height: 700px;
        overflow-y: auto;
        border-radius: 6px;
        background-color: #fff;
        border: 1px solid #eaeaea;
      }
      .component-item {
        padding: 16px;
        border-bottom: 1px solid #eee;
      }
      .component-item:hover {
        background-color: #f5f5f5;
      }
      .no-items {
        color: #999;
        font-style: italic;
        padding: 32px 16px;
        text-align: center;
        background-color: #f9f9f9;
        border-radius: 8px;
      }
      .loading {
        text-align: center;
        padding: 32px 16px;
        color: #777;
        background-color: #f9f9f9;
        border-radius: 8px;
      }
      .loading:after {
        content: "...";
        animation: dots 1.5s steps(5, end) infinite;
      }
      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      /* Component hierarchy styling */
      .component-set {
        background-color: #f8f9fa;
        margin-bottom: 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .component-set-header {
        cursor: pointer;
        padding: 16px;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
      }
      .component-set-header:hover {
        background-color: #edf2f7;
      }
      .component-set-toggle {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #0d99ff;
        background-color: #e1f0ff;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .component-set-header.expanded .component-set-toggle {
        transform: rotate(90deg);
      }
      .component-set-children {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .component-set-children.expanded {
        max-height: 1000px;
      }
      .child-component {
        border-left: 3px solid #0d99ff;
        margin: 0 0 0 20px;
        background-color: #fafbfc;
      }
      .component-set-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 8px;
        padding-left: 20px;
      }
      .child-component table {
        box-shadow: none;
        border-radius: 0;
      }
      /* Type and state badges */
      .badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        margin-right: 8px;
      }
      .badge-component {
        background-color: #e1f0ff;
        color: #0d99ff;
      }
      .badge-component-set {
        background-color: #c9f7f0;
        color: #0a9882;
      }
      .badge-state {
        background-color: #f0e6ff;
        color: #7e3ff2;
      }
      .badge-type {
        background-color: #fff2e0;
        color: #ff8c00;
      }
      /* Component info layout */
      .component-name {
        font-weight: 500;
        margin-right: 10px;
      }
      .component-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
      }
      .component-styles {
        margin-top: 8px;
        padding: 8px;
        background-color: #f5f7f9;
        border-radius: 4px;
        font-size: 12px;
        color: #555;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        font-family: monospace;
      }
      .component-styles.expanded {
        white-space: pre-wrap;
        overflow: auto;
        max-height: 400px;
        border: 1px solid #e0e0e0;
        padding: 12px;
        background-color: #f9f9f9;
      }
      .close-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 10px;
        cursor: pointer;
        display: none;
      }
      .component-styles.expanded .close-button {
        display: block;
      }
      .json-key {
        color: #881391;
      }
      .json-string {
        color: #1a1aa6;
      }
      .json-number {
        color: #1c00cf;
      }
      .json-boolean {
        color: #0033b3;
      }
      .json-null {
        color: #808080;
      }
      
      /* Enhanced Component Styles */
      .component-card {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        margin-bottom: 16px;
        background: white;
        transition: all 0.2s ease;
        overflow: hidden;
      }
      .component-card:hover {
        border-color: #0d99ff;
        box-shadow: 0 4px 12px rgba(13, 153, 255, 0.1);
      }
      .component-header {
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }
      .component-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
      }
      .component-preview {
        width: 48px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid #e0e0e0;
      }
      .component-meta {
        flex: 1;
      }
      .component-name {
        font-weight: 600;
        color: #333;
        margin: 0 0 4px 0;
        font-size: 14px;
      }
      .component-details {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
      }
      .component-badge {
        background: #f0f0f0;
        color: #666;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
      }
      .component-badge.set {
        background: #e8f4ff;
        color: #0d99ff;
      }
      .component-badge.state {
        background: #fff2e8;
        color: #e67e22;
      }
      .component-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .component-toggle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .component-toggle:hover {
        background: #e8f4ff;
        border-color: #0d99ff;
        color: #0d99ff;
      }
      .component-toggle.expanded {
        transform: rotate(180deg);
        background: #0d99ff;
        color: white;
        border-color: #0d99ff;
      }
      .component-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: #fafbfc;
      }
      .component-content.expanded {
        max-height: 500px;
      }
      .component-variants {
        padding: 16px;
        border-bottom: 1px solid #eee;
      }
      .variant-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }
      .variant-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.2s ease;
      }
      .variant-item:hover {
        border-color: #0d99ff;
        box-shadow: 0 2px 8px rgba(13, 153, 255, 0.1);
      }
      .variant-preview {
        width: 100%;
        height: 40px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
        border: 1px solid #e0e0e0;
      }
      .variant-name {
        font-size: 12px;
        color: #666;
        text-align: center;
      }
      .component-styles-section {
        padding: 16px;
        border-bottom: 1px solid #eee;
      }
      .styles-toggle {
        background: none;
        border: none;
        color: #0d99ff;
        cursor: pointer;
        font-size: 12px;
        padding: 4px 0;
        text-decoration: underline;
      }
      .component-actions-section {
        padding: 16px;
        display: flex;
        gap: 12px;
        background: white;
      }
      .action-button {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid #e0e0e0;
        background: white;
        color: #333;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .action-button:hover {
        border-color: #0d99ff;
        color: #0d99ff;
        background: #f8faff;
      }
      .action-button.primary {
        background: #0d99ff;
        color: white;
        border-color: #0d99ff;
      }
      .action-button.primary:hover {
        background: #0c8ae6;
      }
      
      /* Button styling */
      button {
        padding: 8px 16px;
        background-color: #0d99ff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      button:hover {
        background-color: #0a85e9;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      }
      button:disabled {
        background-color: #c8d3dc;
        cursor: not-allowed;
        box-shadow: none;
      }
      .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }
      .generate-test-button {
        background-color: #4caf50;
      }
      .generate-test-button:hover {
        background-color: #3d8b40;
      }
      .generate-test-button.loading {
        background-color: #9e9e9e;
        cursor: wait;
        box-shadow: none;
      }
      .generate-all-variants-button {
        background-color: #e91e63;
      }
      .generate-all-variants-button:hover {
        background-color: #c2185b;
      }
      .test-success-message {
        background-color: #e8f5e9;
        color: #2e7d32;
        padding: 8px 16px;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 14px;
        display: none;
        border: 1px solid #c8e6c9;
      }
      select {
        padding: 9px 12px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        background-color: white;
        font-size: 14px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: #fff;
        margin: 5% auto;
        padding: 32px;
        width: 80%;
        max-width: 500px;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        margin-bottom: 16px;
      }

      .modal-header h3 {
        margin: 0;
        color: #444;
        font-size: 18px;
        font-weight: 600;
      }

      .modal-body {
        margin-bottom: 16px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
      }

      .form-group input:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 16px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }

      .security-note {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        font-size: 14px;
        display: none; /* Hidden by default in compact mode */
      }

      .security-note p {
        margin-top: 0;
        font-weight: 500;
        color: #856404;
      }

      .security-note ul {
        margin-bottom: 0;
        padding-left: 20px;
      }

      .security-note-compact {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        padding: 8px 16px;
        margin: 16px 0;
        font-size: 14px;
        font-style: italic;
        color: #856404;
        display: none; /* Will be shown conditionally */
      }

      .saved-info {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px dashed #ffeeba;
        font-style: italic;
        color: #856404;
      }

      .close-modal {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
      }

      .close-modal:hover {
        color: #333;
      }

      .commit-button {
        background-color: #4caf50;
        min-width: 80px;
        box-sizing: border-box;
      }

      .commit-button:hover {
        background-color: #3d8b40;
      }

      .commit-button.loading {
        background-color: #9e9e9e;
        cursor: wait;
        min-width: 80px;
        width: auto;
        white-space: nowrap;
        box-shadow: none;
      }

      /* Styles for GitLab credentials display and settings */
      .credentials-display {
        display: flex;
        align-items: center;
        background-color: #f5f7f9;
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border: 1px solid #eaeaea;
        justify-content: space-between;
      }

      .credentials-display > div {
        font-size: 14px;
        margin-right: 10px;
      }

      #project-id-display {
        font-weight: 500;
        color: #333;
      }

      #token-display {
        font-family: monospace;
        color: #555;
      }

      .settings-icon {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        height: auto;
        box-shadow: none;
      }

      .settings-icon:hover {
        background-color: #e1f0ff;
        color: #0d99ff;
      }

      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
        resize: vertical;
        font-family: "Inter", sans-serif;
      }

      textarea:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }

      .success-message {
        background-color: #e8f5e9;
        color: #2e7d32;
        padding: 8px 16px;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 14px;
        display: none;
        border: 1px solid #c8e6c9;
      }

      .merge-request-link {
        margin-top: 16px;
        display: block;
        text-decoration: none;
        color: #0d99ff;
        font-weight: 500;
      }

      .merge-request-link:hover {
        text-decoration: underline;
      }

      .error-message {
        background-color: #ffeeee;
        color: #c62828;
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 14px;
        border: 1px solid #ffcdd2;
      }

      .error-message p {
        margin: 0 0 8px 0;
      }

      .error-message p:last-child {
        margin-bottom: 0;
      }

      .error-help {
        color: #666;
        font-size: 14px;
        font-style: italic;
        margin-top: 8px;
      }

      /* Progress bar styles */
      .progress-bar-container {
        width: 100%;
        height: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin: 16px 0 8px 0;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        width: 0%;
        background-color: #0d99ff;
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .progress-status {
        font-size: 13px;
        color: #666;
        margin-bottom: 16px;
        font-style: italic;
      }

      #commit-progress-container {
        background-color: #f5f7f9;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 16px;
        border: 1px solid #eaeaea;
      }

      /* Settings Icon */
      #settings-icon-btn:hover {
        background-color: #f0f7ff !important;
        color: #0d99ff !important;
      }

      /* Units settings styles */
      .units-section {
        margin-bottom: 32px;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e0e0e0;
      }
      
      .units-section h4 {
        margin-top: 0;
        margin-bottom: 16px;
        color: #333;
        font-size: 16px;
        font-weight: 600;
      }
      
      .units-group {
        margin-bottom: 16px;
        padding: 16px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }
      
      .units-group h5 {
        margin-top: 0;
        margin-bottom: 12px;
        color: #555;
        font-size: 14px;
        font-weight: 500;
      }
      
      .unit-setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .unit-setting-row:last-child {
        border-bottom: none;
      }
      
      .unit-setting-label {
        font-weight: 500;
        color: #333;
        flex: 1;
      }
      
      .unit-setting-control {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .unit-dropdown {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        background-color: white;
        font-size: 14px;
        min-width: 80px;
      }
      
      .unit-dropdown:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.15);
      }
      
      .default-unit-label {
        font-size: 12px;
        color: #666;
        font-style: italic;
      }

      /* Responsive modal adjustments */
      @media (max-height: 700px) {
        .modal-content {
          margin: 2% auto;
          max-height: 96vh;
        }
      }

      @media (max-height: 500px) {
        .modal-content {
          margin: 1% auto;
          max-height: 98vh;
        }

        .modal-header {
          margin-bottom: 10px;
        }

        .modal-body {
          margin-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">aWall Synch</h2>
        <div style="display: flex; gap: 8px;">
          <button id="help-icon-btn" onclick="openUserGuide()" class="settings-icon" title="User Guide">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" stroke-width="2"/>
              <circle cx="12" cy="17" r="1" fill="currentColor"/>
            </svg>
          </button>
          <button id="settings-icon-btn" onclick="openSettingsModal()" class="settings-icon" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="variables">Variables</div>
        <div class="tab" data-tab="components">Components</div>
        <div class="tab" data-tab="units">Units</div>
      </div>

      <div class="tab-content active" id="variables-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="variable-search"
            placeholder="Search variables..."
          />
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
          <button id="export-css-button" disabled>
            Export Variables as CSS
          </button>
          <button id="commit-repo-button" disabled>
            Commit to Repository
          </button>
        </div>
        <div id="variables-container">
          <div class="loading">Loading variables</div>
        </div>
      </div>

      <div class="tab-content" id="components-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="component-search"
            placeholder="Search components..."
          />
        </div>

        <div id="components-container">
          <div class="loading">Loading components</div>
        </div>
      </div>

      <div class="tab-content" id="units-content">
        <div style="margin-bottom: 24px;">
          <h3 style="margin-top: 0; margin-bottom: 16px;">Variable Units Settings</h3>
          <p style="color: #666; margin-bottom: 16px;">Configure units for numeric variables. Collections override defaults, groups override collections.</p>
          
          <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <button id="reset-units-button" style="background-color: #f44336;" onclick="window.resetUnitsSettings()">
              Reset to Smart Defaults
            </button>
            <button id="save-units-button" disabled onclick="window.saveUnitsSettings()">
              Save Unit Settings
            </button>
          </div>
        </div>

        <div id="units-settings-container">
          <div class="loading">Loading unit settings...</div>
        </div>
      </div>

    </div>

    <!-- GitLab Commit Modal -->
    <div id="gitlab-modal" class="modal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeGitLabModal()">&times;</button>
        <div class="modal-header">
          <h3>Commit to Repository</h3>
        </div>
        <div class="modal-body">
          <p>Configuration is managed in the Config tab. You can go there to set up your repository settings.</p>

          <div class="form-group">
            <label for="commit-message">Change Message</label>
            <textarea id="commit-message" rows="4" placeholder="Optional: Describe the changes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="closeGitLabModal()">Cancel</button>
          <button id="commit-submit-button" class="commit-button" onclick="commitToGitLab()">Commit</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
        <div class="modal-header">
          <h3>Settings</h3>
        </div>
        <div class="modal-body">
          <h4>GitLab Configuration</h4>
          <p>Configure your GitLab repository settings. This configuration will be shared with your team.</p>

          <div class="form-group">
            <label for="config-project-id">Project ID</label>
            <input type="text" id="config-project-id" placeholder="e.g. 24267" />
          </div>

          <div class="form-group">
            <label for="config-file-path">CSS Variables File Path</label>
            <input type="text" id="config-file-path" placeholder="src/variables.css" />
          </div>

          <div class="form-group">
            <label for="config-test-file-path">Component Test File Path Template</label>
            <input type="text" id="config-test-file-path" placeholder="components/{componentName}/{componentName}.component.spec.ts" />
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
              <i>Use {componentName} as a placeholder for the component name</i>
            </div>
          </div>

          <div class="form-group">
            <label for="config-token">Project Access Token</label>
            <input type="password" id="config-token" placeholder="Enter your GitLab private token" />
          </div>

          <div class="form-group">
            <label for="config-strategy">Strategy</label>
            <select id="config-strategy">
              <option value="direct">Direct Commit</option>
              <option value="merge-request" selected>Merge Request</option>
            </select>
          </div>

          <div id="config-branch-section" class="form-group">
            <label for="config-branch">CSS Variables Branch Name</label>
            <input type="text" id="config-branch" placeholder="feature/variables" />
          </div>

          <div id="config-test-branch-section" class="form-group">
            <label for="config-test-branch">Component Tests Branch Name</label>
            <input type="text" id="config-test-branch" placeholder="feature/component-tests" />
          </div>

          <div class="form-group checkbox-group">
            <input type="checkbox" id="config-save-token" checked />
            <label for="config-save-token">Save token (recommended for convenience)</label>
          </div>

          <div class="form-group checkbox-group">
            <input type="checkbox" id="config-share-team" checked />
            <label for="config-share-team">Share settings with team</label>
          </div>

          <div style="background-color: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; padding: 10px; margin: 10px 0; font-size: 14px; color: #1565c0;">
            <p style="margin: 0;">‚ÑπÔ∏è Info: only be changed by Dev Team</p>
          </div>

          <!-- Configuration Metadata -->
          <div id="config-metadata" style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin: 10px 0; font-size: 12px; color: #6c757d; display: none;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
              </svg>
              <span id="config-metadata-text">Last saved: Loading...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
          <button onclick="showResetConfirmation()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px;" title="Reset all configuration">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6V20A2,2 0 0,1 17,20H7A2,2 0 0,1 5,20V6M8,6V4A2,2 0 0,1 10,4H14A2,2 0 0,1 16,4V6"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Reset
          </button>
          <div>
            <button onclick="closeSettingsModal()">Cancel</button>
            <button onclick="saveConfiguration()" class="btn-primary">Save Configuration</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Guide Modal -->
    <div id="user-guide-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 800px;">
        <button class="close-modal" onclick="closeUserGuide()">&times;</button>
        <div class="modal-header">
          <h3>üé® aWall Synch - User Guide</h3>
          <p style="margin: 8px 0 0; color: #666; font-size: 14px;">Bridging the gap between designers and developers</p>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

          <!-- Introduction -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
            <h4 style="margin: 0 0 12px; font-size: 18px;">üöÄ Welcome to aWall Synch!</h4>
            <p style="margin: 0; line-height: 1.5;">This plugin helps designers and developers work together seamlessly. Export Figma variables as CSS, generate component tests, and commit changes directly to your repository.</p>
          </div>

          <!-- Process Overview -->
          <div style="margin-bottom: 24px;">
            <h4 style="color: #333; margin-bottom: 16px;">üìã Collaboration Process</h4>

            <!-- Step 1 -->
            <div style="display: flex; margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
              <div style="background: #28a745; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: bold; font-size: 12px; flex-shrink: 0;">1</div>
              <div>
                <h5 style="margin: 0 0 8px; color: #28a745;">Initial Setup (One-time)</h5>
                <p style="margin: 0; line-height: 1.5; color: #555;">
                  <strong>üë®‚Äçüíª Developer:</strong> Sets up project configuration in the settings (‚öôÔ∏è icon):<br>
                  ‚Ä¢ GitLab Project ID and Access Token<br>
                  ‚Ä¢ File path for CSS variables<br>
                  ‚Ä¢ Branch naming strategy<br>
                  ‚Ä¢ Commit vs. Merge Request workflow
                </p>
              </div>
            </div>

            <!-- Step 2 -->
            <div style="display: flex; margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
              <div style="background: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: bold; font-size: 12px; flex-shrink: 0;">2</div>
              <div>
                <h5 style="margin: 0 0 8px; color: #007bff;">Testing & Validation</h5>
                <p style="margin: 0; line-height: 1.5; color: #555;">
                  <strong>üé® Designer:</strong> Tests the setup by making a small change and committing it:<br>
                  ‚Ä¢ Ensures variables sync correctly<br>
                  ‚Ä¢ Verifies the commit process works<br>
                  ‚Ä¢ Confirms the file appears in the repository
                </p>
              </div>
            </div>

            <!-- Step 3 -->
            <div style="display: flex; margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
              <div style="background: #6f42c1; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: bold; font-size: 12px; flex-shrink: 0;">3</div>
              <div>
                <h5 style="margin: 0 0 8px; color: #6f42c1;">Daily Workflow</h5>
                <p style="margin: 0; line-height: 1.5; color: #555;">
                  <strong>üé® Designer:</strong> Makes design changes and syncs them:<br>
                  ‚Ä¢ Update colors, spacing, typography in Figma<br>
                  ‚Ä¢ Open aWall Synch plugin<br>
                  ‚Ä¢ Review changes in the Variables tab<br>
                  ‚Ä¢ Click "Commit to Repository" with a descriptive message
                </p>
              </div>
            </div>

            <!-- Step 4 -->
            <div style="display: flex; margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #fd7e14;">
              <div style="background: #fd7e14; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: bold; font-size: 12px; flex-shrink: 0;">4</div>
              <div>
                <h5 style="margin: 0 0 8px; color: #fd7e14;">Integration & Review</h5>
                <p style="margin: 0; line-height: 1.5; color: #555;">
                  <strong>üë®‚Äçüíª Developer:</strong> Reviews and integrates changes:<br>
                  ‚Ä¢ Gets notified of new commits/merge requests<br>
                  ‚Ä¢ Reviews the CSS variable changes<br>
                  ‚Ä¢ Merges approved changes into main branch<br>
                  ‚Ä¢ Updates the application with new design tokens
                </p>
              </div>
            </div>
          </div>

          <!-- Key Features -->
          <div style="margin-bottom: 24px;">
            <h4 style="color: #333; margin-bottom: 16px;">‚ú® Key Features</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h5 style="margin: 0 0 8px; color: #007bff;">üé® Variables Export</h5>
                <p style="margin: 0; font-size: 14px; color: #666;">Export Figma variables as CSS custom properties, ready for development use.</p>
              </div>
              <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h5 style="margin: 0 0 8px; color: #28a745;">üß™ Test Generation</h5>
                <p style="margin: 0; font-size: 14px; color: #666;">Generate Angular component tests to ensure designs match implementation.</p>
              </div>
              <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h5 style="margin: 0 0 8px; color: #dc3545;">üì° GitLab Integration</h5>
                <p style="margin: 0; font-size: 14px; color: #666;">Commit changes directly to GitLab with automatic merge request creation.</p>
              </div>
              <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h5 style="margin: 0 0 8px; color: #6f42c1;">üîç Search & Filter</h5>
                <p style="margin: 0; font-size: 14px; color: #666;">Easily find and review specific variables and components before export.</p>
              </div>
            </div>
          </div>

          <!-- Workflow Strategies -->
          <div style="margin-bottom: 24px;">
            <h4 style="color: #333; margin-bottom: 16px;">‚öôÔ∏è Workflow Strategies</h4>

            <div style="background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
              <h5 style="margin: 0 0 8px; color: #28a745;">üîÑ Merge Request Strategy (Recommended)</h5>
              <p style="margin: 0; color: #155724; line-height: 1.5;">Each commit creates a merge request. Multiple commits to the same feature get added to the same MR. Perfect for collaborative review and controlled integration.</p>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px;">
              <h5 style="margin: 0 0 8px; color: #856404;">‚ö° Direct Commit Strategy</h5>
              <p style="margin: 0; color: #856404; line-height: 1.5;">Changes go directly to the main branch. Faster but requires more trust in the design changes. Best for mature teams with established processes.</p>
            </div>
          </div>

          <!-- Tips -->
          <div style="background: #f0f7ff; border: 1px solid #c3d9ff; border-radius: 8px; padding: 16px;">
            <h4 style="margin: 0 0 12px; color: #0066cc;">üí° Pro Tips</h4>
            <ul style="margin: 0; padding-left: 20px; color: #0066cc;">
              <li style="margin-bottom: 8px;">Use descriptive commit messages (e.g., "Update primary colors for better accessibility")</li>
              <li style="margin-bottom: 8px;">Review variables before committing to catch any unintended changes</li>
              <li style="margin-bottom: 8px;">Coordinate with developers for major design system changes</li>
              <li style="margin-bottom: 8px;">Test the setup with small changes before making large updates</li>
              <li>Keep your Figma variable names consistent and descriptive</li>
            </ul>
          </div>

        </div>
        <div class="modal-footer">
          <button onclick="closeUserGuide()" class="btn-primary">Got it!</button>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirmation-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 500px;">
        <button class="close-modal" onclick="closeResetConfirmation()">&times;</button>
        <div class="modal-header">
          <h3 style="color: #dc3545; display: flex; align-items: center; gap: 10px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            Reset Configuration
          </h3>
        </div>
        <div class="modal-body">
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <p style="margin: 0; color: #856404; font-weight: 500;">‚ö†Ô∏è Warning: This action cannot be undone!</p>
          </div>

          <p style="margin-bottom: 16px; line-height: 1.5;">
            This will permanently delete <strong>all configuration data</strong> for this Figma project, including:
          </p>

          <ul style="margin: 0 0 20px 20px; line-height: 1.6; color: #555;">
            <li>GitLab Project ID and access token</li>
            <li>File path and branch settings</li>
            <li>Strategy preferences (commit vs merge request)</li>
            <li>All saved metadata (who saved, when)</li>
          </ul>

          <p style="margin: 0; color: #666; font-style: italic;">
            After reset, you'll need to reconfigure everything from scratch.
          </p>
        </div>
        <div class="modal-footer">
          <button onclick="closeResetConfirmation()">Cancel</button>
          <button onclick="confirmReset()" style="background: #dc3545; color: white; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-weight: 500;">
            Yes, Reset Everything
          </button>
        </div>
      </div>
    </div>

    <!-- Success message (hidden by default) -->
    <div id="success-message" class="success-message" style="display: none;">
      <p>Successfully committed to GitLab repository!</p>
    </div>

    <!-- Error message (hidden by default) -->
    <div id="error-message" class="error-message" style="display: none;">
      <p><strong>Error committing to GitLab:</strong> <span id="error-details"></span></p>
      <p class="error-help">Please check your credentials and try again.</p>
    </div>

    <script>
      // Define unit settings functions early to ensure they're available
      window.saveUnitsSettings = function() {
        console.log("‚òÖ‚òÖ‚òÖ saveUnitsSettings called ‚òÖ‚òÖ‚òÖ");
        
        const collections = {};
        const groups = {};
        
        const dropdowns = document.querySelectorAll('.unit-dropdown');
        console.log("Found", dropdowns.length, "dropdowns");
        
        dropdowns.forEach(dropdown => {
          const type = dropdown.dataset.type;
          const value = dropdown.value;
          console.log(`Found dropdown: type=${type}, value=${value}`);
          
          // Only save non-empty values (empty = use smart defaults)
          if (value !== '') {
            if (type === 'collection') {
              const name = dropdown.dataset.name;
              collections[name] = value;
              console.log(`Added collection: ${name} = ${value}`);
            } else if (type === 'group') {
              const collectionName = dropdown.dataset.collection;
              const groupName = dropdown.dataset.group;
              const key = `${collectionName}/${groupName}`;
              groups[key] = value;
              console.log(`Added group: ${key} = ${value}`);
            }
          }
        });
        
        console.log("Sending unit settings:", { collections, groups });
        parent.postMessage({
          pluginMessage: {
            type: "update-unit-settings",
            collections: collections,
            groups: groups
          }
        }, "*");
      };
      
      window.resetUnitsSettings = function() {
        console.log("‚òÖ‚òÖ‚òÖ resetUnitsSettings called ‚òÖ‚òÖ‚òÖ");
        
        if (confirm("Are you sure you want to reset all unit settings to smart defaults?")) {
          // Clear all dropdowns to smart defaults (empty value)
          const dropdowns = document.querySelectorAll('.unit-dropdown');
          console.log("Found", dropdowns.length, "dropdowns to reset");
          
          dropdowns.forEach(dropdown => {
            dropdown.value = ''; // Select empty option (Smart defaults)
            console.log(`Reset dropdown to empty value`);
          });
          
          // Save the reset settings
          window.saveUnitsSettings();
        }
      };

      // Tab switching
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          tab.classList.add("active");
          const tabContent = document.getElementById(tab.dataset.tab + "-content");
          tabContent.classList.add("active");
          
          // Load units settings when Units tab is clicked
          if (tab.dataset.tab === "units") {
            loadUnitsSettings();
          }
        });
      });

      // Store data
      let variablesData = [];
      let componentsData = [];
      let currentCSSData = null;
      window.gitlabSettings = null; // Store GitLab settings
      let unitsData = null; // Store units settings data
      
      // Available units for dropdowns
      const AVAILABLE_UNITS = ['', 'px', 'rem', 'em', '%', 'vw', 'vh', 'vmin', 'vmax', 'pt', 'pc', 'in', 'cm', 'mm', 'ex', 'ch', 'fr', 'none'];

      // Helper function to find variable name by ID
      function findVariableNameById(variableId) {
        for (const collection of variablesData) {
          for (const variable of collection.variables) {
            if (variable.id === variableId) {
              return variable.name;
            }
          }
        }
        return null;
      }

      // Function to scroll to a variable
      function scrollToVariable(variableName) {
        const element = document.getElementById(`var-${variableName}`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Add a temporary highlight effect
          element.style.backgroundColor = '#fff3cd';
          element.style.border = '2px solid #ffc107';
          setTimeout(() => {
            element.style.backgroundColor = '';
            element.style.border = '';
          }, 2000);
        }
      }

      // Listen for messages from the plugin
      window.onmessage = (event) => {
        const message = event.data.pluginMessage;
        const exportButton = document.getElementById("export-css-button");
        const commitButton = document.getElementById("commit-repo-button");

        if (message.type === "gitlab-settings-loaded") {
          // Store the loaded GitLab settings
          window.gitlabSettings = message.settings;
          console.log("GitLab settings loaded");
          loadConfigurationTab();
          // Check if user guide should auto-open for first-time users
          checkAndShowUserGuide();
        } else if (message.type === "gitlab-settings-saved") {
          // Confirmation that settings were saved
          console.log("GitLab settings saved successfully");
        } else if (message.type === "document-data") {
          variablesData = message.variablesData;
          componentsData = message.componentsData;

          renderVariables(variablesData);
          renderComponents(componentsData);

          // Enable the export button only if there are variables
          if (
            variablesData &&
            variablesData.some((collection) => collection.variables.length > 0)
          ) {
            exportButton.disabled = false;
            commitButton.disabled = false;
          } else {
            exportButton.disabled = true;
            commitButton.disabled = true;
          }

          // Check if user guide should auto-open (fallback for users without any settings)
          setTimeout(() => {
            checkAndShowUserGuide();
          }, 1000);
        } else if (message.type === "css-export") {
          // Store the CSS data for later use
          currentCSSData = message.cssData;
          // Only trigger download if this was an explicit export request
          if (message.shouldDownload) {
            downloadCSS(message.cssData);
          }
        } else if (message.type === "angular-export-data") {
          // Trigger ZIP download with component data based on selected language
          const language = message.language || "angular";
          downloadComponentsZip(message.files, language);
        } else if (message.type === "test-generated") {
          // Handle test generation result
          if (message.forCommit) {
            // For commit, send the commit-component-test message
            if (!window.gitlabSettings) {
              alert("Please configure your GitLab settings in the Settings tab first.");

              // Reset button state
              const buttons = document.querySelectorAll('button.loading');
              buttons.forEach(button => {
                if (button.textContent === 'Committing...') {
                  button.classList.remove('loading');
                  button.textContent = button.dataset.originalText || 'Commit Test';
                  button.disabled = false;
                }
              });

              // Open settings modal
              openSettingsModal();
              return;
            }

            // Get commit message
            const commitMessage = `feat: add component test for ${message.componentName}`;

            // Send to plugin for commit
            parent.postMessage({
              pluginMessage: {
                type: "commit-component-test",
                projectId: window.gitlabSettings.projectId,
                gitlabToken: window.gitlabSettings.gitlabToken,
                commitMessage: commitMessage,
                componentName: message.componentName,
                testContent: message.testContent,
                testFilePath: window.gitlabSettings.testFilePath || "components/{componentName}/{componentName}.component.spec.ts",
                branchName: window.gitlabSettings.testBranchName || "feature/component-tests"
              }
            }, "*");

            // Don't reset button state yet - wait for commit response
          } else {
            // For download, just download the test
            downloadTest(message.componentName, message.testContent);

            // Show success message and reset button state
            const buttons = document.querySelectorAll('button.loading');
            buttons.forEach(button => {
              if (button.textContent === 'Generating...') {
                button.classList.remove('loading');
                // Restore the original button text
                button.textContent = button.dataset.originalText ||
                  (button.classList.contains('generate-all-variants-button') ?
                   'Generate Test for All Variants' : 'Generate Test');
                button.disabled = false;

                // Show success message
                const successMessage = button.parentElement.nextElementSibling;
                if (successMessage && successMessage.classList.contains('test-success-message')) {
                  successMessage.textContent = 'Test generated successfully!';
                  successMessage.style.display = 'block';

                  // Hide success message after 3 seconds
                  setTimeout(() => {
                    successMessage.style.display = 'none';
                  }, 3000);
                }
              }
            });
          }
        } else if (message.type === "commit-progress") {
          // Handle progress updates for GitLab operations
          const progressBar = document.getElementById("commit-progress");
          const progressStatus = document.getElementById("progress-status");

          if (progressBar && progressStatus) {
            // Update the progress bar
            progressBar.style.width = `${message.progress}%`;

            // Update the status message
            if (message.message) {
              progressStatus.textContent = message.message;
            }
          }
        } else if (message.type === "error") {
          // Optionally display errors from the plugin code
          console.error("Plugin Error:", message.message);
          alert(`Error: ${message.message}`); // Simple alert for user feedback

          // Reset button state
          const buttons = document.querySelectorAll('button.loading');
          buttons.forEach(button => {
            button.classList.remove('loading');
            // Restore the original button text
            button.textContent = button.dataset.originalText ||
              (button.classList.contains('generate-all-variants-button') ?
               'Generate Test for All Variants' : 'Generate Test');
            button.disabled = false;
          });

          exportButton.disabled = true; // Disable button on error
        } else if (message.type === "commit-success") {
          if (message.mergeRequestUrl) {
            // Show success message with merge request link
            const successHTML = `
              <div class="success-message" style="display: block;">
                ${message.message || "Successfully committed to GitLab repository!"}
              </div>
            `;

            const modal = document.getElementById("gitlab-modal");
            const footer = modal.querySelector(".modal-footer");

            // Remove any existing success message
            const existingMessage = modal.querySelector(".success-message");
            if (existingMessage) {
              existingMessage.remove();
            }

            // Insert the success message before the footer
            footer.insertAdjacentHTML("beforebegin", successHTML);

            // Change the commit button to a Close button
            const commitButton = document.getElementById("commit-submit-button");
            commitButton.textContent = "Close";
            commitButton.classList.remove("loading");
            commitButton.disabled = false;
            commitButton.onclick = closeGitLabModal;
          } else {
            // Show standard success message
            alert(message.message || "Successfully committed to GitLab repository!");
            closeGitLabModal();
            resetCommitButton();
          }
        } else if (message.type === "commit-error") {
          // Show error message with better formatting
          const errorHTML = `
            <div class="error-message" style="display: block;">
              <p><strong>Error committing to GitLab:</strong> ${message.error}</p>
              <p class="error-help">Please check your credentials and try again.</p>
            </div>
          `;

          const modal = document.getElementById("gitlab-modal");
          const footer = modal.querySelector(".modal-footer");

          // Remove any existing error message
          const existingMessage = modal.querySelector(".error-message");
          if (existingMessage) {
            existingMessage.remove();
          }

          // Insert the error message before the footer
          footer.insertAdjacentHTML("beforebegin", errorHTML);

          resetCommitButton();
        } else if (message.type === "test-commit-success") {
          // Handle successful component test commit
          console.log("Test commit success received for:", message.componentName);

          // Find any loading commit buttons and update them
          const buttons = document.querySelectorAll('button.loading');
          buttons.forEach(button => {
            if (button.textContent === 'Committing...') {
              button.classList.remove('loading');
              button.textContent = button.dataset.originalText || 'Commit Test';
              button.disabled = false;

              // Show success message
              const successMessage = button.parentElement.nextElementSibling;
              if (successMessage && successMessage.classList.contains('test-success-message')) {
                successMessage.textContent = `Successfully committed test for ${message.componentName}!`;
                successMessage.style.display = 'block';

                // Hide success message after 3 seconds
                setTimeout(() => {
                  successMessage.style.display = 'none';
                }, 3000);
              }
            }
          });

          // If no specific button was found, show an alert
          if (!document.querySelector('button.textContent="Committing..."')) {
            alert(`Successfully committed test for ${message.componentName}!`);
          }
        } else if (message.type === "unit-settings-data") {
          // Handle units settings data
          unitsData = message.data;
          renderUnitsSettings(unitsData);
        } else if (message.type === "unit-settings-updated") {
          // Handle successful unit settings update
          console.log("Received unit-settings-updated:", message);
          if (message.success) {
            // Show subtle success feedback by temporarily changing button text
            const saveButton = document.getElementById("save-units-button");
            const originalText = saveButton.textContent;
            saveButton.textContent = "Saved!";
            saveButton.style.backgroundColor = "#28a745";
            saveButton.disabled = true;
            
            // Reset button appearance after 2 seconds
            setTimeout(() => {
              saveButton.textContent = originalText;
              saveButton.style.backgroundColor = "";
            }, 2000);
          }
        }
      };

      // Render variables
      function renderVariables(data) {
        if (data.length === 0) {
          document.getElementById("variables-container").innerHTML =
            '<div class="no-items">No variables found in this document.</div>';
          return;
        }

        const container = document.getElementById("variables-container");
        let html = "";

        // Render each collection as it comes from Figma
        data.forEach(collection => {
          if (collection.variables.length > 0) {
            // Group variables by path prefix (anything before /)
            const groupedVars = new Map();
            const standaloneVars = [];
            
            collection.variables.forEach(variable => {
              const pathMatch = variable.name.match(/^([^\/]+)\//);
              if (pathMatch) {
                const prefix = pathMatch[1];
                if (!groupedVars.has(prefix)) {
                  groupedVars.set(prefix, []);
                }
                groupedVars.get(prefix).push(variable);
              } else {
                standaloneVars.push(variable);
              }
            });
            
            // Build collection HTML
            html += `
              <div class="variable-collection">
                <h3 class="collection-name">${collection.name}</h3>
            `;
            
            // Render standalone variables first
            if (standaloneVars.length > 0) {
              const varsWithCollection = standaloneVars.map(v => ({...v, collection: collection.name}));
              html += renderVariableTable(varsWithCollection);
            }
            
            // Render grouped variables
            groupedVars.forEach((variables, prefix) => {
              const displayName = prefix.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              html += `
                <div class="variable-subgroup">
                  <h4 class="subgroup-title">${displayName}</h4>
              `;
              const varsWithCollection = variables.map(v => ({...v, collection: collection.name}));
              html += renderVariableTable(varsWithCollection);
              html += '</div>';
            });
            
            html += '</div>';
          }
        });

        container.innerHTML = html;
      }


      // Render a group of variables with a title
      function renderVariableTable(variables) {
        let html = `
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Values</th>
                </tr>
              </thead>
              <tbody>
        `;

        variables.forEach((variable) => {
          const sanitizedId = variable.name.replace(/[^a-zA-Z0-9]/g, "-").toLowerCase();
          html += `
            <tr id="var-${sanitizedId}">
              <td>${variable.name}</td>
              <td>${variable.resolvedType}</td>
              <td>
          `;

          variable.valuesByMode.forEach((mode) => {
            const value = mode.value;
            const showModeName = variable.valuesByMode.length > 1;

            // Check if this is a variable alias
            if (typeof value === "object" && value.type === "VARIABLE_ALIAS") {
              const referencedVariableName = findVariableNameById(value.id);
              const sanitizedName = referencedVariableName ? referencedVariableName.replace(/[^a-zA-Z0-9]/g, "-").toLowerCase() : null;
              html += `
                <div>
                  ${showModeName ? mode.modeName + ': ' : ''}<span 
                    style="color: #007bff; font-weight: 500; cursor: pointer; text-decoration: underline;" 
                    onclick="scrollToVariable('${sanitizedName}')"
                    title="Click to jump to ${referencedVariableName}"
                  >${referencedVariableName || value.id}</span>
                </div>
              `;
            }
            // Display color values with a preview
            else if (variable.resolvedType === "COLOR" && typeof value === "object" && value.r !== undefined) {
              const r = Math.round(value.r * 255);
              const g = Math.round(value.g * 255);
              const b = Math.round(value.b * 255);
              const a = value.a !== undefined ? value.a : 1;

              html += `
                <div>
                  <span class="color-preview" style="background-color: rgba(${r},${g},${b},${a})"></span>
                  ${showModeName ? mode.modeName + ': ' : ''}rgba(${r},${g},${b},${a})
                </div>
              `;
            } else {
              html += `<div>${showModeName ? mode.modeName + ': ' : ''}${JSON.stringify(value)}</div>`;
            }
          });

          html += `
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
        `;

        return html;
      }


      // Extract component type and state from name
      function parseComponentName(name) {
        const result = {
          name: name,
          type: null,
          state: null,
        };

        // Check for Type=X pattern
        const typeMatch = name.match(/Type=([^,]+)/i);
        if (typeMatch && typeMatch[1]) {
          result.type = typeMatch[1].trim();
        }

        // Check for State=X pattern
        const stateMatch = name.match(/State=([^,]+)/i);
        if (stateMatch && stateMatch[1]) {
          result.state = stateMatch[1].trim();
        }

        return result;
      }

      // Format component styles for readability
      function formatStyles(styles) {
        if (!styles) return "";

        // Try to parse and format the JSON
        try {
          if (typeof styles === "string") {
            styles = JSON.parse(styles);
          }

          // Format the JSON with proper indentation
          const styleStr = JSON.stringify(styles, null, 2);

          // Apply syntax highlighting to the JSON
          const highlightedJson = highlightJson(styleStr);

          // Show more content in the collapsed view (up to 300 characters)
          // and add a "Click to expand" indicator
          if (styleStr.length > 300) {
            return highlightedJson.substring(0, 300) + "... (Click to expand)";
          }

          return highlightedJson;
        } catch (e) {
          return String(styles);
        }
      }

      // Function to highlight JSON syntax
      function highlightJson(json) {
        // First, ensure proper indentation for the opening brace
        json = json.replace(/^\s*{\s*/, '{\n  ');

        return json
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = 'json-key';
              } else {
                cls = 'json-string';
              }
            } else if (/true|false/.test(match)) {
              cls = 'json-boolean';
            } else if (/null/.test(match)) {
              cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
          });
      }

      // Group component variables by prefix (only real components)
      function groupComponentVariables() {
        const componentGroups = new Map();
        
        // Define what constitutes a real component prefix
        const componentPrefixes = [
          'button', 'primary-button', 'secondary-button', 'tertiary-button', 'delete-button',
          'card', 'modal', 'input', 'form', 'nav', 'header', 'footer', 'sidebar',
          'widget', 'dropdown', 'label', 'increment', 'functional', 'icon', 'ghost'
        ];
        
        // Process each variable collection to find component variables
        variablesData.forEach(collection => {
          collection.variables.forEach(variable => {
            const name = variable.name.toLowerCase();
            
            // Check if this is a component variable with prefix/path structure
            const componentMatch = name.match(/^([^\/]+)\/(.+)$/);
            if (componentMatch) {
              const [, prefix, property] = componentMatch;
              
              // Only include if the prefix matches known component types
              const isRealComponent = componentPrefixes.some(componentPrefix => 
                prefix === componentPrefix || 
                prefix.startsWith(componentPrefix + '-') ||
                prefix.endsWith('-' + componentPrefix)
              );
              
              if (isRealComponent) {
                if (!componentGroups.has(prefix)) {
                  componentGroups.set(prefix, {
                    name: prefix,
                    variables: [],
                    styles: {}
                  });
                }
                
                const group = componentGroups.get(prefix);
                group.variables.push({
                  name: variable.name,
                  property: property,
                  type: variable.resolvedType,
                  valuesByMode: variable.valuesByMode
                });
                
                // Parse property for styling
                if (property.includes('bg') && !property.includes(':')) {
                  group.styles.backgroundColor = getVariableValue(variable);
                } else if (property.includes('text') && !property.includes(':')) {
                  group.styles.color = getVariableValue(variable);
                } else if (property.includes('border-radius')) {
                  group.styles.borderRadius = getVariableValue(variable);
                } else if (property.includes('outline') && !property.includes(':')) {
                  group.styles.borderColor = getVariableValue(variable);
                } else if (property.includes('border') && !property.includes(':')) {
                  group.styles.borderColor = getVariableValue(variable);
                } else if (property.includes('horizontal-padding')) {
                  group.styles.paddingLeft = getVariableValue(variable);
                  group.styles.paddingRight = getVariableValue(variable);
                } else if (property.includes('vertical-padding')) {
                  group.styles.paddingTop = getVariableValue(variable);
                  group.styles.paddingBottom = getVariableValue(variable);
                } else if (property.includes('bg:hover')) {
                  group.styles.backgroundColorHover = getVariableValue(variable);
                } else if (property.includes('bg:active')) {
                  group.styles.backgroundColorActive = getVariableValue(variable);
                } else if (property.includes('outline:hover')) {
                  group.styles.borderColorHover = getVariableValue(variable);
                } else if (property.includes('outline:active')) {
                  group.styles.borderColorActive = getVariableValue(variable);
                } else if (property.includes('bg-opacity:disabled')) {
                  group.styles.opacityDisabled = getVariableValue(variable);
                }
              }
            }
          });
        });
        
        return Array.from(componentGroups.values());
      }
      
      // Get variable value for styling
      function getVariableValue(variable) {
        // Handle the different ways variables are structured from Figma
        let value, resolvedType;
        
        if (variable.valuesByMode && Array.isArray(variable.valuesByMode)) {
          // From component variables (array format)
          const firstMode = variable.valuesByMode[0];
          if (!firstMode) return null;
          value = firstMode.value;
          resolvedType = variable.resolvedType || variable.type;
        } else if (variable.valuesByMode && typeof variable.valuesByMode === 'object') {
          // From main variables (object format)
          const modeKeys = Object.keys(variable.valuesByMode);
          if (modeKeys.length === 0) return null;
          value = variable.valuesByMode[modeKeys[0]];
          resolvedType = variable.resolvedType;
        } else {
          return null;
        }
        
        if (typeof value === 'object' && value.type === 'VARIABLE_ALIAS') {
          // Find referenced variable and resolve recursively
          const referencedVariable = findVariableById(value.id);
          if (referencedVariable) {
            return getVariableValue(referencedVariable);
          }
          return null;
        }
        
        if (resolvedType === 'COLOR' && typeof value === 'object' && value.r !== undefined) {
          const r = Math.round(value.r * 255);
          const g = Math.round(value.g * 255);
          const b = Math.round(value.b * 255);
          const a = value.a !== undefined ? value.a : 1;
          return `rgba(${r}, ${g}, ${b}, ${a})`;
        } else if (resolvedType === 'FLOAT') {
          return `${value}px`;
        } else if (resolvedType === 'STRING') {
          return String(value);
        }
        
        return value;
      }
      
      // Find variable by ID
      function findVariableById(id) {
        for (const collection of variablesData) {
          for (const variable of collection.variables) {
            if (variable.id === id) {
              return variable;
            }
          }
        }
        return null;
      }
      
      // Render interactive component preview
      function renderComponentPreview(group) {
        const styles = group.styles;
        const name = group.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        // Determine if this is a text-only component (like labels)
        const hasBackground = styles.backgroundColor;
        const hasOutline = styles.borderColor;
        const isTextOnly = !hasBackground && !hasOutline && styles.color;
        
        // Build inline styles for the preview element
        let previewStyles = [];
        if (styles.backgroundColor) previewStyles.push(`background-color: ${styles.backgroundColor}`);
        if (styles.color) previewStyles.push(`color: ${styles.color}`);
        if (styles.borderRadius) previewStyles.push(`border-radius: ${styles.borderRadius}`);
        if (styles.borderColor) previewStyles.push(`border: 1px solid ${styles.borderColor}`);
        if (styles.paddingLeft && styles.paddingTop) {
          previewStyles.push(`padding: ${styles.paddingTop} ${styles.paddingLeft}`);
        }
        
        // For text-only components, add a subtle background to make text visible
        if (isTextOnly) {
          previewStyles.push('background-color: transparent');
          previewStyles.push('border: 1px dashed #ccc');
        }
        
        // Create hover and active styles
        let hoverStyles = [];
        if (styles.backgroundColorHover) hoverStyles.push(`background-color: ${styles.backgroundColorHover}`);
        if (styles.borderColorHover) hoverStyles.push(`border-color: ${styles.borderColorHover}`);
        
        let activeStyles = [];
        if (styles.backgroundColorActive) activeStyles.push(`background-color: ${styles.backgroundColorActive}`);
        if (styles.borderColorActive) activeStyles.push(`border-color: ${styles.borderColorActive}`);
        
        let disabledStyles = [];
        if (styles.opacityDisabled) disabledStyles.push(`opacity: ${styles.opacityDisabled}`);
        
        // Build preview elements
        let previewElements = `
          <button class="preview-element" style="${previewStyles.join('; ')}" 
            onmouseover="this.setAttribute('data-original-style', this.style.cssText); this.style.cssText = '${previewStyles.join('; ')}; ${hoverStyles.join('; ')}'"
            onmouseout="this.style.cssText = this.getAttribute('data-original-style')"
            onmousedown="this.style.cssText = '${previewStyles.join('; ')}; ${activeStyles.join('; ')}'"
            onmouseup="this.style.cssText = this.getAttribute('data-original-style')">
            ${name}
          </button>
        `;
        
        // Only show disabled state if there's a background or opacity change
        if (hasBackground || styles.opacityDisabled) {
          previewElements += `
            <button class="preview-element" style="${previewStyles.join('; ')}; ${disabledStyles.join('; ')}" disabled>
              ${name} (Disabled)
            </button>
          `;
        }
        
        // Build state labels based on available states
        let stateLabels = ['<span class="state-label">Normal</span>'];
        if (hoverStyles.length > 0) stateLabels.push('<span class="state-label">Hover</span>');
        if (activeStyles.length > 0) stateLabels.push('<span class="state-label">Active</span>');
        if ((hasBackground || styles.opacityDisabled) && disabledStyles.length > 0) {
          stateLabels.push('<span class="state-label">Disabled</span>');
        }
        
        return `
          <div class="component-preview">
            <div style="margin-bottom: 12px; font-weight: 500; color: #333;">Preview</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${previewElements}
            </div>
            <div class="state-labels">
              ${stateLabels.join('')}
            </div>
          </div>
        `;
      }
      
      // Render component variables list
      function renderComponentVariables(group) {
        const groupIndex = Math.random().toString(36).substr(2, 9);
        
        let html = `
          <div class="component-variables">
            <button class="variables-toggle" onclick="toggleVariablesList('${groupIndex}')">
              Show Variables (${group.variables.length})
            </button>
            <div class="variables-list" id="variables-${groupIndex}">
        `;
        
        group.variables.forEach(variable => {
          const displayValue = getVariableDisplayValue(variable);
          
          // Check if this variable references another variable to make it clickable
          const firstMode = variable.valuesByMode[0];
          let clickableValue = displayValue;
          
          if (firstMode && firstMode.value && typeof firstMode.value === 'object' && firstMode.value.type === 'VARIABLE_ALIAS') {
            const referencedVariable = findVariableById(firstMode.value.id);
            if (referencedVariable) {
              const sanitizedName = referencedVariable.name.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
              clickableValue = `<span style="color: #0066cc; cursor: pointer; text-decoration: underline;" onclick="scrollToVariable('${sanitizedName}')" title="Click to jump to ${referencedVariable.name}">${displayValue}</span>`;
            }
          }
          
          html += `
            <div class="variable-item">
              <span class="variable-name">${variable.name}</span>
              <span class="variable-value">${clickableValue}</span>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
        
        return html;
      }
      
      // Get display value for variable with all modes
      function getVariableDisplayValue(variable) {
        // Show all modes if there are multiple, otherwise just show the single value
        if (variable.valuesByMode.length > 1) {
          return variable.valuesByMode.map(mode => {
            const value = mode.value;
            if (typeof value === 'object' && value.type === 'VARIABLE_ALIAS') {
              const referencedVariable = findVariableById(value.id);
              return `${mode.modeName}: ${referencedVariable ? referencedVariable.name : value.id}`;
            }
            return `${mode.modeName}: ${formatSingleValue(value, variable.resolvedType)}`;
          }).join(', ');
        } else {
          const firstMode = variable.valuesByMode[0];
          if (!firstMode) return 'No value';
          
          const value = firstMode.value;
          if (typeof value === 'object' && value.type === 'VARIABLE_ALIAS') {
            const referencedVariable = findVariableById(value.id);
            return referencedVariable ? referencedVariable.name : value.id;
          }
          
          return formatSingleValue(value, variable.resolvedType);
        }
      }
      
      // Format a single variable value
      function formatSingleValue(value, resolvedType) {
        if (resolvedType === 'COLOR' && typeof value === 'object' && value.r !== undefined) {
          const r = Math.round(value.r * 255);
          const g = Math.round(value.g * 255);
          const b = Math.round(value.b * 255);
          if (value.a !== undefined && value.a < 1) {
            return `rgba(${r}, ${g}, ${b}, ${value.a.toFixed(2)})`;
          }
          return `rgb(${r}, ${g}, ${b})`;
        }
        
        if (resolvedType === 'FLOAT') {
          return `${value}px`;
        }
        
        if (resolvedType === 'STRING') {
          return `"${value}"`;
        }
        
        return String(value);
      }

      // Render components for test generation (Figma components only)
      function renderComponents(data) {
        const container = document.getElementById("components-container");
        
        if (data.length === 0) {
          container.innerHTML =
            '<div class="no-items">No components found in this document.</div>';
          return;
        }

        let html = '';
        
        // Render each component with the new enhanced design
        data.forEach((component, index) => {
          const parsedName = parseComponentName(component.name);
          const isComponentSet = component.type === "COMPONENT_SET";
          
          // Generate preview styles for the component
          const previewStyles = generateComponentPreview(component);
          
          html += `
            <div class="component-card" data-component-id="${component.id}">
              <div class="component-header" onclick="toggleComponent('${component.id}')">
                <div class="component-info">
                  <div class="component-preview" style="${previewStyles.inline}">
                    ${previewStyles.text}
                  </div>
                  <div class="component-meta">
                    <h4 class="component-name">${parsedName.name}</h4>
                    <div class="component-details">
                      <span class="component-badge ${isComponentSet ? 'set' : ''}">${isComponentSet ? 'Component Set' : 'Component'}</span>
                      ${parsedName.type ? `<span class="component-badge">${parsedName.type}</span>` : ''}
                      ${parsedName.state ? `<span class="component-badge state">${parsedName.state}</span>` : ''}
                      ${isComponentSet && component.children ? `<span class="component-badge">${component.children.length} variants</span>` : ''}
                    </div>
                  </div>
                </div>
                <div class="component-actions">
                  <div class="component-toggle" id="toggle-${component.id}">
                    <span>‚ñº</span>
                  </div>
                </div>
              </div>
              
              <div class="component-content" id="content-${component.id}">
                ${isComponentSet ? renderComponentSetContent(component) : renderSingleComponentContent(component)}
                
                <div class="component-actions-section">
                  ${renderComponentActions(component, isComponentSet)}
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
        
        // Initialize component functionality
        initializeComponentInteractions();
      }
      
      function generateComponentPreview(component) {
        try {
          let styles = component.styles;
          if (typeof styles === 'string') {
            styles = JSON.parse(styles);
          }
          
          // Extract common button-like properties
          const backgroundColor = styles['background-color'] || styles['background'] || '#f0f0f0';
          const color = styles['color'] || '#333';
          const borderRadius = styles['border-radius'] || '4px';
          const border = styles['border'] || '1px solid #e0e0e0';
          
          return {
            inline: `background: ${backgroundColor}; color: ${color}; border-radius: ${borderRadius}; border: ${border};`,
            text: component.name.length > 8 ? component.name.substring(0, 6) + '...' : component.name
          };
        } catch (e) {
          return {
            inline: 'background: #f0f0f0; color: #333; border-radius: 4px; border: 1px solid #e0e0e0;',
            text: component.name.length > 8 ? component.name.substring(0, 6) + '...' : component.name
          };
        }
      }
      
      function renderComponentSetContent(componentSet) {
        if (!componentSet.children || componentSet.children.length === 0) {
          return '<div class="component-variants"><p style="color: #666; text-align: center; margin: 0;">No variants found</p></div>';
        }
        
        // Filter to show only normal/default and disabled states
        const filteredVariants = componentSet.children.filter(variant => {
          const parsedVariant = parseComponentName(variant.name);
          const stateLower = (parsedVariant.state || '').toLowerCase();
          
          // Show default/normal states and disabled states only
          return !parsedVariant.state || 
                 stateLower.includes('default') || 
                 stateLower.includes('normal') || 
                 stateLower.includes('disabled');
        });
        
        let html = '<div class="component-variants">';
        html += '<h5 style="margin: 0 0 12px 0; color: #333; font-size: 14px;">Preview States</h5>';
        html += '<div class="variant-grid">';
        
        // If no filtered variants, show the first one as default
        const variantsToShow = filteredVariants.length > 0 ? filteredVariants : [componentSet.children[0]];
        
        variantsToShow.forEach(variant => {
          const parsedVariant = parseComponentName(variant.name);
          const previewStyles = generateComponentPreview(variant);
          const stateName = parsedVariant.state || 'Default';
          
          html += `
            <div class="variant-item">
              <div class="variant-preview" style="${previewStyles.inline}">
                ${previewStyles.text}
              </div>
              <div class="variant-name">${stateName}</div>
            </div>
          `;
        });
        
        html += '</div></div>';
        
        // Add styles section
        html += renderStylesSection(componentSet);
        
        return html;
      }
      
      function renderSingleComponentContent(component) {
        return renderStylesSection(component);
      }
      
      function renderStylesSection(component) {
        const formattedStyles = formatStyles(component.styles);
        console.log('Component styles for', component.name, ':', component.styles);
        console.log('Formatted styles:', formattedStyles);
        
        return `
          <div class="component-styles-section">
            <button class="styles-toggle" onclick="toggleComponentStyles('${component.id}')">
              <span id="styles-toggle-text-${component.id}">Show styles</span>
            </button>
            <div class="component-styles" id="styles-${component.id}" style="display: none;">
              ${formattedStyles || '<p style="color: #666; font-style: italic;">No styles available for this component</p>'}
            </div>
          </div>
        `;
      }
      
      function renderComponentActions(component, isComponentSet) {
        return `
          <button class="action-button" onclick="generateTest('${component.id}', '${component.name}', this, ${isComponentSet})">
            <span>üì•</span> Download Test
          </button>
          <button class="action-button primary" onclick="commitComponent('${component.id}', '${component.name}', ${isComponentSet})">
            <span>üöÄ</span> Commit Test
          </button>
        `;
      }
      
      function initializeComponentInteractions() {
        // Set up global functions for component interactions
        window.toggleComponent = function(componentId) {
          const content = document.getElementById(`content-${componentId}`);
          const toggle = document.getElementById(`toggle-${componentId}`);
          
          if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            toggle.classList.remove('expanded');
          } else {
            content.classList.add('expanded');
            toggle.classList.add('expanded');
          }
        };
        
        window.toggleComponentStyles = function(componentId) {
          const stylesDiv = document.getElementById(`styles-${componentId}`);
          const toggleText = document.getElementById(`styles-toggle-text-${componentId}`);
          
          if (stylesDiv.style.display === 'none') {
            stylesDiv.style.display = 'block';
            toggleText.textContent = 'Hide styles';
          } else {
            stylesDiv.style.display = 'none';
            toggleText.textContent = 'Show styles';
          }
        };
        
        window.commitComponent = function(componentId, componentName, isComponentSet) {
          console.log('Commit component:', componentId, componentName, isComponentSet);
          // Generate test for commit
          generateTest(componentId, componentName, null, isComponentSet, true);
        };
      }

      // Function to trigger CSS download
      function downloadCSS(cssString) {
        const blob = new Blob([cssString], { type: "text/css" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "figma-variables.css";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Add event listener for the export button
      document
        .getElementById("export-css-button")
        .addEventListener("click", () => {
          // Send message to plugin code to request CSS export
          parent.postMessage({
            pluginMessage: {
              type: "export-css",
              shouldDownload: true
            }
          }, "*");
        });

      // Function to generate test for a component
      function generateTest(componentId, componentName, button, generateAllVariants = false, forCommit = false) {
        // Show loading state
        button.classList.add('loading');
        const originalText = button.textContent;
        button.textContent = forCommit ? 'Committing...' : 'Generating...';
        button.disabled = true;

        // Hide any previous success messages
        const successMessage = button.parentElement.nextElementSibling;
        if (successMessage && successMessage.classList.contains('test-success-message')) {
          successMessage.style.display = 'none';
        }

        // Send message to plugin code to request test generation
        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-test",
              componentId: componentId,
              componentName: componentName,
              generateAllVariants: generateAllVariants,
              forCommit: forCommit
            },
          },
          "*"
        );

        // Store original button text for restoring later
        button.dataset.originalText = originalText;
      }

      // Function to trigger ZIP download
      function downloadComponentsZip(files, language) {
        if (!files || files.length === 0) {
          alert("No components available to export");
          return;
        }

        // Create a new JSZip instance (needs to be added in the head section)
        const zip = new JSZip();

        // Add files to the ZIP based on the selected language
        files.forEach((component) => {
          const folderName = component.kebabName;
          const folder = zip.folder(folderName);

          if (language === "angular") {
            // Add all Angular component files
            folder.file(`${folderName}.component.html`, component.angularHtml);
            folder.file(`${folderName}.component.ts`, component.angularTs);
            folder.file(
              `${folderName}.component.scss`,
              `// Styles for ${component.name}\n.${folderName} {\n  // Add your styles here\n}`
            );
          } else if (language === "typescript") {
            // Add only TypeScript file
            folder.file(`${folderName}.component.ts`, component.angularTs);
          } else if (language === "javascript") {
            // Convert TypeScript to JavaScript (basic conversion)
            const jsCode = component.angularTs
              .replace(/: [A-Za-z<>[\]]+/g, "") // Remove type annotations
              .replace(/interface [^}]+}/g, ""); // Remove interfaces

            folder.file(`${folderName}.component.js`, jsCode);
          }
        });

        // Generate and download the ZIP
        zip.generateAsync({ type: "blob" }).then((content) => {
          const url = URL.createObjectURL(content);
          const a = document.createElement("a");
          a.href = url;
          a.download = `figma-components-${language}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      // Function to download a generated test
      function downloadTest(componentName, testContent) {
        // Create a kebab case version of the component name for the file name
        const kebabName = componentName
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');

        const blob = new Blob([testContent], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${kebabName}.component.spec.ts`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Search functionality
      document
        .getElementById("variable-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          const filteredData = variablesData
            .map((collection) => {
              return {
                ...collection,
                variables: collection.variables.filter((variable) =>
                  variable.name.toLowerCase().includes(searchTerm)
                ),
              };
            })
            .filter((collection) => collection.variables.length > 0);

          renderVariables(filteredData);
        });

      document
        .getElementById("component-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          // Search in both component name and children names
          const filteredData = componentsData.filter(
            (component) =>
              component.name.toLowerCase().includes(searchTerm) ||
              (component.children &&
                component.children.some((child) =>
                  child.name.toLowerCase().includes(searchTerm)
                ))
          );

          renderComponents(filteredData);
        });

      // Function to open settings modal
      function openSettingsModal() {
        document.getElementById("settings-modal").style.display = "block";
        loadConfigurationTab(); // Load saved settings into the form
      }

      // Function to close settings modal
      function closeSettingsModal() {
        document.getElementById("settings-modal").style.display = "none";
      }

      // Function to open user guide modal
      function openUserGuide() {
        document.getElementById("user-guide-modal").style.display = "block";
      }

      // Function to close user guide modal
      function closeUserGuide() {
        document.getElementById("user-guide-modal").style.display = "none";
      }

      // Function to show reset confirmation modal
      function showResetConfirmation() {
        document.getElementById("reset-confirmation-modal").style.display = "block";
      }

      // Function to close reset confirmation modal
      function closeResetConfirmation() {
        document.getElementById("reset-confirmation-modal").style.display = "none";
      }

      // Function to confirm and execute reset
      function confirmReset() {
        // Clear local settings
        window.gitlabSettings = null;

        // Send reset command to backend
        parent.postMessage({
          pluginMessage: {
            type: "reset-gitlab-settings"
          },
        }, "*");

        // Clear all form fields
        document.getElementById("config-project-id").value = "";
        document.getElementById("config-file-path").value = "src/variables.css";
        document.getElementById("config-test-file-path").value = "components/{componentName}/{componentName}.component.spec.ts";
        document.getElementById("config-token").value = "";
        document.getElementById("config-strategy").value = "merge-request";
        document.getElementById("config-branch").value = "feature/variables";
        document.getElementById("config-test-branch").value = "feature/component-tests";
        document.getElementById("config-save-token").checked = true;
        document.getElementById("config-share-team").checked = true;

        // Hide metadata
        document.getElementById("config-metadata").style.display = "none";

        // Close both modals
        closeResetConfirmation();
        closeSettingsModal();

        alert("Configuration has been reset successfully!");
      }

      // Function to check if user guide should auto-open
      function checkAndShowUserGuide() {
        // Show guide if no project ID is configured (first-time user)
        if (!window.gitlabSettings || !window.gitlabSettings.projectId) {
          setTimeout(() => {
            openUserGuide();
          }, 500); // Small delay to ensure UI is loaded
        }
      }

      // Function to save configuration settings
      function saveConfiguration() {
        const projectId = document.getElementById("config-project-id").value.trim();
        const filePath = document.getElementById("config-file-path").value.trim() || "src/variables.css";
        const testFilePath = document.getElementById("config-test-file-path").value.trim() || "components/{componentName}/test.spec.ts";
        const token = document.getElementById("config-token").value.trim();
        const strategy = document.getElementById("config-strategy").value;
        const branch = document.getElementById("config-branch").value.trim() || "feature/variables";
        const testBranch = document.getElementById("config-test-branch").value.trim() || "feature/component-tests";
        const saveToken = document.getElementById("config-save-token").checked;
        const shareTeam = document.getElementById("config-share-team").checked;

        if (!projectId) {
          alert("Please provide a Project ID");
          return;
        }

        if (!token) {
          alert("Please provide a Project Access Token");
          return;
        }

        // Update local settings immediately
        window.gitlabSettings = {
          projectId: projectId,
          filePath: filePath,
          testFilePath: testFilePath,
          gitlabToken: token,
          strategy: strategy,
          branchName: branch,
          testBranchName: testBranch,
          saveToken: saveToken,
          isPersonal: !shareTeam,
          savedAt: new Date().toISOString(),
          savedBy: "Current user"
        };

        // Save the configuration to backend
        parent.postMessage({
          pluginMessage: {
            type: "save-gitlab-settings",
            projectId: projectId,
            filePath: filePath,
            testFilePath: testFilePath,
            gitlabToken: token,
            strategy: strategy,
            branchName: branch,
            testBranchName: testBranch,
            saveToken: saveToken,
            shareWithTeam: shareTeam
          },
        }, "*");

        // Update metadata display
        displayConfigMetadata();

        alert("Configuration saved successfully!");
        closeSettingsModal();
      }

      // Function to load configuration into the Config tab
      function loadConfigurationTab() {
        if (window.gitlabSettings) {
          document.getElementById("config-project-id").value = window.gitlabSettings.projectId || "";
          document.getElementById("config-file-path").value = window.gitlabSettings.filePath || "src/variables.css";
          document.getElementById("config-test-file-path").value = window.gitlabSettings.testFilePath || "components/{componentName}/{componentName}.component.spec.ts";
          document.getElementById("config-token").value = window.gitlabSettings.gitlabToken || "";
          document.getElementById("config-strategy").value = window.gitlabSettings.strategy || "merge-request";
          document.getElementById("config-branch").value = window.gitlabSettings.branchName || "feature/variables";
          document.getElementById("config-test-branch").value = window.gitlabSettings.testBranchName || "feature/component-tests";

          // Handle checkboxes with proper defaults
          document.getElementById("config-save-token").checked = window.gitlabSettings.hasOwnProperty('saveToken') ? window.gitlabSettings.saveToken : true;
          document.getElementById("config-share-team").checked = window.gitlabSettings.hasOwnProperty('isPersonal') ? !window.gitlabSettings.isPersonal : true;

          // Show/hide branch fields based on strategy
          const strategy = document.getElementById("config-strategy").value;
          const display = strategy === "merge-request" ? "block" : "none";

          document.getElementById("config-branch-section").style.display = display;
          document.getElementById("config-test-branch-section").style.display = display;

          // Display metadata if available
          displayConfigMetadata();
        } else {
          // No settings exist - ensure defaults are set
          document.getElementById("config-save-token").checked = true;
          document.getElementById("config-share-team").checked = true;
        }
      }

      // Function to display configuration metadata
      function displayConfigMetadata() {
        const metadataElement = document.getElementById("config-metadata");
        const metadataTextElement = document.getElementById("config-metadata-text");

        if (window.gitlabSettings && (window.gitlabSettings.savedAt || window.gitlabSettings.savedBy)) {
          metadataElement.style.display = "block";

          let metadataText = "";

          if (window.gitlabSettings.savedAt) {
            const savedDate = new Date(window.gitlabSettings.savedAt);
            const formattedDate = savedDate.toLocaleDateString();
            const formattedTime = savedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            metadataText += `Last saved: ${formattedDate} at ${formattedTime}`;
          }

          if (window.gitlabSettings.savedBy) {
            metadataText += window.gitlabSettings.savedAt ? ` by ${window.gitlabSettings.savedBy}` : `Saved by: ${window.gitlabSettings.savedBy}`;
          }

          if (window.gitlabSettings.isPersonal) {
            metadataText += " (Personal settings)";
          } else {
            metadataText += " (Shared with team)";
          }

          metadataTextElement.textContent = metadataText;
        } else {
          metadataElement.style.display = "none";
        }
      }

      // Function to toggle the display of GitLab credentials fields
      function toggleGitLabCredentialsFields() {
        const fieldsSection = document.getElementById("gitlab-credentials-fields");
        const summarySection = document.getElementById("gitlab-credentials-summary");
        const securityNoteCompact = document.getElementById("security-note-compact");
        const securityNoteFull = document.getElementById("security-note-full");

        if (fieldsSection.style.display === "none") {
          // Show the fields and full security note
          fieldsSection.style.display = "block";
          summarySection.style.display = "none";
          securityNoteCompact.style.display = "none";
          securityNoteFull.style.display = "block";
        } else {
          // Only hide if we have values to display in summary
          const projectId = document.getElementById("gitlab-project-id").value;
          if (projectId) {
            fieldsSection.style.display = "none";
            summarySection.style.display = "block";
            securityNoteCompact.style.display = "block";
            securityNoteFull.style.display = "none";

            // Update the display values
            document.getElementById("project-id-display").textContent = projectId;
          }
        }
      }

      // Function to open the GitLab modal and populate with saved settings if available
      function openGitLabModal() {
        document.getElementById("gitlab-modal").style.display = "block";

        // Reset display state
        const fieldsSection = document.getElementById("gitlab-credentials-fields");
        const summarySection = document.getElementById("gitlab-credentials-summary");
        const securityNoteCompact = document.getElementById("security-note-compact");
        const securityNoteFull = document.getElementById("security-note-full");

        fieldsSection.style.display = "block";
        summarySection.style.display = "none";
        securityNoteCompact.style.display = "none";
        securityNoteFull.style.display = "block";

        // Check if we have saved settings
        if (window.gitlabSettings) {
          // Fill in the project ID
          if (window.gitlabSettings.projectId) {
            const projectIdField = document.getElementById("gitlab-project-id");
            projectIdField.value = window.gitlabSettings.projectId;

            // Update the display text
            document.getElementById("project-id-display").textContent = window.gitlabSettings.projectId;
          }

          // Fill in the token if it was saved
          if (window.gitlabSettings.gitlabToken) {
            document.getElementById("gitlab-token").value = window.gitlabSettings.gitlabToken;
            document.getElementById("save-token").checked = true;
          }

          // Fill in the branch name if it was saved
          if (window.gitlabSettings.branchName) {
            document.getElementById("branch-name").value = window.gitlabSettings.branchName;
          }

          // Check "share with team" if this came from team storage
          if (!window.gitlabSettings.isPersonal) {
            document.getElementById("share-with-team").checked = true;
          }

          // Show saved info if available
          if (window.gitlabSettings.savedBy && window.gitlabSettings.savedAt) {
            const savedDate = new Date(window.gitlabSettings.savedAt);
            const formattedDate = savedDate.toLocaleDateString() + ' ' + savedDate.toLocaleTimeString();
            const savedInfoText = `Last updated by: <strong>${window.gitlabSettings.savedBy}</strong> on ${formattedDate}`;

            // Update the compact security note
            securityNoteCompact.innerHTML = savedInfoText;

            // Update the full security note
            const savedInfoDiv = securityNoteFull.querySelector('.saved-info');
            if (savedInfoDiv) {
              savedInfoDiv.innerHTML = savedInfoText;
            }
          }

          // If project ID exists, show the summary view instead of fields
          if (window.gitlabSettings.projectId) {
            fieldsSection.style.display = "none";
            summarySection.style.display = "block";
            securityNoteCompact.style.display = "block";
            securityNoteFull.style.display = "none";
          }
        }

        // Add click event listener to the settings button
        document.getElementById("settings-button").onclick = toggleGitLabCredentialsFields;
      }

      // Function to close the GitLab modal
      function closeGitLabModal() {
        const modal = document.getElementById("gitlab-modal");
        if (modal) {
          // Remove any success or error messages
          const successMessage = modal.querySelector(".success-message");
          if (successMessage) {
            successMessage.remove();
          }
          const errorMessage = modal.querySelector(".error-message");
          if (errorMessage) {
            errorMessage.remove();
          }
          
          modal.style.display = "none";
        }
        resetCommitButton();
      }

      // Function to reset the commit button state
      function resetCommitButton() {
        const button = document.getElementById("commit-submit-button");
        if (button) {
          button.textContent = "Commit";
          button.disabled = false;
          button.onclick = commitToGitLab; // Reset the onclick handler
        }
      }

      // Function to commit to GitLab
      function commitToGitLab() {
        const button = document.getElementById("commit-submit-button");

        // Show loading state with spinner
        button.disabled = true;
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px; animation: spin 1s linear infinite;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="31.416" stroke-dashoffset="31.416" opacity="0.3"/>
            <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"/>
          </svg>
          Committing...
        `;

        // Check if we have saved configuration
        if (!window.gitlabSettings || !window.gitlabSettings.projectId || !window.gitlabSettings.gitlabToken) {
          alert("Please configure your GitLab settings in the Config tab first.");
          resetCommitButton();
          return;
        }

        // Get values from saved configuration
        const projectId = window.gitlabSettings.projectId;
        const gitlabToken = window.gitlabSettings.gitlabToken;
        const filePath = window.gitlabSettings.filePath || "src/variables.css";
        const strategy = window.gitlabSettings.strategy || "merge-request";
        const branchName = window.gitlabSettings.branchName || "feature/variables";

        // Debug: Log the branch name being used
        console.log("Using branch name for commit:", branchName);
        console.log("GitLab settings:", window.gitlabSettings);

        // Get commit message from the modal
        const commitMessage = document.getElementById("commit-message").value.trim() || "feat: update CSS variables";

        // Determine if this should create a merge request based on strategy
        const createMergeRequest = strategy === "merge-request";
        let mrTitle = commitMessage;
        let mrDescription = "Updated CSS variables from Figma";
        let mrRemoveSourceBranch = true;
        let mrSquash = false;

        // Settings are already saved, no need to save again

        // First, ensure we have the latest CSS data
        if (!currentCSSData) {
          // Request CSS export first
          parent.postMessage({ pluginMessage: { type: "export-css" } }, "*");

          // Wait for CSS data to be available
          const checkCSSData = setInterval(() => {
            if (currentCSSData) {
              clearInterval(checkCSSData);

              // Now that we have CSS data, proceed with the commit
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "commit-to-gitlab",
                    projectId,
                    gitlabToken,
                    commitMessage,
                    filePath,
                    branchName,
                    cssData: currentCSSData,
                    createMergeRequest,
                    mrTitle,
                    mrDescription,
                    mrRemoveSourceBranch,
                    mrSquash
                  },
                },
                "*"
              );
            }
          }, 100);

          // Set a timeout in case CSS generation fails
          setTimeout(() => {
            if (!currentCSSData) {
              clearInterval(checkCSSData);
              alert("Failed to generate CSS data. Please try again.");
              resetCommitButton();
            }
          }, 5000);
        } else {
          // If we already have CSS data, proceed with the commit
          parent.postMessage(
            {
              pluginMessage: {
                type: "commit-to-gitlab",
                projectId,
                gitlabToken,
                commitMessage,
                filePath,
                branchName,
                cssData: currentCSSData,
                createMergeRequest,
                mrTitle,
                mrDescription,
                mrRemoveSourceBranch,
                mrSquash
              },
            },
            "*"
          );
        }
      }

      // Units-related functions
      function loadUnitsSettings() {
        parent.postMessage({
          pluginMessage: {
            type: "get-unit-settings"
          }
        }, "*");
      }
      
      function renderUnitsSettings(data) {
        const container = document.getElementById("units-settings-container");
        
        if (!data || (data.collections.length === 0 && data.groups.length === 0)) {
          container.innerHTML = '<div class="no-items">No collections or groups found for unit configuration.</div>';
          return;
        }
        
        let html = '';
        
        // Collections section
        if (data.collections.length > 0) {
          html += `
            <div class="units-section">
              <h4>Collections</h4>
              <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Set default units for entire collections. These override global defaults.</p>
          `;
          
          data.collections.forEach(collection => {
            html += `
              <div class="unit-setting-row">
                <div class="unit-setting-label">${collection.name}</div>
                <div class="unit-setting-control">
                  <span class="default-unit-label">Default: ${collection.defaultUnit}</span>
                  <select class="unit-dropdown" data-type="collection" data-name="${collection.name}">
                    ${AVAILABLE_UNITS.map(unit => 
                      `<option value="${unit}" ${unit === collection.currentUnit ? 'selected' : ''}>${unit === '' ? 'Smart defaults' : unit}</option>`
                    ).join('')}
                  </select>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
        }
        
        // Groups section
        if (data.groups.length > 0) {
          html += `
            <div class="units-section">
              <h4>Groups</h4>
              <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Set specific units for variable groups. These override collection settings.</p>
          `;
          
          // Group by collection
          const groupsByCollection = {};
          data.groups.forEach(group => {
            if (!groupsByCollection[group.collectionName]) {
              groupsByCollection[group.collectionName] = [];
            }
            groupsByCollection[group.collectionName].push(group);
          });
          
          Object.keys(groupsByCollection).sort().forEach(collectionName => {
            html += `
              <div class="units-group">
                <h5>${collectionName}</h5>
            `;
            
            groupsByCollection[collectionName].forEach(group => {
              html += `
                <div class="unit-setting-row">
                  <div class="unit-setting-label">${group.groupName}</div>
                  <div class="unit-setting-control">
                    <span class="default-unit-label">Default: ${group.defaultUnit}</span>
                    <select class="unit-dropdown" data-type="group" data-collection="${group.collectionName}" data-group="${group.groupName}">
                      ${AVAILABLE_UNITS.map(unit => 
                        `<option value="${unit}" ${unit === group.currentUnit ? 'selected' : ''}>${unit === '' ? 'Smart defaults' : unit}</option>`
                      ).join('')}
                    </select>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          });
          
          html += '</div>';
        }
        
        // Add smart defaults explanation section at the end
        html += `
          <div class="units-section" style="background: #f0f7ff; border: 1px solid #b3d9ff;">
            <h4 style="color: #0d99ff;">üìã Smart Default Rules</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
              When no custom unit is set, these rules determine the unit automatically based on variable names:
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <h5 style="margin-bottom: 8px; color: #555;">Unitless Values</h5>
                <div style="font-family: monospace; font-size: 12px; line-height: 1.4;">
                  <div><code>opacity</code> ‚Üí <span style="color: #666;">none</span></div>
                  <div><code>z-index</code> ‚Üí <span style="color: #666;">none</span></div>
                  <div><code>line-height</code> ‚Üí <span style="color: #666;">none</span></div>
                  <div><code>font-weight</code> ‚Üí <span style="color: #666;">none</span></div>
                  <div><code>flex</code> ‚Üí <span style="color: #666;">none</span></div>
                  <div><code>order</code> ‚Üí <span style="color: #666;">none</span></div>
                </div>
              </div>
              
              <div>
                <h5 style="margin-bottom: 8px; color: #555;">Default</h5>
                <div style="font-family: monospace; font-size: 12px; line-height: 1.4;">
                  <div><code>everything else</code> ‚Üí <span style="color: #666;">px</span></div>
                  <div style="color: #888; font-size: 11px; margin-top: 4px;">width, height, border, padding, margin, radius, gap, etc.</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: rgba(13, 153, 255, 0.1); border-radius: 6px; font-size: 13px; color: #0a85e9;">
              <strong>Examples:</strong> 
              <code>button-opacity</code> ‚Üí none, 
              <code>min-width-s</code> ‚Üí px, 
              <code>border-radius</code> ‚Üí px, 
              <code>gap-large</code> ‚Üí px
            </div>
          </div>
        `;
        
        container.innerHTML = html;
        
        // Add event listeners to dropdowns
        document.querySelectorAll('.unit-dropdown').forEach(dropdown => {
          dropdown.addEventListener('change', function() {
            console.log("Dropdown changed, enabling save button");
            const saveButton = document.getElementById("save-units-button");
            if (saveButton) {
              saveButton.disabled = false;
              console.log("Save button enabled");
            } else {
              console.error("Save button not found!");
            }
          });
        });
      }
      
      // Functions moved to window object at end of script

      // Add event listener for the commit button
      document
        .getElementById("commit-repo-button")
        .addEventListener("click", openGitLabModal);

      // Toggle merge request options when checkbox is clicked
      document.getElementById("create-merge-request").addEventListener("change", function() {
        const mergeRequestOptions = document.getElementById("merge-request-options");
        if (this.checked) {
          mergeRequestOptions.style.display = "block";

          // Pre-fill the merge request title with the commit message
          const commitMessage = document.getElementById("commit-message").value;
          if (commitMessage) {
            document.getElementById("mr-title").value = commitMessage;
          }
        } else {
          mergeRequestOptions.style.display = "none";
        }
      });

      // Update MR title when commit message changes if checkbox is checked
      document.getElementById("commit-message").addEventListener("input", function() {
        const createMR = document.getElementById("create-merge-request");
        if (createMR.checked) {
          document.getElementById("mr-title").value = this.value;
        }
      });

      // Add event listener for strategy dropdown in Config tab
      document.getElementById("config-strategy").addEventListener("change", function() {
        const branchSection = document.getElementById("config-branch-section");
        const testBranchSection = document.getElementById("config-test-branch-section");

        const display = this.value === "merge-request" ? "block" : "none";
        branchSection.style.display = display;
        testBranchSection.style.display = display;
      });

      // Add basic click debugging
      document.addEventListener("click", function(event) {
        console.log("GLOBAL CLICK:", event.target.id, event.target.tagName, event.target.textContent);
      });
    </script>
  </body>
</html>
