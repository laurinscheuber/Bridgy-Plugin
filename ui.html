<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>aWall Synch UI</title>
    <!-- Add JSZip library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 20px;
        color: #333;
        background-color: #f7f8fa;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .section {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        background-color: #fff;
      }
      h2 {
        margin-top: 0;
        color: #333;
        font-size: 20px;
        font-weight: 600;
      }
      h3 {
        margin-top: 16px;
        margin-bottom: 8px;
        color: #555;
        font-size: 16px;
        font-weight: 500;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 16px;
        background-color: #fff;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab {
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .tab:hover {
        background-color: #f0f7ff;
      }
      .tab.active {
        border-bottom: 2px solid #0d99ff;
        color: #0d99ff;
        background-color: #f0f7ff;
      }
      .tab-content {
        display: none;
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab-content.active {
        display: block;
      }
      .variable-collection {
        margin-bottom: 24px;
        background: #f9f9f9;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #eaeaea;
      }
      .collection-name {
        font-weight: 600;
        margin-bottom: 12px;
        color: #444;
        font-size: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        background-color: #fff;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      th {
        text-align: left;
        background-color: #f3f4f6;
        padding: 10px 12px;
        font-weight: 500;
        color: #444;
        border-bottom: 1px solid #e5e7eb;
      }
      td {
        padding: 10px 12px;
        border-top: 1px solid #eee;
        vertical-align: top;
      }
      tr:hover td {
        background-color: #f9fafb;
      }
      .color-preview {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .search-container {
        margin-bottom: 16px;
      }
      .search-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .search-input:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }
      .component-list {
        max-height: 700px;
        overflow-y: auto;
        border-radius: 6px;
        background-color: #fff;
        border: 1px solid #eaeaea;
      }
      .component-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .component-item:hover {
        background-color: #f5f5f5;
      }
      .no-items {
        color: #999;
        font-style: italic;
        padding: 24px;
        text-align: center;
        background-color: #f9f9f9;
        border-radius: 6px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #777;
        background-color: #f9f9f9;
        border-radius: 6px;
      }
      .loading:after {
        content: "...";
        animation: dots 1.5s steps(5, end) infinite;
      }
      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }
      /* Component hierarchy styling */
      .component-set {
        background-color: #f8f9fa;
        margin-bottom: 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .component-set-header {
        cursor: pointer;
        padding: 12px;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
      }
      .component-set-header:hover {
        background-color: #edf2f7;
      }
      .component-set-toggle {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #0d99ff;
        background-color: #e1f0ff;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .component-set-header.expanded .component-set-toggle {
        transform: rotate(90deg);
      }
      .component-set-children {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .component-set-children.expanded {
        max-height: 1000px;
      }
      .child-component {
        border-left: 3px solid #0d99ff;
        margin: 0 0 0 20px;
        background-color: #fafbfc;
      }
      .component-set-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 8px;
        padding-left: 20px;
      }
      .child-component table {
        box-shadow: none;
        border-radius: 0;
      }
      /* Type and state badges */
      .badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        margin-right: 8px;
      }
      .badge-component {
        background-color: #e1f0ff;
        color: #0d99ff;
      }
      .badge-component-set {
        background-color: #c9f7f0;
        color: #0a9882;
      }
      .badge-state {
        background-color: #f0e6ff;
        color: #7e3ff2;
      }
      .badge-type {
        background-color: #fff2e0;
        color: #ff8c00;
      }
      /* Component info layout */
      .component-name {
        font-weight: 500;
        margin-right: 10px;
      }
      .component-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
      }
      .component-styles {
        margin-top: 8px;
        padding: 8px;
        background-color: #f5f7f9;
        border-radius: 4px;
        font-size: 12px;
        color: #555;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        font-family: monospace;
      }
      .component-styles.expanded {
        white-space: pre-wrap;
        overflow: auto;
        max-height: 400px;
        border: 1px solid #e0e0e0;
        padding: 12px;
        background-color: #f9f9f9;
      }
      .close-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 10px;
        cursor: pointer;
        display: none;
      }
      .component-styles.expanded .close-button {
        display: block;
      }
      .json-key {
        color: #881391;
      }
      .json-string {
        color: #1a1aa6;
      }
      .json-number {
        color: #1c00cf;
      }
      .json-boolean {
        color: #0033b3;
      }
      .json-null {
        color: #808080;
      }
      /* Button styling */
      button {
        padding: 10px 16px;
        background-color: #0d99ff;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #0a85e9;
      }
      button:disabled {
        background-color: #c8d3dc;
        cursor: not-allowed;
      }
      .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .generate-test-button {
        background-color: #4caf50;
      }
      .generate-test-button:hover {
        background-color: #3d8b40;
      }
      .generate-test-button.loading {
        background-color: #9e9e9e;
        cursor: wait;
      }
      .generate-all-variants-button {
        background-color: #e91e63;
      }
      .generate-all-variants-button:hover {
        background-color: #c2185b;
      }
      .test-success-message {
        background-color: #e8f5e9;
        color: #2e7d32;
        padding: 8px 12px;
        border-radius: 4px;
        margin-top: 8px;
        font-size: 14px;
        display: none;
      }
      select {
        padding: 9px 12px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        background-color: white;
        font-size: 14px;
      }
      
      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      
      .modal-content {
        position: relative;
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .modal-header {
        margin-bottom: 20px;
      }
      
      .modal-header h3 {
        margin: 0;
        color: #333;
      }
      
      .modal-body {
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }
      
      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .form-group input:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }
      
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
      }
      
      .close-modal:hover {
        color: #333;
      }
      
      .commit-button {
        background-color: #4caf50;
      }
      
      .commit-button:hover {
        background-color: #3d8b40;
      }
      
      .commit-button.loading {
        background-color: #9e9e9e;
        cursor: wait;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>aWall Synch</h2>

      <div class="tabs">
        <div class="tab active" data-tab="variables">Variables</div>
        <div class="tab" data-tab="components">Components</div>
      </div>

      <div class="tab-content active" id="variables-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="variable-search"
            placeholder="Search variables..."
          />
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
          <button id="export-css-button" disabled>
            Export Variables as CSS
          </button>
          <button id="commit-repo-button" disabled>
            Commit to Repository
          </button>
        </div>
        <div id="variables-container">
          <div class="loading">Loading variables</div>
        </div>
      </div>

      <div class="tab-content" id="components-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="component-search"
            placeholder="Search components..."
          />
        </div>

        <div id="components-container">
          <div class="loading">Loading components</div>
        </div>
      </div>
    </div>

    <!-- GitLab Commit Modal -->
    <div id="gitlab-modal" class="modal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeGitLabModal()">&times;</button>
        <div class="modal-header">
          <h3>Commit to GitLab Repository</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="gitlab-project-id">GitLab Project ID</label>
            <input type="text" id="gitlab-project-id" placeholder="e.g. 24267" />
          </div>
          <div class="form-group">
            <label for="gitlab-token">Private Token</label>
            <input type="password" id="gitlab-token" placeholder="Enter your GitLab private token" />
          </div>
          <div class="form-group">
            <label for="commit-message">Commit Message</label>
            <input type="text" id="commit-message" placeholder="feat: update variables" />
          </div>
          <div class="form-group">
            <label for="file-path">File Path (optional)</label>
            <input type="text" id="file-path" placeholder="src/styles/variables.css" />
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="closeGitLabModal()">Cancel</button>
          <button id="commit-submit-button" class="commit-button" onclick="commitToGitLab()">Commit</button>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          tab.classList.add("active");
          document
            .getElementById(tab.dataset.tab + "-content")
            .classList.add("active");
        });
      });

      // Store data
      let variablesData = [];
      let componentsData = [];
      let currentCSSData = null;

      // Listen for messages from the plugin
      window.onmessage = (event) => {
        const message = event.data.pluginMessage;
        const exportButton = document.getElementById("export-css-button");
        const commitButton = document.getElementById("commit-repo-button");

        if (message.type === "document-data") {
          variablesData = message.variablesData;
          componentsData = message.componentsData;

          renderVariables(variablesData);
          renderComponents(componentsData);

          // Enable the export button only if there are variables
          if (
            variablesData &&
            variablesData.some((collection) => collection.variables.length > 0)
          ) {
            exportButton.disabled = false;
            commitButton.disabled = false;
          } else {
            exportButton.disabled = true;
            commitButton.disabled = true;
          }
        } else if (message.type === "css-export") {
          // Store the CSS data for later use
          currentCSSData = message.cssData;
          // Trigger download when CSS data is received
          downloadCSS(message.cssData);
        } else if (message.type === "angular-export-data") {
          // Trigger ZIP download with component data based on selected language
          const language = message.language || "angular";
          downloadComponentsZip(message.files, language);
        } else if (message.type === "test-generated") {
          // Download the generated test
          downloadTest(message.componentName, message.testContent);

          // Show success message
          const buttons = document.querySelectorAll('button.loading');
          buttons.forEach(button => {
            if (button.textContent === 'Generating...') {
              button.classList.remove('loading');
              // Restore the original button text
              button.textContent = button.dataset.originalText ||
                (button.classList.contains('generate-all-variants-button') ?
                 'Generate Test for All Variants' : 'Generate Test');
              button.disabled = false;

              // Show success message
              const successMessage = button.parentElement.nextElementSibling;
              if (successMessage && successMessage.classList.contains('test-success-message')) {
                successMessage.style.display = 'block';

                // Hide success message after 3 seconds
                setTimeout(() => {
                  successMessage.style.display = 'none';
                }, 3000);
              }
            }
          });
        } else if (message.type === "error") {
          // Optionally display errors from the plugin code
          console.error("Plugin Error:", message.message);
          alert(`Error: ${message.message}`); // Simple alert for user feedback

          // Reset button state
          const buttons = document.querySelectorAll('button.loading');
          buttons.forEach(button => {
            button.classList.remove('loading');
            // Restore the original button text
            button.textContent = button.dataset.originalText ||
              (button.classList.contains('generate-all-variants-button') ?
               'Generate Test for All Variants' : 'Generate Test');
            button.disabled = false;
          });
          
          exportButton.disabled = true; // Disable button on error
        } else if (message.type === "commit-success") {
          // Show success message
          alert("Successfully committed to GitLab repository!");
          closeGitLabModal();
          resetCommitButton();
        } else if (message.type === "commit-error") {
          // Show error message
          alert(`Error committing to GitLab: ${message.error}`);
          resetCommitButton();
        }
      };

      // Render variables
      function renderVariables(data) {
        const container = document.getElementById("variables-container");

        if (data.length === 0) {
          container.innerHTML =
            '<div class="no-items">No variables found in this document.</div>';
          return;
        }

        let html = "";

        data.forEach((collection) => {
          html += `
          <div class="variable-collection">
            <div class="collection-name">${collection.name}</div>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Values</th>
                </tr>
              </thead>
              <tbody>
        `;

          if (collection.variables.length === 0) {
            html += `<tr><td colspan="3">No variables in this collection</td></tr>`;
          } else {
            collection.variables.forEach((variable) => {
              html += `
              <tr>
                <td>${variable.name}</td>
                <td>${variable.resolvedType}</td>
                <td>
            `;

              variable.valuesByMode.forEach((mode) => {
                const value = mode.value;

                // Display color values with a preview
                if (
                  variable.resolvedType === "COLOR" &&
                  typeof value === "object" &&
                  value.r !== undefined
                ) {
                  const r = Math.round(value.r * 255);
                  const g = Math.round(value.g * 255);
                  const b = Math.round(value.b * 255);
                  const a = value.a !== undefined ? value.a : 1;

                  html += `
                  <div>
                    <span class="color-preview" style="background-color: rgba(${r},${g},${b},${a})"></span>
                    ${mode.modeName}: rgba(${r},${g},${b},${a})
                  </div>
                `;
                } else {
                  html += `<div>${mode.modeName}: ${JSON.stringify(
                    value
                  )}</div>`;
                }
              });

              html += `
                </td>
              </tr>
            `;
            });
          }

          html += `
              </tbody>
            </table>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      // Extract component type and state from name
      function parseComponentName(name) {
        const result = {
          name: name,
          type: null,
          state: null,
        };

        // Check for Type=X pattern
        const typeMatch = name.match(/Type=([^,]+)/i);
        if (typeMatch && typeMatch[1]) {
          result.type = typeMatch[1].trim();
        }

        // Check for State=X pattern
        const stateMatch = name.match(/State=([^,]+)/i);
        if (stateMatch && stateMatch[1]) {
          result.state = stateMatch[1].trim();
        }

        return result;
      }

      // Format component styles for readability
      function formatStyles(styles) {
        if (!styles) return "";

        // Try to parse and format the JSON
        try {
          if (typeof styles === "string") {
            styles = JSON.parse(styles);
          }

          // Format the JSON with proper indentation
          const styleStr = JSON.stringify(styles, null, 2);
          
          // Apply syntax highlighting to the JSON
          const highlightedJson = highlightJson(styleStr);
          
          // Show more content in the collapsed view (up to 300 characters)
          // and add a "Click to expand" indicator
          if (styleStr.length > 300) {
            return highlightedJson.substring(0, 300) + "... (Click to expand)";
          }
          
          return highlightedJson;
        } catch (e) {
          return String(styles);
        }
      }
      
      // Function to highlight JSON syntax
      function highlightJson(json) {
        // First, ensure proper indentation for the opening brace
        json = json.replace(/^\s*{\s*/, '{\n  ');
        
        return json
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = 'json-key';
              } else {
                cls = 'json-string';
              }
            } else if (/true|false/.test(match)) {
              cls = 'json-boolean';
            } else if (/null/.test(match)) {
              cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
          });
      }

      // Render components in hierarchical view
      function renderComponents(data) {
        const container = document.getElementById("components-container");

        if (data.length === 0) {
          container.innerHTML =
            '<div class="no-items">No components found in this document.</div>';
          return;
        }

        let html = `<div class="component-list">`;

        // Render each component with hierarchy
        data.forEach((component, index) => {
          if (component.type === "COMPONENT_SET") {
            // Parse the component set name to extract type information
            const parsedName = parseComponentName(component.name);

            // For component sets, create an expandable section
            html += `
            <div class="component-set">
              <div class="component-set-header" data-index="${index}" onclick="toggleComponentSet(${index})">
                <div class="component-set-toggle">+</div>
                <div class="component-meta">
                  <span class="component-name">${parsedName.name}</span>
                  <span class="badge badge-component-set">Component Set</span>
                  ${
                    parsedName.type
                      ? `<span class="badge badge-type">${parsedName.type}</span>`
                      : ""
                  }
                </div>
              </div>
              <div class="component-set-actions">
                <button class="generate-all-variants-button" onclick="event.stopPropagation(); generateTest('${component.id}', '${component.name}', this, true)">Generate Test for All Variants</button>
                <div class="test-success-message">Test generated successfully!</div>
              </div>
              <div class="component-set-children" id="children-${index}">
            `;

            // Render child components
            if (component.children && component.children.length > 0) {
              component.children.forEach((child) => {
                // Parse the child component name to extract type and state
                const childParsed = parseComponentName(child.name);

                html += `
                <div class="child-component">
                  <table style="width: 100%;">
                    <tbody>
                      <tr>
                        <td>
                          <div class="component-meta">
                            <span class="component-name">${
                              childParsed.name
                            }</span>
                            <span class="badge badge-component">Component</span>
                            ${
                              childParsed.type
                                ? `<span class="badge badge-type">${childParsed.type}</span>`
                                : ""
                            }
                            ${
                              childParsed.state
                                ? `<span class="badge badge-state">${childParsed.state}</span>`
                                : ""
                            }
                          </div>
                          <div class="component-styles" onclick="toggleStyles(this)">
                            ${formatStyles(child.styles)}
                            <button class="close-button" onclick="event.stopPropagation(); toggleStyles(this.parentElement)">Close</button>
                          </div>
                          <div class="action-buttons">
                            <button class="generate-test-button" onclick="generateTest('${child.id}', '${child.name}', this)">Generate Test</button>
                          </div>
                          <div class="test-success-message">Test generated successfully!</div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              `;
              });
            } else {
              html += `<div class="child-component"><div class="no-items">No child components</div></div>`;
            }

            html += `
                </div>
              </div>
            `;
          } else {
            // Parse the standalone component name
            const parsedName = parseComponentName(component.name);

            // For regular components, render normally
            html += `
            <div class="component-item">
              <div class="component-meta">
                <span class="component-name">${parsedName.name}</span>
                <span class="badge badge-component">Component</span>
                ${
                  parsedName.type
                    ? `<span class="badge badge-type">${parsedName.type}</span>`
                    : ""
                }
                ${
                  parsedName.state
                    ? `<span class="badge badge-state">${parsedName.state}</span>`
                    : ""
                }
              </div>
              <div class="component-styles" onclick="toggleStyles(this)">
                ${formatStyles(component.styles)}
                <button class="close-button" onclick="event.stopPropagation(); toggleStyles(this.parentElement)">Close</button>
              </div>
              <div class="action-buttons">
                <button class="generate-test-button" onclick="generateTest('${component.id}', '${component.name}', this)">Generate Test</button>
              </div>
              <div class="test-success-message">Test generated successfully!</div>
            </div>
          `;
          }
        });

        html += `</div>`;

        container.innerHTML = html;

        // Add toggle functions to the global scope
        window.toggleComponentSet = function (index) {
          const headerEl = document.querySelector(
            `.component-set-header[data-index="${index}"]`
          );
          const childrenEl = document.getElementById(`children-${index}`);

          if (childrenEl.classList.contains("expanded")) {
            childrenEl.classList.remove("expanded");
            headerEl.classList.remove("expanded");
            headerEl.querySelector(".component-set-toggle").textContent = "+";
          } else {
            childrenEl.classList.add("expanded");
            headerEl.classList.add("expanded");
            headerEl.querySelector(".component-set-toggle").textContent = "â€º";
          }
        };

        window.toggleStyles = function (element) {
          element.classList.toggle("expanded");
          
          // If we're expanding, scroll the element into view
          if (element.classList.contains("expanded")) {
            setTimeout(() => {
              element.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
          }
        };
      }

      // Function to trigger CSS download
      function downloadCSS(cssString) {
        const blob = new Blob([cssString], { type: "text/css" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "figma-variables.css";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Add event listener for the export button
      document
        .getElementById("export-css-button")
        .addEventListener("click", () => {
          // Send message to plugin code to request CSS export
          parent.postMessage({ pluginMessage: { type: "export-css" } }, "*");
        });

      // Function to generate test for a component
      function generateTest(componentId, componentName, button, generateAllVariants = false) {
        // Show loading state
        button.classList.add('loading');
        const originalText = button.textContent;
        button.textContent = 'Generating...';
        button.disabled = true;

        // Hide any previous success messages
        const successMessage = button.parentElement.nextElementSibling;
        if (successMessage && successMessage.classList.contains('test-success-message')) {
          successMessage.style.display = 'none';
        }

        // Send message to plugin code to request test generation
        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-test",
              componentId: componentId,
              componentName: componentName,
              generateAllVariants: generateAllVariants
            },
          },
          "*"
        );

        // Store original button text for restoring later
        button.dataset.originalText = originalText;
      }

      // Function to trigger ZIP download
      function downloadComponentsZip(files, language) {
        if (!files || files.length === 0) {
          alert("No components available to export");
          return;
        }

        // Create a new JSZip instance (needs to be added in the head section)
        const zip = new JSZip();

        // Add files to the ZIP based on the selected language
        files.forEach((component) => {
          const folderName = component.kebabName;
          const folder = zip.folder(folderName);

          if (language === "angular") {
            // Add all Angular component files
            folder.file(`${folderName}.component.html`, component.angularHtml);
            folder.file(`${folderName}.component.ts`, component.angularTs);
            folder.file(
              `${folderName}.component.scss`,
              `// Styles for ${component.name}\n.${folderName} {\n  // Add your styles here\n}`
            );
          } else if (language === "typescript") {
            // Add only TypeScript file
            folder.file(`${folderName}.component.ts`, component.angularTs);
          } else if (language === "javascript") {
            // Convert TypeScript to JavaScript (basic conversion)
            const jsCode = component.angularTs
              .replace(/: [A-Za-z<>[\]]+/g, "") // Remove type annotations
              .replace(/interface [^}]+}/g, ""); // Remove interfaces

            folder.file(`${folderName}.component.js`, jsCode);
          }
        });

        // Generate and download the ZIP
        zip.generateAsync({ type: "blob" }).then((content) => {
          const url = URL.createObjectURL(content);
          const a = document.createElement("a");
          a.href = url;
          a.download = `figma-components-${language}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      // Function to download a generated test
      function downloadTest(componentName, testContent) {
        // Create a kebab case version of the component name for the file name
        const kebabName = componentName
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
        
        const blob = new Blob([testContent], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${kebabName}.component.spec.ts`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Search functionality
      document
        .getElementById("variable-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          const filteredData = variablesData
            .map((collection) => {
              return {
                ...collection,
                variables: collection.variables.filter((variable) =>
                  variable.name.toLowerCase().includes(searchTerm)
                ),
              };
            })
            .filter((collection) => collection.variables.length > 0);

          renderVariables(filteredData);
        });

      document
        .getElementById("component-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          // Search in both component name and children names
          const filteredData = componentsData.filter(
            (component) =>
              component.name.toLowerCase().includes(searchTerm) ||
              (component.children &&
                component.children.some((child) =>
                  child.name.toLowerCase().includes(searchTerm)
                ))
          );

          renderComponents(filteredData);
        });

      // Function to open the GitLab modal
      function openGitLabModal() {
        document.getElementById("gitlab-modal").style.display = "block";
      }

      // Function to close the GitLab modal
      function closeGitLabModal() {
        document.getElementById("gitlab-modal").style.display = "none";
        resetCommitButton();
      }

      // Function to reset the commit button state
      function resetCommitButton() {
        const button = document.getElementById("commit-submit-button");
        button.classList.remove("loading");
        button.textContent = "Commit";
        button.disabled = false;
      }

      // Function to commit to GitLab
      function commitToGitLab() {
        const button = document.getElementById("commit-submit-button");
        button.classList.add("loading");
        button.textContent = "Committing...";
        button.disabled = true;

        const projectId = document.getElementById("gitlab-project-id").value.trim();
        const gitlabToken = document.getElementById("gitlab-token").value.trim();
        const commitMessage = document.getElementById("commit-message").value.trim();
        const filePath = document.getElementById("file-path").value.trim() || "variables.css";

        if (!projectId || !gitlabToken || !commitMessage) {
          alert("Please fill in all required fields");
          resetCommitButton();
          return;
        }

        // Send message to plugin code to request commit
        parent.postMessage(
          {
            pluginMessage: {
              type: "commit-to-gitlab",
              projectId,
              gitlabToken,
              commitMessage,
              filePath,
              cssData: currentCSSData
            },
          },
          "*"
        );
      }

      // Add event listener for the commit button
      document
        .getElementById("commit-repo-button")
        .addEventListener("click", openGitLabModal);
    </script>
  </body>
</html>
