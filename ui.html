<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>aWall Synch UI</title>
    <!-- Add JSZip library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 20px;
        color: #333;
        background-color: #f7f8fa;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .section {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        background-color: #fff;
      }
      h2 {
        margin-top: 0;
        color: #333;
        font-size: 20px;
        font-weight: 600;
      }
      h3 {
        margin-top: 16px;
        margin-bottom: 8px;
        color: #555;
        font-size: 16px;
        font-weight: 500;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 16px;
        background-color: #fff;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab {
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .tab:hover {
        background-color: #f0f7ff;
      }
      .tab.active {
        border-bottom: 2px solid #0d99ff;
        color: #0d99ff;
        background-color: #f0f7ff;
      }
      .tab-content {
        display: none;
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .tab-content.active {
        display: block;
      }
      .variable-collection {
        margin-bottom: 24px;
        background: #f9f9f9;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #eaeaea;
      }
      .collection-name {
        font-weight: 600;
        margin-bottom: 12px;
        color: #444;
        font-size: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        background-color: #fff;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      th {
        text-align: left;
        background-color: #f3f4f6;
        padding: 10px 12px;
        font-weight: 500;
        color: #444;
        border-bottom: 1px solid #e5e7eb;
      }
      td {
        padding: 10px 12px;
        border-top: 1px solid #eee;
        vertical-align: top;
      }
      tr:hover td {
        background-color: #f9fafb;
      }
      .color-preview {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .search-container {
        margin-bottom: 16px;
      }
      .search-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .search-input:focus {
        border-color: #0d99ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.15);
      }
      .component-list {
        max-height: 700px;
        overflow-y: auto;
        border-radius: 6px;
        background-color: #fff;
        border: 1px solid #eaeaea;
      }
      .component-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .component-item:hover {
        background-color: #f5f5f5;
      }
      .no-items {
        color: #999;
        font-style: italic;
        padding: 24px;
        text-align: center;
        background-color: #f9f9f9;
        border-radius: 6px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #777;
        background-color: #f9f9f9;
        border-radius: 6px;
      }
      .loading:after {
        content: "...";
        animation: dots 1.5s steps(5, end) infinite;
      }
      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }
      /* Component hierarchy styling */
      .component-set {
        background-color: #f8f9fa;
        margin-bottom: 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .component-set-header {
        cursor: pointer;
        padding: 12px;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
      }
      .component-set-header:hover {
        background-color: #edf2f7;
      }
      .component-set-toggle {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #0d99ff;
        background-color: #e1f0ff;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .component-set-header.expanded .component-set-toggle {
        transform: rotate(90deg);
      }
      .component-set-children {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .component-set-children.expanded {
        max-height: 1000px;
      }
      .child-component {
        border-left: 3px solid #0d99ff;
        margin: 0 0 0 20px;
        background-color: #fafbfc;
      }
      .child-component table {
        box-shadow: none;
        border-radius: 0;
      }
      /* Type and state badges */
      .badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        margin-right: 8px;
      }
      .badge-component {
        background-color: #e1f0ff;
        color: #0d99ff;
      }
      .badge-component-set {
        background-color: #c9f7f0;
        color: #0a9882;
      }
      .badge-state {
        background-color: #f0e6ff;
        color: #7e3ff2;
      }
      .badge-type {
        background-color: #fff2e0;
        color: #ff8c00;
      }
      /* Component info layout */
      .component-name {
        font-weight: 500;
        margin-right: 10px;
      }
      .component-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
      }
      .component-styles {
        margin-top: 8px;
        padding: 8px;
        background-color: #f5f7f9;
        border-radius: 4px;
        font-size: 12px;
        color: #555;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        cursor: pointer;
      }
      .component-styles.expanded {
        white-space: pre-wrap;
        overflow: auto;
        max-height: 200px;
      }
      /* Button styling */
      button {
        padding: 10px 16px;
        background-color: #0d99ff;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #0a85e9;
      }
      button:disabled {
        background-color: #c8d3dc;
        cursor: not-allowed;
      }
      select {
        padding: 9px 12px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        background-color: white;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>aWall Synch</h2>

      <div class="tabs">
        <div class="tab active" data-tab="variables">Variables</div>
        <div class="tab" data-tab="components">Components</div>
      </div>

      <div class="tab-content active" id="variables-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="variable-search"
            placeholder="Search variables..."
          />
        </div>
        <button id="export-css-button" style="margin-bottom: 16px" disabled>
          Export Variables as CSS
        </button>
        <div id="variables-container">
          <div class="loading">Loading variables</div>
        </div>
      </div>

      <div class="tab-content" id="components-content">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            id="component-search"
            placeholder="Search components..."
          />
        </div>

        <!-- Add export controls -->
        <div
          style="
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
          "
        >
          <select
            id="language-select"
            style="
              padding: 9px 12px;
              border-radius: 4px;
              border: 1px solid #e0e0e0;
            "
          >
            <option value="angular">Angular</option>
            <option value="typescript">TypeScript</option>
            <option value="javascript">JavaScript</option>
          </select>
          <button id="export-angular-button">Export Components</button>
        </div>

        <div id="components-container">
          <div class="loading">Loading components</div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          tab.classList.add("active");
          document
            .getElementById(tab.dataset.tab + "-content")
            .classList.add("active");
        });
      });

      // Store data
      let variablesData = [];
      let componentsData = [];

      // Listen for messages from the plugin
      window.onmessage = (event) => {
        const message = event.data.pluginMessage;
        const exportButton = document.getElementById("export-css-button");

        if (message.type === "document-data") {
          variablesData = message.variablesData;
          componentsData = message.componentsData;

          renderVariables(variablesData);
          renderComponents(componentsData);

          // Enable the export button only if there are variables
          if (
            variablesData &&
            variablesData.some((collection) => collection.variables.length > 0)
          ) {
            exportButton.disabled = false;
          } else {
            exportButton.disabled = true;
          }

          // Enable/disable the Angular export button based on components
          const exportAngularButton = document.getElementById(
            "export-angular-button"
          );
          if (componentsData && componentsData.length > 0) {
            exportAngularButton.disabled = false;
          } else {
            exportAngularButton.disabled = true;
          }
        } else if (message.type === "css-export") {
          // Trigger download when CSS data is received
          downloadCSS(message.cssData);
        } else if (message.type === "angular-export-data") {
          // Trigger ZIP download with component data based on selected language
          const language = message.language || "angular";
          downloadComponentsZip(message.files, language);
        } else if (message.type === "error") {
          // Optionally display errors from the plugin code
          console.error("Plugin Error:", message.message);
          alert(`Error: ${message.message}`); // Simple alert for user feedback
          exportButton.disabled = true; // Disable button on error
        }
      };

      // Render variables
      function renderVariables(data) {
        const container = document.getElementById("variables-container");

        if (data.length === 0) {
          container.innerHTML =
            '<div class="no-items">No variables found in this document.</div>';
          return;
        }

        let html = "";

        data.forEach((collection) => {
          html += `
          <div class="variable-collection">
            <div class="collection-name">${collection.name}</div>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Values</th>
                </tr>
              </thead>
              <tbody>
        `;

          if (collection.variables.length === 0) {
            html += `<tr><td colspan="3">No variables in this collection</td></tr>`;
          } else {
            collection.variables.forEach((variable) => {
              html += `
              <tr>
                <td>${variable.name}</td>
                <td>${variable.resolvedType}</td>
                <td>
            `;

              variable.valuesByMode.forEach((mode) => {
                const value = mode.value;

                // Display color values with a preview
                if (
                  variable.resolvedType === "COLOR" &&
                  typeof value === "object" &&
                  value.r !== undefined
                ) {
                  const r = Math.round(value.r * 255);
                  const g = Math.round(value.g * 255);
                  const b = Math.round(value.b * 255);
                  const a = value.a !== undefined ? value.a : 1;

                  html += `
                  <div>
                    <span class="color-preview" style="background-color: rgba(${r},${g},${b},${a})"></span>
                    ${mode.modeName}: rgba(${r},${g},${b},${a})
                  </div>
                `;
                } else {
                  html += `<div>${mode.modeName}: ${JSON.stringify(
                    value
                  )}</div>`;
                }
              });

              html += `
                </td>
              </tr>
            `;
            });
          }

          html += `
              </tbody>
            </table>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      // Extract component type and state from name
      function parseComponentName(name) {
        const result = {
          name: name,
          type: null,
          state: null,
        };

        // Check for Type=X pattern
        const typeMatch = name.match(/Type=([^,]+)/i);
        if (typeMatch && typeMatch[1]) {
          result.type = typeMatch[1].trim();
        }

        // Check for State=X pattern
        const stateMatch = name.match(/State=([^,]+)/i);
        if (stateMatch && stateMatch[1]) {
          result.state = stateMatch[1].trim();
        }

        return result;
      }

      // Format component styles for readability
      function formatStyles(styles) {
        if (!styles) return "";

        // Try to parse and format the JSON
        try {
          if (typeof styles === "string") {
            styles = JSON.parse(styles);
          }

          const styleStr = JSON.stringify(styles, null, 2);
          return styleStr.length > 100
            ? styleStr.substring(0, 100) + "..."
            : styleStr;
        } catch (e) {
          return String(styles);
        }
      }

      // Render components in hierarchical view
      function renderComponents(data) {
        const container = document.getElementById("components-container");

        if (data.length === 0) {
          container.innerHTML =
            '<div class="no-items">No components found in this document.</div>';
          return;
        }

        let html = `<div class="component-list">`;

        // Render each component with hierarchy
        data.forEach((component, index) => {
          if (component.type === "COMPONENT_SET") {
            // Parse the component set name to extract type information
            const parsedName = parseComponentName(component.name);

            // For component sets, create an expandable section
            html += `
            <div class="component-set">
              <div class="component-set-header" data-index="${index}" onclick="toggleComponentSet(${index})">
                <div class="component-set-toggle">+</div>
                <div class="component-meta">
                  <span class="component-name">${parsedName.name}</span>
                  <span class="badge badge-component-set">Component Set</span>
                  ${
                    parsedName.type
                      ? `<span class="badge badge-type">${parsedName.type}</span>`
                      : ""
                  }
                </div>
              </div>
              <div class="component-set-children" id="children-${index}">
            `;

            // Render child components
            if (component.children && component.children.length > 0) {
              component.children.forEach((child) => {
                // Parse the child component name to extract type and state
                const childParsed = parseComponentName(child.name);

                html += `
                <div class="child-component">
                  <table style="width: 100%;">
                    <tbody>
                      <tr>
                        <td>
                          <div class="component-meta">
                            <span class="component-name">${
                              childParsed.name
                            }</span>
                            <span class="badge badge-component">Component</span>
                            ${
                              childParsed.type
                                ? `<span class="badge badge-type">${childParsed.type}</span>`
                                : ""
                            }
                            ${
                              childParsed.state
                                ? `<span class="badge badge-state">${childParsed.state}</span>`
                                : ""
                            }
                          </div>
                          <div class="component-styles" onclick="toggleStyles(this)">${formatStyles(
                            child.styles
                          )}</div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              `;
              });
            } else {
              html += `<div class="child-component"><div class="no-items">No child components</div></div>`;
            }

            html += `
                </div>
              </div>
            `;
          } else {
            // Parse the standalone component name
            const parsedName = parseComponentName(component.name);

            // For regular components, render normally
            html += `
            <div class="component-item">
              <div class="component-meta">
                <span class="component-name">${parsedName.name}</span>
                <span class="badge badge-component">Component</span>
                ${
                  parsedName.type
                    ? `<span class="badge badge-type">${parsedName.type}</span>`
                    : ""
                }
                ${
                  parsedName.state
                    ? `<span class="badge badge-state">${parsedName.state}</span>`
                    : ""
                }
              </div>
              <div class="component-styles" onclick="toggleStyles(this)">${formatStyles(
                component.styles
              )}</div>
            </div>
          `;
          }
        });

        html += `</div>`;

        container.innerHTML = html;

        // Add toggle functions to the global scope
        window.toggleComponentSet = function (index) {
          const headerEl = document.querySelector(
            `.component-set-header[data-index="${index}"]`
          );
          const childrenEl = document.getElementById(`children-${index}`);

          if (childrenEl.classList.contains("expanded")) {
            childrenEl.classList.remove("expanded");
            headerEl.classList.remove("expanded");
            headerEl.querySelector(".component-set-toggle").textContent = "+";
          } else {
            childrenEl.classList.add("expanded");
            headerEl.classList.add("expanded");
            headerEl.querySelector(".component-set-toggle").textContent = "â€º";
          }
        };

        window.toggleStyles = function (element) {
          element.classList.toggle("expanded");
        };
      }

      // Function to trigger CSS download
      function downloadCSS(cssString) {
        const blob = new Blob([cssString], { type: "text/css" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "figma-variables.css";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Add event listener for the export button
      document
        .getElementById("export-css-button")
        .addEventListener("click", () => {
          // Send message to plugin code to request CSS export
          parent.postMessage({ pluginMessage: { type: "export-css" } }, "*");
        });

      // Add event listener for the Angular export button
      document
        .getElementById("export-angular-button")
        .addEventListener("click", () => {
          const selectedLanguage =
            document.getElementById("language-select").value;
          // Send message to plugin code to request Angular export with selected language
          parent.postMessage(
            {
              pluginMessage: {
                type: "export-angular",
                language: selectedLanguage,
              },
            },
            "*"
          );
        });

      // Function to trigger ZIP download
      function downloadComponentsZip(files, language) {
        if (!files || files.length === 0) {
          alert("No components available to export");
          return;
        }

        // Create a new JSZip instance (needs to be added in the head section)
        const zip = new JSZip();

        // Add files to the ZIP based on the selected language
        files.forEach((component) => {
          const folderName = component.kebabName;
          const folder = zip.folder(folderName);

          if (language === "angular") {
            // Add all Angular component files
            folder.file(`${folderName}.component.html`, component.angularHtml);
            folder.file(`${folderName}.component.ts`, component.angularTs);
            folder.file(
              `${folderName}.component.scss`,
              `// Styles for ${component.name}\n.${folderName} {\n  // Add your styles here\n}`
            );
          } else if (language === "typescript") {
            // Add only TypeScript file
            folder.file(`${folderName}.component.ts`, component.angularTs);
          } else if (language === "javascript") {
            // Convert TypeScript to JavaScript (basic conversion)
            const jsCode = component.angularTs
              .replace(/: [A-Za-z<>[\]]+/g, "") // Remove type annotations
              .replace(/interface [^}]+}/g, ""); // Remove interfaces

            folder.file(`${folderName}.component.js`, jsCode);
          }
        });

        // Generate and download the ZIP
        zip.generateAsync({ type: "blob" }).then((content) => {
          const url = URL.createObjectURL(content);
          const a = document.createElement("a");
          a.href = url;
          a.download = `figma-components-${language}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      // Search functionality
      document
        .getElementById("variable-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          const filteredData = variablesData
            .map((collection) => {
              return {
                ...collection,
                variables: collection.variables.filter((variable) =>
                  variable.name.toLowerCase().includes(searchTerm)
                ),
              };
            })
            .filter((collection) => collection.variables.length > 0);

          renderVariables(filteredData);
        });

      document
        .getElementById("component-search")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();

          // Search in both component name and children names
          const filteredData = componentsData.filter(
            (component) =>
              component.name.toLowerCase().includes(searchTerm) ||
              (component.children &&
                component.children.some((child) =>
                  child.name.toLowerCase().includes(searchTerm)
                ))
          );

          renderComponents(filteredData);
        });
    </script>
  </body>
</html>
